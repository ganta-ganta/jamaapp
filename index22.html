<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jama - Enhanced Agricultural Management System</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2300acc1'><path d='M17 8C8 10 5.9 16.17 3.82 21.34l1.06.66C6.16 17.85 7.84 14.25 11 13.56c2.62-.57 5.54-1.5 7.5-3.56l1.5 1.5V8h-3z'/></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, RecaptchaVerifier, signInWithPhoneNumber, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, deleteDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        // Firebase configuration
         const firebaseConfig = {

    apiKey: "AIzaSyCdfgtj1gvZ-bkomW1V40h-4tyUPHy_peo",

    authDomain: "jama-3f427.firebaseapp.com",

    projectId: "jama-3f427",

    storageBucket: "jama-3f427.firebasestorage.app",

    messagingSenderId: "897112470741",

    appId: "1:897112470741:web:ee6388f0faae459fcb1e5c",

    measurementId: "G-NN1BRV0QKS"

  };
        
        // Initialize Firebase
        window.firebaseApp = initializeApp(firebaseConfig);
        window.auth = getAuth(window.firebaseApp);
        window.db = getFirestore(window.firebaseApp);
        window.storage = getStorage(window.firebaseApp);
        
        // Export Firebase functions for global use
        window.firebaseAuth = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            RecaptchaVerifier,
            signInWithPhoneNumber,
            signOut,
            onAuthStateChanged
        };
        
        window.firebaseDb = {
            doc,
            setDoc,
            getDoc,
            collection,
            addDoc,
            query,
            where,
            getDocs,
            updateDoc,
            deleteDoc,
            onSnapshot
        };
        
        window.firebaseStorage = {
            ref,
            uploadBytes,
            getDownloadURL
        };
        
        // Initialize authentication listener
        onAuthStateChanged(window.auth, (user) => {
            if (window.authStateHandler) {
                window.authStateHandler(user);
            }
        });
    </script>
    
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ffa000;
            --secondary-light: #ffc107;
            --secondary-dark: #ff6f00;
            --accent: #00acc1;
            --text-light: #f5f5f5;
            --text-dark: #333;
            --bg-light: #f8f9fa;
            --bg-dark: #1a1a1a;
            --card-dark: #2d2d2d;
            --success: #388e3c;
            --warning: #f57c00;
            --danger: #d32f2f;
            --info: #1976d2;
            --gray: #78909c;
            --border-radius: 12px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --box-shadow-dark: 0 4px 12px rgba(0, 0, 0, 0.3);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --text-dark: #f5f5f5;
            --bg-light: var(--bg-dark);
            --box-shadow: var(--box-shadow-dark);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            transition: var(--transition);
        }

        .app-container {
            width: 100%;
            max-width: 100vw;
            background: var(--bg-light);
            min-height: 100vh;
            position: relative;
            transition: var(--transition);
        }

        /* Enhanced PWA styles */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 25px;
            display: none;
            align-items: center;
            gap: 1rem;
            box-shadow: var(--box-shadow);
            z-index: 1001;
            animation: slideUpBounce 0.5s ease-out;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .install-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        @keyframes slideUpBounce {
            0% {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            60% {
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Enhanced Location Permission Modal */
        .location-permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .location-permission-modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
        }

        .permission-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        [data-theme="dark"] .permission-card {
            background: var(--card-dark);
        }

        .permission-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            font-size: 2rem;
            color: white;
        }

        .permission-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: var(--primary-dark);
        }

        [data-theme="dark"] .permission-title {
            color: var(--primary-light);
        }

        .permission-description {
            color: var(--gray);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .permission-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .permission-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            min-width: 120px;
        }

        .permission-btn.allow {
            background: var(--primary);
            color: white;
        }

        .permission-btn.allow:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .permission-btn.deny {
            background: var(--gray);
            color: white;
        }

        .permission-btn.deny:hover {
            background: #666;
        }

        /* Enhanced Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            width: 100%;
            pointer-events: none;
        }

        .notification {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--info);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(100%);
            opacity: 0;
            pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        [data-theme="dark"] .notification {
            background: var(--card-dark);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left-color: var(--success);
        }

        .notification.warning {
            border-left-color: var(--warning);
        }

        .notification.error {
            border-left-color: var(--danger);
        }

        .notification.info {
            border-left-color: var(--info);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            background: rgba(25, 118, 210, 0.1);
            color: var(--info);
        }

        .notification.success .notification-icon {
            background: rgba(56, 142, 60, 0.1);
            color: var(--success);
        }

        .notification.warning .notification-icon {
            background: rgba(245, 124, 0, 0.1);
            color: var(--warning);
        }

        .notification.error .notification-icon {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
            color: var(--text-dark);
        }

        .notification-text {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: var(--transition);
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .logo-animation {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: spin 2s linear infinite;
        }

        .app-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .app-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .loading-progress {
            width: 0%;
            height: 100%;
            background: white;
            border-radius: 2px;
            animation: loadingProgress 2s ease-in-out forwards;
        }

        .loading-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes loadingProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .logo h1 {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-btn, .theme-language-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
        }

        .header-btn:hover, .theme-language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Enhanced Weather Card */
        .weather-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            margin-bottom: 1rem;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .weather-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .weather-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .weather-location {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .weather-icon {
            font-size: 3rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .weather-temp {
            font-size: 2.5rem;
            font-weight: 700;
        }

        .weather-description {
            font-size: 1rem;
            text-transform: capitalize;
            margin-bottom: 0.5rem;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 2;
        }

        .weather-detail {
            text-align: center;
        }

        .weather-detail-label {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 0.2rem;
        }

        .weather-detail-value {
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Weather Prediction Card */
        .weather-prediction {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .prediction-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
        }

        .forecast-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .forecast-day {
            font-size: 0.7rem;
            margin-bottom: 0.3rem;
            opacity: 0.8;
        }

        .forecast-icon {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }

        .forecast-temp {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .forecast-rain {
            font-size: 0.7rem;
            margin-top: 0.2rem;
            opacity: 0.9;
        }

        /* Enhanced Weather Alert */
        .weather-alert {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
            animation: pulseAlert 2s infinite;
        }

        .weather-alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .weather-alert.warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
        }

        .weather-alert.info {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
        }

        @keyframes pulseAlert {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .alert-icon {
            font-size: 1.5rem;
            z-index: 2;
        }

        .alert-content {
            z-index: 2;
        }

        .alert-content h4 {
            margin-bottom: 0.3rem;
            font-size: 1rem;
        }

        .alert-content p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        /* Content */
        .content-container {
            padding: 1rem;
            padding-bottom: 80px;
            min-height: calc(100vh - 60px);
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Authentication */
        .auth-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-header .logo {
            justify-content: center;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .auth-subtitle {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .location-detector {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary);
        }

        .location-detector button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto;
            transition: var(--transition);
        }

        .location-detector button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .location-status {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--gray);
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .auth-tab {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 0.9rem;
            background: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        [data-theme="dark"] .auth-tab {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        .auth-tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .google-auth {
            text-align: center;
            padding: 2rem 0;
        }

        .google-icon {
            margin-bottom: 1rem;
        }

        /* Enhanced OTP Inputs */
        .otp-inputs {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .otp-input {
            width: 45px !important;
            height: 45px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: 600;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            transition: var(--transition);
        }

        .otp-input:focus {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        .otp-instruction {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--gray);
        }

        .countdown {
            text-align: center;
            margin: 1rem 0;
            font-weight: 600;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-dark);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .form-group label {
            color: var(--primary-light);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        [data-theme="dark"] .form-control {
            background: var(--card-dark);
            border-color: #444;
            color: var(--text-dark);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.15);
            transform: translateY(-1px);
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .country-code {
            max-width: 80px;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-google {
            background: #4285f4;
            color: white;
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover:not(:disabled) {
            background-color: var(--primary);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        /* Enhanced Messages */
        .message {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            margin: 0.5rem;
            text-align: center;
            font-weight: 500;
            display: none;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .message::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 2s infinite;
        }

        .error-message {
            background: #ffebee;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: #e8f5e9;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .warning-message {
            background: #fff3e0;
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.2rem;
            margin-bottom: 1rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .dashboard-card {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, rgba(46, 125, 50, 0.1), transparent);
            pointer-events: none;
        }

        .dashboard-card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .dashboard-card h3 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-dark);
            position: relative;
            z-index: 2;
        }

        [data-theme="dark"] .dashboard-card h3 {
            color: var(--primary-light);
        }

        /* Financial Summary */
        .financial-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .financial-summary-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.2rem;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .financial-summary-card {
            background: var(--card-dark);
        }

        .financial-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .financial-summary-card.income::before {
            background: var(--success);
        }

        .financial-summary-card.expense::before {
            background: var(--danger);
        }

        .financial-summary-card.profit::before {
            background: var(--secondary);
        }

        .financial-summary-card.loan::before {
            background: var(--info);
        }

        .financial-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .card-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0.5rem 0;
            color: var(--text-dark);
        }

        .card-label {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 500;
        }

        /* Quick Links */
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .quick-link {
            background: white;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            cursor: pointer;
            text-decoration: none;
            color: var(--text-dark);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .quick-link {
            background: var(--card-dark);
        }

        .quick-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .quick-link:hover::before {
            opacity: 1;
        }

        .quick-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .quick-link-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .quick-link-icon.crop { color: var(--success); }
        .quick-link-icon.money { color: var(--secondary); }
        .quick-link-icon.asset { color: var(--info); }
        .quick-link-icon.weather { color: #42a5f5; }

        .quick-link-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Enhanced Calendar */
        .enhanced-calendar {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        [data-theme="dark"] .enhanced-calendar {
            background: var(--card-dark);
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--primary);
            color: white;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: var(--transition);
        }

        .calendar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .calendar-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .auto-year-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .auto-year-toggle.active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tab system fixes */
        .tab-navigation {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            overflow-x: auto;
            box-shadow: var(--box-shadow);
        }

        [data-theme="dark"] .tab-navigation {
            background: var(--card-dark);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-weight: 600;
            font-size: 0.85rem;
            background: transparent;
            border: none;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 100px;
            white-space: nowrap;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block !important;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Mobile Navigation */
        .mobile-bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 8px 4px;
            z-index: 1000;
        }

        [data-theme="dark"] .mobile-bottom-nav {
            background: var(--card-dark);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.7rem;
            transition: var(--transition);
            padding: 6px 8px;
            border-radius: 8px;
            min-width: 50px;
            position: relative;
            background: none;
            border: none;
            cursor: pointer;
        }

        .mobile-nav-item.active {
            color: var(--primary);
            background: rgba(46, 125, 50, 0.1);
        }

        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 2px;
        }

        .notification-dot {
            position: absolute;
            top: 2px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Floating Action Button */
        .floating-action-button {
            position: fixed;
            bottom: 90px;
            right: 15px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 16px rgba(255, 160, 0, 0.3);
            z-index: 1000;
            cursor: pointer;
            transition: var(--transition);
            border: none;
        }

        .floating-action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 160, 0, 0.4);
        }

        .floating-action-button.hidden {
            display: none;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideUp 0.3s ease-out;
        }

        [data-theme="dark"] .modal-content {
            background: var(--card-dark);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f0f0;
        }

        [data-theme="dark"] .modal-header {
            border-bottom-color: #444;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
            padding: 4px;
            border-radius: 50%;
        }

        .modal-close:hover {
            color: var(--danger);
            background: rgba(211, 47, 47, 0.1);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .content-container {
                padding: 0.5rem;
                padding-bottom: 80px;
            }
            
            .financial-summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.8rem;
            }
            
            .quick-links {
                grid-template-columns: repeat(4, 1fr);
                gap: 0.5rem;
            }

            .modal-content {
                width: 98%;
                padding: 1rem;
                margin: 1rem;
            }

            .weather-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .forecast-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        .invisible {
            opacity: 0;
            pointer-events: none;
        }

        /* Enhanced crop cards and other components */
        .crop-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .crop-card {
            background: var(--card-dark);
        }

        .crop-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.05), transparent);
            border-radius: 0 0 0 100px;
            pointer-events: none;
        }

        .crop-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Additional styles for enhanced functionality */
        .selectable-item {
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: white;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .selectable-item {
            background: var(--card-dark);
            border-color: #444;
        }

        .selectable-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .selectable-item:hover::before {
            opacity: 1;
        }

        .selectable-item:hover {
            border-color: var(--primary);
            transform: scale(1.02);
        }

        .selectable-item.selected {
            border-color: var(--primary);
            background: rgba(46, 125, 50, 0.1);
        }

        .selectable-item.selected::before {
            opacity: 1;
        }

        /* Empty states */
        .empty-state {
            text-align: center;
            color: var(--gray);
            padding: 3rem 1rem;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }
    </style>
</head>
<body data-theme="light">
    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div>
            <i class="fas fa-download"></i>
            <span>Install Jama App for better experience!</span>
        </div>
        <button class="install-btn" id="installBtn">Install</button>
        <button class="install-btn" id="dismissInstall">Ã—</button>
    </div>

    <!-- Enhanced Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Enhanced Location Permission Modal -->
    <div class="location-permission-modal" id="locationPermissionModal">
        <div class="permission-card">
            <div class="permission-icon">
                <i class="fas fa-map-marker-alt"></i>
            </div>
            <h3 class="permission-title">Allow Location Access</h3>
            <p class="permission-description">
                Jama needs access to your location to provide accurate weather information and location-based farming suggestions for your area.
            </p>
            <div class="permission-buttons">
                <button class="permission-btn allow" id="allowLocationBtn">
                    <i class="fas fa-check"></i> Allow
                </button>
                <button class="permission-btn deny" id="denyLocationBtn">
                    <i class="fas fa-times"></i> Deny
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="logo-animation">
            <i class="fas fa-leaf"></i>
        </div>
        <h1 class="app-title">Jama</h1>
        <p class="app-subtitle" data-translate="Agricultural Management System">Agricultural Management System</p>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
        <p class="loading-text" data-translate="Loading your farm data...">Loading your farm data...</p>
    </div>

    <div class="app-container">
        <!-- Header -->
        <div class="header" id="appHeader" style="display: none;">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                    <h1>Jama</h1>
                </div>
                <div class="header-actions">
                    <button class="theme-language-btn" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="theme-language-btn" id="languageToggle" title="Change Language">
                        <i class="fas fa-globe"></i>
                        <span id="currentLanguage">EN</span>
                    </button>
                    <button class="theme-language-btn" id="syncBtn" title="Sync Data">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div class="error-message message" id="errorMessage"></div>
        <div class="success-message message" id="successMessage"></div>
        <div class="warning-message message" id="warningMessage"></div>

        <!-- Authentication Page -->
        <div id="authPage" class="content-container">
            <div class="auth-container">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-leaf"></i>
                        <h1>Jama</h1>
                    </div>
                    <p class="auth-subtitle" data-translate="Agricultural Management System">Agricultural Management System</p>
                </div>

                <!-- Enhanced Location Detector -->
                <div class="location-detector">
                    <button id="detectLocationBtn">
                        <i class="fas fa-map-marker-alt"></i>
                        <span data-translate="Detect Location">Detect Location</span>
                    </button>
                    <div class="location-status" id="locationStatus">
                        <span data-translate="Click to auto-detect your farm location">Click to auto-detect your farm location</span>
                    </div>
                </div>

                <div class="auth-tabs">
                    <button class="auth-tab active" data-auth="email">
                        <i class="fas fa-envelope"></i>
                        <span data-translate="Email">Email</span>
                    </button>
                    <button class="auth-tab" data-auth="phone">
                        <i class="fas fa-mobile-alt"></i>
                        <span data-translate="Phone">Phone</span>
                    </button>
                    <button class="auth-tab" data-auth="google">
                        <i class="fab fa-google"></i>
                        <span data-translate="Google">Google</span>
                    </button>
                </div>

                <!-- Email Authentication -->
                <div class="auth-form active" id="emailAuth">
                    <div class="form-group">
                        <label for="email">
                            <i class="fas fa-envelope"></i>
                            <span data-translate="Email">Email</span>
                        </label>
                        <input type="email" class="form-control" id="email" placeholder="farmer@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            <span data-translate="Password">Password</span>
                        </label>
                        <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                    </div>
                    <button class="btn btn-primary btn-full" id="emailLoginBtn">
                        <i class="fas fa-sign-in-alt"></i>
                        <span data-translate="Login">Login</span>
                    </button>
                    <button class="btn btn-outline btn-full" id="emailRegisterBtn" style="margin-top: 0.5rem;">
                        <i class="fas fa-user-plus"></i>
                        <span data-translate="Register">Register</span>
                    </button>
                </div>

                <!-- Phone Authentication -->
                <div class="auth-form" id="phoneAuth">
                    <div class="form-group">
                        <label for="phoneNumber">
                            <i class="fas fa-mobile-alt"></i>
                            <span data-translate="Phone Number">Phone Number</span>
                        </label>
                        <div class="input-group">
                            <select class="form-control country-code" id="countryCode">
                                <option value="+91">ðŸ‡®ðŸ‡³ +91</option>
                                <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                                <option value="+44">ðŸ‡¬ðŸ‡§ +44</option>
                            </select>
                            <input type="tel" class="form-control" id="phoneNumber" placeholder="9876543210" inputmode="numeric" required>
                        </div>
                    </div>
                    <div class="recaptcha-container" id="recaptcha-container"></div>
                    <button class="btn btn-primary btn-full" id="sendOtpBtn">
                        <i class="fas fa-paper-plane"></i>
                        <span data-translate="Send OTP">Send OTP</span>
                    </button>
                </div>

                <!-- Google Authentication -->
                <div class="auth-form" id="googleAuth">
                    <div class="google-auth">
                        <div class="google-icon">
                            <i class="fab fa-google" style="font-size: 3rem; color: #4285f4;"></i>
                        </div>
                        <p data-translate="Sign in with your Google account">Sign in with your Google account</p>
                        <button class="btn btn-google btn-full" id="googleSignInBtn">
                            <i class="fab fa-google"></i>
                            <span data-translate="Continue with Google">Continue with Google</span>
                        </button>
                    </div>
                </div>

                <!-- OTP Verification -->
                <div class="auth-form" id="otpVerification">
                    <p class="otp-instruction">
                        <span data-translate="Enter OTP sent to">Enter OTP sent to</span> <span id="phoneDisplay"></span>
                    </p>
                    <div class="otp-inputs">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                        <input type="text" class="form-control otp-input" maxlength="1" inputmode="numeric">
                    </div>
                    <div class="countdown" id="countdown">02:00</div>
                    <button class="btn btn-primary btn-full" id="verifyOtpBtn">
                        <i class="fas fa-check"></i>
                        <span data-translate="Verify OTP">Verify OTP</span>
                    </button>
                    <button class="btn btn-outline btn-full" id="backToPhoneBtn" style="margin-top: 0.5rem;">
                        <i class="fas fa-arrow-left"></i>
                        <span data-translate="Back">Back</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Registration Page -->
        <div id="registrationPage" class="content-container" style="display: none;">
            <div class="auth-container" style="max-width: 600px;">
                <h2 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary);">
                    <i class="fas fa-user-plus"></i>
                    <span data-translate="Complete Profile">Complete Profile</span>
                </h2>
                
                <div class="form-group">
                    <label>
                        <i class="fas fa-user"></i>
                        <span data-translate="Full Name">Full Name</span>
                    </label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="regFirstName" placeholder="First Name" required>
                        <input type="text" class="form-control" id="regLastName" placeholder="Last Name" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-map-marker-alt"></i>
                        <span data-translate="Farm Location">Farm Location</span>
                    </label>
                    <input type="text" class="form-control" id="regFarmLocation" placeholder="Village, District, State" required>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span data-translate="Total Farm Size">Total Farm Size</span>
                    </label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="regFarmAcres" placeholder="Acres" min="0" step="0.1" required>
                        <input type="number" class="form-control" id="regFarmCents" placeholder="Cents" min="0" max="99">
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-phone"></i>
                        <span data-translate="Alternative Contact">Alternative Contact</span>
                    </label>
                    <input type="tel" class="form-control" id="regAltPhone" placeholder="Alternative phone number">
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-id-card"></i>
                        <span data-translate="Aadhar Number">Aadhar Number</span>
                    </label>
                    <input type="text" class="form-control" id="regAadhar" placeholder="12-digit Aadhar number" maxlength="12">
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-file-alt"></i>
                        <span data-translate="Ration Card Number">Ration Card Number</span>
                    </label>
                    <input type="text" class="form-control" id="regRation" placeholder="Ration card number">
                </div>

                <div class="form-group">
                    <label>
                        <i class="fas fa-seedling"></i>
                        <span data-translate="Primary Crops">Primary Crops</span>
                    </label>
                    <div class="crop-selection-grid" id="primaryCropsGrid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; margin: 1rem 0;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <button class="btn btn-primary btn-full" id="completeRegistrationBtn">
                    <i class="fas fa-check-circle"></i>
                    <span data-translate="Complete Registration">Complete Registration</span>
                </button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboardPage" class="content-container" style="display: none;">
            
            <!-- Overview Tab -->
            <div class="tab-content active" id="overview-tab">
                <!-- Enhanced Weather Card -->
                <div class="weather-card" id="weatherCard" style="display: none;">
                    <div class="weather-header">
                        <div class="weather-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="weatherLocation">Loading...</span>
                        </div>
                        <div class="weather-temp" id="weatherTemp">--Â°C</div>
                    </div>
                    <div class="weather-main">
                        <div class="weather-icon" id="weatherIcon">
                            <i class="fas fa-sun"></i>
                        </div>
                        <div>
                            <div class="weather-description" id="weatherDescription">Loading...</div>
                        </div>
                    </div>
                    <div class="weather-details">
                        <div class="weather-detail">
                            <div class="weather-detail-label" data-translate="Humidity">Humidity</div>
                            <div class="weather-detail-value" id="weatherHumidity">--%</div>
                        </div>
                        <div class="weather-detail">
                            <div class="weather-detail-label" data-translate="Wind">Wind</div>
                            <div class="weather-detail-value" id="weatherWind">-- km/h</div>
                        </div>
                        <div class="weather-detail">
                            <div class="weather-detail-label" data-translate="UV Index">UV Index</div>
                            <div class="weather-detail-value" id="weatherUV">--</div>
                        </div>
                    </div>
                </div>

                <!-- Weather Prediction -->
                <div class="weather-prediction" id="weatherPrediction" style="display: none;">
                    <div class="prediction-title">
                        <i class="fas fa-cloud-rain"></i>
                        <span>7-Day Weather Forecast</span>
                    </div>
                    <div class="forecast-grid" id="forecastGrid">
                        <!-- Will be populated with 7-day forecast -->
                    </div>
                </div>

                <!-- Weather Alerts -->
                <div id="weatherAlerts"></div>

                <!-- Quick Links -->
                <div class="quick-links">
                    <div class="quick-link" onclick="switchTab('crops'); updateMobileNav('crops');">
                        <i class="fas fa-seedling quick-link-icon crop"></i>
                        <span class="quick-link-label" data-translate="Add Crop">Add Crop</span>
                    </div>
                    <div class="quick-link" onclick="openModal('transactionModal')">
                        <i class="fas fa-plus-circle quick-link-icon money"></i>
                        <span class="quick-link-label" data-translate="Add Transaction">Add Transaction</span>
                    </div>
                    <div class="quick-link" onclick="switchTab('assets'); updateMobileNav('assets');">
                        <i class="fas fa-tractor quick-link-icon asset"></i>
                        <span class="quick-link-label" data-translate="Add Asset">Add Asset</span>
                    </div>
                    <div class="quick-link" onclick="toggleWeatherDetails()">
                        <i class="fas fa-cloud-sun quick-link-icon weather"></i>
                        <span class="quick-link-label" data-translate="Weather">Weather</span>
                    </div>
                </div>

                <div class="financial-summary-grid">
                    <div class="financial-summary-card income">
                        <div class="card-header">
                            <div class="card-icon" style="background: rgba(56, 142, 60, 0.1); color: var(--success);">
                                <i class="fas fa-trending-up"></i>
                            </div>
                        </div>
                        <div class="card-label" data-translate="Total Income">Total Income</div>
                        <div class="card-value" id="totalIncome">â‚¹0</div>
                    </div>
                    <div class="financial-summary-card expense">
                        <div class="card-header">
                            <div class="card-icon" style="background: rgba(211, 47, 47, 0.1); color: var(--danger);">
                                <i class="fas fa-trending-down"></i>
                            </div>
                        </div>
                        <div class="card-label" data-translate="Total Expenses">Total Expenses</div>
                        <div class="card-value" id="totalExpenses">â‚¹0</div>
                    </div>
                    <div class="financial-summary-card profit">
                        <div class="card-header">
                            <div class="card-icon" style="background: rgba(255, 160, 0, 0.1); color: var(--secondary);">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="card-label" data-translate="Net Profit">Net Profit</div>
                        <div class="card-value" id="netProfit">â‚¹0</div>
                    </div>
                    <div class="financial-summary-card loan">
                        <div class="card-header">
                            <div class="card-icon" style="background: rgba(25, 118, 210, 0.1); color: var(--info);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                        </div>
                        <div class="card-label" data-translate="Active Loans">Active Loans</div>
                        <div class="card-value" id="activeLoans">â‚¹0</div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>
                        <i class="fas fa-chart-line"></i>
                        <span data-translate="Monthly Insights">Monthly Insights</span>
                    </h3>
                    <div class="insight-metric">
                        <span class="insight-label" data-translate="Best Performing Crop">Best Performing Crop</span>
                        <span class="insight-value" id="bestCrop">-</span>
                    </div>
                    <div class="insight-metric">
                        <span class="insight-label" data-translate="Highest Expense Category">Highest Expense Category</span>
                        <span class="insight-value" id="highestExpense">-</span>
                    </div>
                    <div class="insight-metric">
                        <span class="insight-label" data-translate="ROI This Season">ROI This Season</span>
                        <span class="insight-value" id="seasonROI">0%</span>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>
                        <i class="fas fa-bell"></i>
                        <span data-translate="Notifications & Reminders">Notifications & Reminders</span>
                    </h3>
                    <div id="notificationsList">
                        <!-- Notifications will be displayed here -->
                    </div>
                </div>
            </div>

            <!-- Add other tabs content here (crops, money, assets, ideas, profile) -->
            <!-- For brevity, I'll include placeholder divs -->
            <div class="tab-content" id="crops-tab">
                <!-- Crops content -->
            </div>
            <div class="tab-content" id="money-tab">
                <!-- Money content -->
            </div>
            <div class="tab-content" id="assets-tab">
                <!-- Assets content -->
            </div>
            <div class="tab-content" id="ideas-tab">
                <!-- Ideas content -->
            </div>
            <div class="tab-content" id="profile-tab">
                <!-- Profile content -->
            </div>
        </div>

        <!-- Modals placeholder -->
        <div class="modal" id="transactionModal">
            <!-- Transaction modal content -->
        </div>
        
        <!-- Mobile Bottom Navigation -->
        <div class="mobile-bottom-nav" id="mobileNav" style="display: none;">
            <button class="mobile-nav-item active" data-tab="overview">
                <i class="fas fa-home"></i>
                <span data-translate="Home">Home</span>
            </button>
            <button class="mobile-nav-item" data-tab="crops">
                <i class="fas fa-seedling"></i>
                <span data-translate="Crops">Crops</span>
            </button>
            <button class="mobile-nav-item" data-tab="money">
                <i class="fas fa-dollar-sign"></i>
                <span data-translate="Money">Money</span>
                <div class="notification-dot" id="transactionNotification" style="display: none;"></div>
            </button>
            <button class="mobile-nav-item" data-tab="assets">
                <i class="fas fa-warehouse"></i>
                <span data-translate="Assets">Assets</span>
            </button>
            <button class="mobile-nav-item" data-tab="ideas">
                <i class="fas fa-lightbulb"></i>
                <span data-translate="Ideas">Ideas</span>
            </button>
            <button class="mobile-nav-item" data-tab="profile">
                <i class="fas fa-user"></i>
                <span data-translate="Profile">Profile</span>
            </button>
        </div>

        <!-- Floating Action Button -->
        <button class="floating-action-button hidden" id="fabButton">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <script>
        // Enhanced global application state with Firebase integration
        let currentUser = null;
        let isOnline = navigator.onLine;
        let selectedAuthTab = 'email';
        let currentPage = 'auth';
        let currentTab = 'overview';
        let userLocation = null;
        let weatherData = null;
        let currentLanguage = 'en';
        let isDarkMode = false;
        let deferredPrompt = null;
        let weatherUpdateInterval = null;
        let recaptchaVerifier = null;
        let confirmationResult = null;
        
        let appData = {
            crops: [],
            transactions: [],
            loans: [],
            equipment: [],
            livestock: [],
            land: [],
            inventory: [],
            profile: null,
            notifications: []
        };

        // Enhanced Language translations
        const translations = {
            en: {
                'Agricultural Management System': 'Agricultural Management System',
                'Loading your farm data...': 'Loading your farm data...',
                'Email': 'Email',
                'Password': 'Password',
                'Login': 'Login',
                'Register': 'Register',
                'Phone': 'Phone',
                'Google': 'Google',
                'Phone Number': 'Phone Number',
                'Send OTP': 'Send OTP',
                'Verify OTP': 'Verify OTP',
                'Back': 'Back',
                'Detect Location': 'Detect Location',
                'Complete Profile': 'Complete Profile',
                'Full Name': 'Full Name',
                'Farm Location': 'Farm Location',
                'Total Farm Size': 'Total Farm Size',
                'Alternative Contact': 'Alternative Contact',
                'Aadhar Number': 'Aadhar Number',
                'Ration Card Number': 'Ration Card Number',
                'Primary Crops': 'Primary Crops',
                'Complete Registration': 'Complete Registration',
                'Home': 'Home',
                'Crops': 'Crops',
                'Money': 'Money',
                'Assets': 'Assets',
                'Ideas': 'Ideas',
                'Profile': 'Profile',
                'Add Crop': 'Add Crop',
                'Add Transaction': 'Add Transaction',
                'Add Asset': 'Add Asset',
                'Weather': 'Weather',
                'Total Income': 'Total Income',
                'Total Expenses': 'Total Expenses',
                'Net Profit': 'Net Profit',
                'Active Loans': 'Active Loans',
                'Humidity': 'Humidity',
                'Wind': 'Wind',
                'UV Index': 'UV Index',
                'Monthly Insights': 'Monthly Insights',
                'Best Performing Crop': 'Best Performing Crop',
                'Highest Expense Category': 'Highest Expense Category',
                'ROI This Season': 'ROI This Season',
                'Notifications & Reminders': 'Notifications & Reminders'
            },
            hi: {
                'Agricultural Management System': 'à¤•à¥ƒà¤·à¤¿ à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€',
                'Loading your farm data...': 'à¤†à¤ªà¤•à¤¾ à¤–à¥‡à¤¤ à¤¡à¥‡à¤Ÿà¤¾ à¤²à¥‹à¤¡ à¤¹à¥‹ à¤°à¤¹à¤¾ à¤¹à¥ˆ...',
                'Email': 'à¤ˆà¤®à¥‡à¤²',
                'Password': 'à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡',
                'Login': 'à¤²à¥‰à¤— à¤‡à¤¨',
                'Register': 'à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£',
                'Phone': 'à¤«à¥‹à¤¨',
                'Google': 'à¤—à¥‚à¤—à¤²',
                'Phone Number': 'à¤«à¥‹à¤¨ à¤¨à¤‚à¤¬à¤°',
                'Send OTP': 'OTP à¤­à¥‡à¤œà¥‡à¤‚',
                'Verify OTP': 'OTP à¤¸à¤¤à¥à¤¯à¤¾à¤ªà¤¿à¤¤ à¤•à¤°à¥‡à¤‚',
                'Back': 'à¤µà¤¾à¤ªà¤¸',
                'Detect Location': 'à¤¸à¥à¤¥à¤¾à¤¨ à¤–à¥‹à¤œà¥‡à¤‚',
                'Complete Profile': 'à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤² à¤ªà¥‚à¤°à¤¾ à¤•à¤°à¥‡à¤‚',
                'Full Name': 'à¤ªà¥‚à¤°à¤¾ à¤¨à¤¾à¤®',
                'Farm Location': 'à¤–à¥‡à¤¤ à¤•à¤¾ à¤¸à¥à¤¥à¤¾à¤¨',
                'Home': 'à¤¹à¥‹à¤®',
                'Crops': 'à¤«à¤¸à¤²',
                'Money': 'à¤ªà¥ˆà¤¸à¤¾',
                'Assets': 'à¤¸à¤‚à¤ªà¤¤à¥à¤¤à¤¿',
                'Ideas': 'à¤¸à¥à¤à¤¾à¤µ',
                'Profile': 'à¤ªà¥à¤°à¥‹à¤«à¤¾à¤‡à¤²',
                'Add Crop': 'à¤«à¤¸à¤² à¤œà¥‹à¤¡à¤¼à¥‡à¤‚',
                'Weather': 'à¤®à¥Œà¤¸à¤®',
                'Total Income': 'à¤•à¥à¤² à¤†à¤¯',
                'Total Expenses': 'à¤•à¥à¤² à¤–à¤°à¥à¤š',
                'Net Profit': 'à¤¶à¥à¤¦à¥à¤§ à¤²à¤¾à¤­',
                'Active Loans': 'à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤‹à¤£'
            },
            te: {
                'Agricultural Management System': 'à°µà±à°¯à°µà°¸à°¾à°¯ à°¨à°¿à°°à±à°µà°¹à°£ à°µà±à°¯à°µà°¸à±à°¥',
                'Loading your farm data...': 'à°®à±€ à°µà±à°¯à°µà°¸à°¾à°¯ à°¡à±‡à°Ÿà°¾ à°²à±‹à°¡à± à°…à°µà±à°¤à±‹à°‚à°¦à°¿...',
                'Email': 'à°‡à°®à±†à°¯à°¿à°²à±',
                'Password': 'à°ªà°¾à°¸à±à°µà°°à±à°¡à±',
                'Login': 'à°²à°¾à°—à°¿à°¨à±',
                'Register': 'à°¨à°®à±‹à°¦à±',
                'Phone': 'à°«à±‹à°¨à±',
                'Google': 'à°—à±‚à°—à±à°²à±',
                'Phone Number': 'à°«à±‹à°¨à± à°¨à°‚à°¬à°°à±',
                'Send OTP': 'OTP à°ªà°‚à°ªà±',
                'Verify OTP': 'OTP à°§à±ƒà°µà±€à°•à°°à°¿à°‚à°šà±',
                'Back': 'à°µà±†à°¨à±à°•à°•à±',
                'Detect Location': 'à°¸à±à°¥à°¾à°¨à°‚ à°—à±à°°à±à°¤à°¿à°‚à°šà±',
                'Complete Profile': 'à°ªà±à°°à±Šà°«à±ˆà°²à± à°ªà±‚à°°à±à°¤à°¿à°šà±‡à°¯à±',
                'Full Name': 'à°ªà±‚à°°à±à°¤à°¿ à°ªà±‡à°°à±',
                'Farm Location': 'à°µà±à°¯à°µà°¸à°¾à°¯ à°¸à±à°¥à°²à°‚',
                'Home': 'à°¹à±‹à°®à±',
                'Crops': 'à°ªà°‚à°Ÿà°²à±',
                'Money': 'à°¡à°¬à±à°¬à±',
                'Assets': 'à°†à°¸à±à°¤à±à°²à±',
                'Ideas': 'à°†à°²à±‹à°šà°¨à°²à±',
                'Profile': 'à°ªà±à°°à±Šà°«à±ˆà°²à±',
                'Add Crop': 'à°ªà°‚à°Ÿ à°œà±‹à°¡à°¿à°‚à°šà±',
                'Weather': 'à°µà°¾à°¤à°¾à°µà°°à°£à°‚',
                'Total Income': 'à°®à±Šà°¤à±à°¤à°‚ à°†à°¦à°¾à°¯à°‚',
                'Total Expenses': 'à°®à±Šà°¤à±à°¤à°‚ à°–à°°à±à°šà±à°²à±',
                'Net Profit': 'à°¨à°¿à°•à°° à°²à°¾à°­à°‚',
                'Active Loans': 'à°•à±à°°à°¿à°¯à°¾à°¶à±€à°² à°°à±à°£à°¾à°²à±'
            }
        };

        // Crop types with more varieties
        const cropTypes = [
            { name: 'paddy', icon: 'ðŸŒ¾', label: 'Paddy/Rice', duration: 120, season: 'kharif' },
            { name: 'wheat', icon: 'ðŸŒ¾', label: 'Wheat', duration: 150, season: 'rabi' },
            { name: 'cotton', icon: 'ðŸŒ¿', label: 'Cotton', duration: 180, season: 'kharif' },
            { name: 'maize', icon: 'ðŸŒ½', label: 'Maize/Corn', duration: 100, season: 'kharif' },
            { name: 'sugarcane', icon: 'ðŸŽ‹', label: 'Sugarcane', duration: 365, season: 'annual' },
            { name: 'soybean', icon: 'ðŸŒ±', label: 'Soybean', duration: 100, season: 'kharif' },
            { name: 'tomato', icon: 'ðŸ…', label: 'Tomato', duration: 75, season: 'zaid' },
            { name: 'onion', icon: 'ðŸ§…', label: 'Onion', duration: 120, season: 'rabi' },
            { name: 'potato', icon: 'ðŸ¥”', label: 'Potato', duration: 90, season: 'rabi' },
            { name: 'chili', icon: 'ðŸŒ¶ï¸', label: 'Chili', duration: 120, season: 'kharif' },
            { name: 'groundnut', icon: 'ðŸ¥œ', label: 'Groundnut', duration: 110, season: 'kharif' },
            { name: 'sunflower', icon: 'ðŸŒ»', label: 'Sunflower', duration: 90, season: 'rabi' }
        ];

        // Weather API Configuration
        const WEATHER_API_KEY = '7bd4e6b6ccmsh3b9dfac86b6b8f1p1a2b2ejsnd7bf77c67a3a';
        const WEATHER_HOST = 'weatherapi-com.p.rapidapi.com';

        // Enhanced Notification System
        class NotificationManager {
            constructor() {
                this.container = document.getElementById('notificationContainer');
                this.notifications = new Map();
            }

            async requestPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    return permission === 'granted';
                }
                return false;
            }

            showNotification(title, message, type = 'info', duration = 5000) {
                const id = this.generateId();
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas fa-${this.getIconForType(type)}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${title}</div>
                        <div class="notification-text">${message}</div>
                    </div>
                    <button class="notification-close" onclick="notificationManager.removeNotification('${id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                this.container.appendChild(notification);
                this.notifications.set(id, notification);

                setTimeout(() => notification.classList.add('show'), 100);

                if (duration > 0) {
                    setTimeout(() => this.removeNotification(id), duration);
                }

                return id;
            }

            removeNotification(id) {
                const notification = this.notifications.get(id);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                        this.notifications.delete(id);
                    }, 300);
                }
            }

            getIconForType(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
        }

        const notificationManager = new NotificationManager();

        // Enhanced Location Manager
        class LocationManager {
            constructor() {
                this.watchId = null;
                this.lastKnownPosition = null;
            }

            async requestPermission() {
                return new Promise((resolve) => {
                    const modal = document.getElementById('locationPermissionModal');
                    modal.classList.add('active');

                    document.getElementById('allowLocationBtn').onclick = () => {
                        modal.classList.remove('active');
                        this.getCurrentPosition().then(resolve).catch(() => resolve(null));
                    };

                    document.getElementById('denyLocationBtn').onclick = () => {
                        modal.classList.remove('active');
                        resolve(null);
                    };
                });
            }

            async getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            this.lastKnownPosition = position;
                            userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            resolve(position);
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        }
                    );
                });
            }

            startWatching() {
                if (navigator.geolocation) {
                    this.watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            this.lastKnownPosition = position;
                            userLocation = {
                                lat: position.coords.latitude,
                                lon: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            if (weatherUpdateInterval) {
                                loadWeatherData();
                            }
                        },
                        (error) => console.warn('Location watch error:', error),
                        {
                            enableHighAccuracy: false,
                            timeout: 60000,
                            maximumAge: 600000
                        }
                    );
                }
            }

            stopWatching() {
                if (this.watchId) {
                    navigator.geolocation.clearWatch(this.watchId);
                    this.watchId = null;
                }
            }
        }

        const locationManager = new LocationManager();

        // Firebase Authentication Handler
        window.authStateHandler = async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                
                if (appData.profile) {
                    showPage('dashboard');
                    loadDashboard();
                } else {
                    showPage('registration');
                }
            } else {
                currentUser = null;
                showPage('auth');
            }
        };

        // Enhanced Firebase Authentication Functions
        async function emailLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Please fill all fields');
                return;
            }

            try {
                const userCredential = await window.firebaseAuth.signInWithEmailAndPassword(window.auth, email, password);
                notificationManager.showNotification('Success', 'Login successful!', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showError(getFirebaseErrorMessage(error));
            }
        }

        async function emailRegister() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError('Please fill all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            try {
                const userCredential = await window.firebaseAuth.createUserWithEmailAndPassword(window.auth, email, password);
                notificationManager.showNotification('Success', 'Account created successfully!', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                showError(getFirebaseErrorMessage(error));
            }
        }

        async function googleSignIn() {
            try {
                const provider = new window.firebaseAuth.GoogleAuthProvider();
                const result = await window.firebaseAuth.signInWithPopup(window.auth, provider);
                notificationManager.showNotification('Success', 'Google sign-in successful!', 'success');
            } catch (error) {
                console.error('Google sign-in error:', error);
                showError(getFirebaseErrorMessage(error));
            }
        }

        async function sendOtp() {
            const phone = document.getElementById('phoneNumber').value.trim();
            const countryCode = document.getElementById('countryCode').value;
            
            if (!phone || phone.length !== 10) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }

            const fullPhone = countryCode + phone;

            try {
                if (!recaptchaVerifier) {
                    recaptchaVerifier = new window.firebaseAuth.RecaptchaVerifier(window.auth, 'recaptcha-container', {
                        size: 'invisible',
                        callback: (response) => {
                            console.log('reCAPTCHA solved');
                        }
                    });
                }

                confirmationResult = await window.firebaseAuth.signInWithPhoneNumber(window.auth, fullPhone, recaptchaVerifier);
                
                document.getElementById('phoneDisplay').textContent = fullPhone;
                showAuthForm('otpVerification');
                startOtpCountdown();
                notificationManager.showNotification('Success', 'OTP sent successfully!', 'success');
            } catch (error) {
                console.error('OTP send error:', error);
                showError(getFirebaseErrorMessage(error));
            }
        }

        async function verifyOtp() {
            const otpInputs = document.querySelectorAll('.otp-input');
            let otp = '';
            otpInputs.forEach(input => otp += input.value);
            
            if (otp.length !== 6) {
                showError('Please enter complete 6-digit OTP');
                return;
            }

            try {
                if (confirmationResult) {
                    const result = await confirmationResult.confirm(otp);
                    notificationManager.showNotification('Success', 'Phone verification successful!', 'success');
                }
            } catch (error) {
                console.error('OTP verification error:', error);
                showError('Invalid OTP. Please try again.');
            }
        }

        async function logout() {
            try {
                await window.firebaseAuth.signOut(window.auth);
                notificationManager.showNotification('Success', 'Logged out successfully!', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showError('Error logging out');
            }
        }

        // Enhanced Firebase Data Functions
        async function loadUserData() {
            if (!currentUser) return;

            try {
                const docRef = window.firebaseDb.doc(window.db, 'users', currentUser.uid);
                const docSnap = await window.firebaseDb.getDoc(docRef);
                
                if (docSnap.exists()) {
                    appData = docSnap.data();
                    
                    if (appData.profile) {
                        document.getElementById('mobileNav').style.display = 'flex';
                        document.getElementById('fabButton').classList.remove('hidden');
                    }
                } else {
                    appData = {
                        crops: [],
                        transactions: [],
                        loans: [],
                        equipment: [],
                        livestock: [],
                        land: [],
                        inventory: [],
                        profile: null,
                        notifications: []
                    };
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showError('Failed to load user data');
            }
        }

        async function saveUserData() {
            if (!currentUser) return;

            try {
                appData.lastUpdated = new Date().toISOString();
                const docRef = window.firebaseDb.doc(window.db, 'users', currentUser.uid);
                await window.firebaseDb.setDoc(docRef, appData);
                
                // Show sync indicator
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) {
                    syncBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error saving user data:', error);
                showError('Failed to save data. Check your internet connection.');
            }
        }

        async function completeRegistration() {
            const firstName = document.getElementById('regFirstName').value.trim();
            const lastName = document.getElementById('regLastName').value.trim();
            const farmLocation = document.getElementById('regFarmLocation').value.trim();
            const farmAcres = document.getElementById('regFarmAcres').value;
            const farmCents = document.getElementById('regFarmCents').value || '0';
            const altPhone = document.getElementById('regAltPhone').value.trim();
            const aadhar = document.getElementById('regAadhar').value.trim();
            const ration = document.getElementById('regRation').value.trim();
            
            if (!firstName || !lastName || !farmLocation || !farmAcres) {
                showError('Please fill all required fields');
                return;
            }

            const selectedCrops = Array.from(document.querySelectorAll('#primaryCropsGrid .selectable-item.selected'))
                .map(item => item.dataset.crop);

            appData.profile = {
                firstName,
                lastName,
                farmLocation,
                totalFarmSize: {
                    acres: parseFloat(farmAcres),
                    cents: parseInt(farmCents)
                },
                primaryCrops: selectedCrops,
                alternativePhone: altPhone,
                aadhar: aadhar,
                ration: ration,
                registrationDate: new Date().toISOString(),
                email: currentUser.email,
                phone: currentUser.phoneNumber
            };

            await saveUserData();
            showPage('dashboard');
            loadDashboard();
            
            document.getElementById('mobileNav').style.display = 'flex';
            document.getElementById('fabButton').classList.remove('hidden');
            
            notificationManager.showNotification(
                'Welcome to Jama!',
                'Registration completed successfully. Start managing your farm!',
                'success'
            );
        }

        // Weather Management
        async function loadWeatherData() {
            if (!userLocation) return;
            
            try {
                const currentResponse = await fetch(
                    `https://weatherapi-com.p.rapidapi.com/current.json?q=${userLocation.lat},${userLocation.lon}`,
                    {
                        method: 'GET',
                        headers: {
                            'X-RapidAPI-Key': WEATHER_API_KEY,
                            'X-RapidAPI-Host': WEATHER_HOST
                        }
                    }
                );
                
                if (!currentResponse.ok) throw new Error('Weather API error');
                
                const currentData = await currentResponse.json();
                
                const forecastResponse = await fetch(
                    `https://weatherapi-com.p.rapidapi.com/forecast.json?q=${userLocation.lat},${userLocation.lon}&days=7`,
                    {
                        method: 'GET',
                        headers: {
                            'X-RapidAPI-Key': WEATHER_API_KEY,
                            'X-RapidAPI-Host': WEATHER_HOST
                        }
                    }
                );
                
                const forecastData = forecastResponse.ok ? await forecastResponse.json() : null;
                
                weatherData = {
                    current: currentData.current,
                    location: currentData.location,
                    forecast: forecastData?.forecast?.forecastday || []
                };
                
                updateWeatherDisplay();
                updateWeatherForecast();
                checkWeatherAlerts();
                
            } catch (error) {
                console.error('Weather loading error:', error);
                notificationManager.showNotification(
                    'Weather Error',
                    'Unable to load weather data. Please check your internet connection.',
                    'error'
                );
            }
        }

        function updateWeatherDisplay() {
            if (!weatherData) return;
            
            const weatherCard = document.getElementById('weatherCard');
            const locationElement = document.getElementById('weatherLocation');
            const tempElement = document.getElementById('weatherTemp');
            const descElement = document.getElementById('weatherDescription');
            const humidityElement = document.getElementById('weatherHumidity');
            const windElement = document.getElementById('weatherWind');
            const uvElement = document.getElementById('weatherUV');
            const iconElement = document.getElementById('weatherIcon');
            
            weatherCard.style.display = 'block';
            
            locationElement.textContent = weatherData.location?.name || appData.profile?.farmLocation || 'Your Farm';
            tempElement.textContent = `${Math.round(weatherData.current.temp_c)}Â°C`;
            descElement.textContent = weatherData.current.condition.text;
            iconElement.innerHTML = getWeatherIconHTML(weatherData.current.condition.code, weatherData.current.is_day);
            
            humidityElement.textContent = `${weatherData.current.humidity}%`;
            windElement.textContent = `${Math.round(weatherData.current.wind_kph)} km/h`;
            uvElement.textContent = weatherData.current.uv || '--';
        }

        function updateWeatherForecast() {
            if (!weatherData || !weatherData.forecast) return;
            
            const predictionCard = document.getElementById('weatherPrediction');
            const forecastGrid = document.getElementById('forecastGrid');
            
            if (weatherData.forecast.length > 0) {
                predictionCard.style.display = 'block';
                
                const forecastHTML = weatherData.forecast.map(day => {
                    const date = new Date(day.date);
                    const dayName = date.toLocaleDateString('en', { weekday: 'short' });
                    const rainChance = day.day.daily_chance_of_rain || 0;
                    
                    return `
                        <div class="forecast-item">
                            <div class="forecast-day">${dayName}</div>
                            <div class="forecast-icon">
                                ${getWeatherIconHTML(day.day.condition.code, 1)}
                            </div>
                            <div class="forecast-temp">${Math.round(day.day.maxtemp_c)}Â°/${Math.round(day.day.mintemp_c)}Â°</div>
                            <div class="forecast-rain">${rainChance}% ðŸŒ§ï¸</div>
                        </div>
                    `;
                }).join('');
                
                forecastGrid.innerHTML = forecastHTML;
            }
        }

        function getWeatherIconHTML(code, isDay) {
            const iconMap = {
                1000: isDay ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>',
                1003: '<i class="fas fa-cloud-sun"></i>',
                1006: '<i class="fas fa-cloud"></i>',
                1009: '<i class="fas fa-cloud"></i>',
                1030: '<i class="fas fa-smog"></i>',
                1063: '<i class="fas fa-cloud-drizzle"></i>',
                1087: '<i class="fas fa-bolt"></i>',
                1180: '<i class="fas fa-cloud-rain"></i>',
                1183: '<i class="fas fa-cloud-rain"></i>',
                1186: '<i class="fas fa-cloud-rain"></i>',
                1189: '<i class="fas fa-cloud-rain"></i>',
                1192: '<i class="fas fa-cloud-rain"></i>',
                1195: '<i class="fas fa-cloud-rain"></i>'
            };
            
            return iconMap[code] || '<i class="fas fa-cloud"></i>';
        }

        function checkWeatherAlerts() {
            if (!weatherData) return;
            
            const alertsContainer = document.getElementById('weatherAlerts');
            const alerts = [];
            
            const current = weatherData.current;
            
            if (current.temp_c > 35) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-thermometer-full',
                    title: 'Heat Wave Alert',
                    message: `Extreme heat detected (${Math.round(current.temp_c)}Â°C). Ensure adequate irrigation and livestock shade.`
                });
            }
            
            if (current.temp_c < 5) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-thermometer-empty',
                    title: 'Cold Weather Alert',
                    message: `Very cold weather (${Math.round(current.temp_c)}Â°C). Protect sensitive crops from frost.`
                });
            }
            
            if (current.wind_kph > 30) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-wind',
                    title: 'Strong Winds',
                    message: `High wind speeds (${Math.round(current.wind_kph)} km/h). Secure equipment and protect crops.`
                });
            }
            
            alertsContainer.innerHTML = alerts.map(alert => `
                <div class="weather-alert ${alert.type}">
                    <div class="alert-icon">
                        <i class="${alert.icon}"></i>
                    </div>
                    <div class="alert-content">
                        <h4>${alert.title}</h4>
                        <p>${alert.message}</p>
                    </div>
                </div>
            `).join('');
            
            alerts.forEach(alert => {
                if (alert.type === 'warning') {
                    notificationManager.showNotification(alert.title, alert.message, 'warning');
                }
            });
        }

        // Enhanced Location Detection
        async function detectLocation() {
            const statusElement = document.getElementById('locationStatus');
            const button = document.getElementById('detectLocationBtn');
            
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting location...';
            button.disabled = true;
            
            try {
                const position = await locationManager.requestPermission();
                
                if (position && userLocation) {
                    statusElement.innerHTML = `<i class="fas fa-map-marker-alt"></i> Location detected successfully`;
                    
                    const farmLocationInput = document.getElementById('regFarmLocation');
                    if (farmLocationInput && !farmLocationInput.value) {
                        farmLocationInput.value = `${userLocation.lat.toFixed(4)}, ${userLocation.lon.toFixed(4)}`;
                    }
                    
                    await loadWeatherData();
                    locationManager.startWatching();
                    
                    notificationManager.showNotification(
                        'Location Detected',
                        'Successfully detected your location and loaded weather data.',
                        'success'
                    );
                    
                } else {
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Location access denied. Please enter manually.';
                    
                    notificationManager.showNotification(
                        'Location Access Denied',
                        'Please enable location access for better weather information.',
                        'warning'
                    );
                }
                
            } catch (error) {
                console.error('Location detection error:', error);
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Unable to detect location. Please enter manually.';
                
                notificationManager.showNotification(
                    'Location Error',
                    'Unable to detect location. Please check your settings and try again.',
                    'error'
                );
            } finally {
                button.disabled = false;
            }
        }

        // PWA Functions
        function initializePWA() {
            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }

            // PWA Install Prompt
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById('installPrompt').classList.add('show');
            });

            document.getElementById('installBtn').addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    if (outcome === 'accepted') {
                        notificationManager.showNotification('Success', 'App installed successfully!', 'success');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.remove('show');
                }
            });

            document.getElementById('dismissInstall').addEventListener('click', () => {
                document.getElementById('installPrompt').classList.remove('show');
            });
        }

        // Enhanced utility functions
        function initializeApp() {
            setTimeout(() => {
                hideLoadingScreen();
                setupEventListeners();
                initializeDatePickers();
                setupOfflineDetection();
                populateCropTypeGrid();
                setCurrentDate();
                updateLanguage();
                initializePWA();
                
                notificationManager.requestPermission();
                
            }, 2000);
        }

        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('hidden');
            
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                showAuthElements();
            }, 500);
        }

        function showAuthElements() {
            document.getElementById('appHeader').style.display = 'block';
        }

        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('languageToggle').addEventListener('click', toggleLanguage);
            document.getElementById('detectLocationBtn').addEventListener('click', detectLocation);

            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => switchAuthTab(tab.dataset.auth));
            });

            document.getElementById('sendOtpBtn').addEventListener('click', sendOtp);
            document.getElementById('verifyOtpBtn').addEventListener('click', verifyOtp);
            document.getElementById('emailLoginBtn').addEventListener('click', emailLogin);
            document.getElementById('emailRegisterBtn').addEventListener('click', emailRegister);
            document.getElementById('googleSignInBtn').addEventListener('click', googleSignIn);
            document.getElementById('backToPhoneBtn').addEventListener('click', backToPhone);
            document.getElementById('completeRegistrationBtn').addEventListener('click', completeRegistration);

            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = item.dataset.tab;
                    switchTab(tab);
                    updateMobileNav(tab);
                });
            });

            document.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', closeModals);
            });

            // Enhanced OTP input handling
            document.querySelectorAll('.otp-input').forEach((input, index) => {
                input.addEventListener('input', (e) => {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    
                    if (e.target.value.length === 1 && index < 5) {
                        document.querySelectorAll('.otp-input')[index + 1].focus();
                    }
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                        document.querySelectorAll('.otp-input')[index - 1].focus();
                    }
                });
            });

            // Sync button
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.addEventListener('click', () => {
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    saveUserData();
                });
            }
        }

        function initializeDatePickers() {
            const today = new Date().toISOString().split('T')[0];
            
            const dateInputs = ['transactionDate', 'sowingDate', 'equipmentDate', 'livestockDate', 'inventoryDate', 'loanDate'];
            dateInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.value = today;
            });
        }

        function setCurrentDate() {
            // Set current date logic
        }

        function populateCropTypeGrid() {
            const grid = document.getElementById('primaryCropsGrid');
            if (grid) {
                grid.innerHTML = cropTypes.map(crop => `
                    <div class="selectable-item" data-crop="${crop.name}">
                        <div class="crop-icon">${crop.icon}</div>
                        <div class="crop-name">${crop.label}</div>
                    </div>
                `).join('');

                grid.addEventListener('click', (e) => {
                    const item = e.target.closest('.selectable-item');
                    if (item) {
                        item.classList.toggle('selected');
                    }
                });
            }
        }

        function setupOfflineDetection() {
            window.addEventListener('online', () => {
                isOnline = true;
                notificationManager.showNotification('Connection Restored', 'You are back online!', 'success');
            });

            window.addEventListener('offline', () => {
                isOnline = false;
                notificationManager.showNotification('Connection Lost', 'You are offline. Some features may not work.', 'warning');
            });
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            
            const themeIcon = document.querySelector('#themeToggle i');
            themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            
            localStorage.setItem('jama_theme', isDarkMode ? 'dark' : 'light');
        }

        function toggleLanguage() {
            const languages = ['en', 'hi', 'te'];
            const currentIndex = languages.indexOf(currentLanguage);
            currentLanguage = languages[(currentIndex + 1) % languages.length];
            
            updateLanguage();
            
            const langMap = { en: 'EN', hi: 'à¤¹à¤¿à¤‚', te: 'à°¤à±†' };
            document.getElementById('currentLanguage').textContent = langMap[currentLanguage];
            
            localStorage.setItem('jama_language', currentLanguage);
        }

        function updateLanguage() {
            const t = translations[currentLanguage] || translations.en;
            
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                if (t[key]) {
                    element.textContent = t[key];
                }
            });
        }

        function switchAuthTab(tabName) {
            selectedAuthTab = tabName;
            
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.querySelector(`[data-auth="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Auth`).classList.add('active');
        }

        function showAuthForm(formName) {
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.getElementById(formName).classList.add('active');
        }

        function backToPhone() {
            showAuthForm('phoneAuth');
        }

        function startOtpCountdown() {
            let timeLeft = 120;
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    countdownElement.textContent = 'OTP Expired';
                }
                timeLeft--;
            }, 1000);
        }

        function showPage(pageName) {
            currentPage = pageName;
            
            document.querySelectorAll('[id$="Page"]').forEach(page => {
                page.style.display = 'none';
            });
            
            document.getElementById(pageName + 'Page').style.display = 'block';
        }

        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            const tabContent = document.getElementById(tabName + '-tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        function updateMobileNav(activeTab) {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${activeTab}"]`).classList.add('active');
        }

        function loadDashboard() {
            if (!appData.profile) return;

            updateFinancialSummary();
            
            if (userLocation) {
                loadWeatherData();
                
                if (weatherUpdateInterval) clearInterval(weatherUpdateInterval);
                weatherUpdateInterval = setInterval(loadWeatherData, 30 * 60 * 1000);
            }
        }

        function updateFinancialSummary() {
            const transactions = appData.transactions || [];
            
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const netProfit = totalIncome - totalExpenses;
            const activeLoans = appData.loans?.filter(l => l.status === 'active').reduce((sum, l) => sum + (l.amount || 0), 0) || 0;

            document.getElementById('totalIncome').textContent = `â‚¹${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `â‚¹${totalExpenses.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `â‚¹${netProfit.toLocaleString()}`;
            document.getElementById('activeLoans').textContent = `â‚¹${activeLoans.toLocaleString()}`;
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function toggleWeatherDetails() {
            const weatherCard = document.getElementById('weatherCard');
            const prediction = document.getElementById('weatherPrediction');
            
            if (weatherCard.style.display === 'none') {
                weatherCard.style.display = 'block';
                prediction.style.display = 'block';
            } else {
                weatherCard.style.display = 'none';
                prediction.style.display = 'none';
            }
        }

        function showError(message) {
            notificationManager.showNotification('Error', message, 'error');
        }

        function showSuccess(message) {
            notificationManager.showNotification('Success', message, 'success');
        }

        function getFirebaseErrorMessage(error) {
            const errorMessages = {
                'auth/user-not-found': 'No user found with this email address.',
                'auth/wrong-password': 'Incorrect password.',
                'auth/email-already-in-use': 'An account with this email already exists.',
                'auth/weak-password': 'Password should be at least 6 characters.',
                'auth/invalid-email': 'Invalid email address.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.',
                'auth/network-request-failed': 'Network error. Please check your connection.'
            };
            
            return errorMessages[error.code] || error.message || 'An error occurred. Please try again.';
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Check for saved theme and language on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('jama_theme');
            const savedLanguage = localStorage.getItem('jama_language');
            
            if (savedTheme) {
                isDarkMode = savedTheme === 'dark';
                document.body.setAttribute('data-theme', savedTheme);
                const themeIcon = document.querySelector('#themeToggle i');
                if (themeIcon) themeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            if (savedLanguage) {
                currentLanguage = savedLanguage;
                updateLanguage();
                const langMap = { en: 'EN', hi: 'à¤¹à¤¿à¤‚', te: 'à°¤à±†' };
                const langElement = document.getElementById('currentLanguage');
                if (langElement) langElement.textContent = langMap[currentLanguage];
            }
        });
    </script>
</body>
</html>
