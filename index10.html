<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jama -  Farmer Financial Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Firebase App and Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ffa000;
            --secondary-light: #ffc107;
            --secondary-dark: #ff6f00;
            --text-light: #f5f5f5;
            --text-dark: #333;
            --bg-light: #f8f9fa;
            --bg-dark: #2c3e50;
            --success: #388e3c;
            --warning: #f57c00;
            --danger: #d32f2f;
            --gray: #78909c;
            --border-radius: 12px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .logo i {
            font-size: 3rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .logo h1 {
            font-weight: 700;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .form-container {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15);
            transform: translateY(-1px);
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        .input-group .form-control {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            border: 2px solid transparent;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-dark), var(--secondary));
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e53935);
            color: white;
        }

        .otp-input-container {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            gap: 8px;
        }

        .otp-input {
            width: 55px;
            height: 55px;
            text-align: center;
            font-size: 1.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            transition: var(--transition);
            font-weight: 600;
        }

        .otp-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15);
            transform: scale(1.05);
        }

        .countdown {
            text-align: center;
            margin: 1.5rem 0;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .resend-link {
            text-align: center;
            margin: 1rem 0;
        }

        .resend-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .resend-link a:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .message {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
            display: none;
            transition: var(--transition);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .footer {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-light), #e8f5e9);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .crop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 1.5rem 0;
        }

        .crop-item {
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .crop-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.15);
        }

        .crop-item.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
            transform: scale(1.02);
        }

        .crop-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 12px;
            border: 3px solid #f0f0f0;
        }

        .crop-item div {
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .slider-container {
            margin: 2rem 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e8f5e9);
            border-radius: var(--border-radius);
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #e0e0e0, var(--primary-light));
            outline: none;
            margin: 15px 0;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
        }

        .slider-value {
            text-align: center;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .expense-category {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }

        .expense-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .expense-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        }

        .expense-item.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
        }

        .expense-item img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #f0f0f0;
        }

        .funding-source {
            margin-bottom: 1.5rem;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            background: white;
            transition: var(--transition);
        }

        .funding-source:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .funding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .remove-funding {
            color: var(--danger);
            cursor: pointer;
            font-weight: bold;
            font-size: 1.4rem;
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
        }

        .remove-funding:hover {
            background: rgba(211, 47, 47, 0.1);
            transform: scale(1.1);
        }

        .dashboard-container {
            padding: 2rem;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .financial-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 2rem;
        }

        .financial-item {
            text-align: center;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .financial-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .financial-item.income {
            border-left: 5px solid var(--success);
            background: linear-gradient(135deg, #e8f5e9, white);
        }

        .financial-item.expense {
            border-left: 5px solid var(--danger);
            background: linear-gradient(135deg, #ffebee, white);
        }

        .financial-item.profit {
            border-left: 5px solid var(--secondary);
            background: linear-gradient(135deg, #fff8e1, white);
        }

        .financial-item.interest {
            border-left: 5px solid var(--warning);
            background: linear-gradient(135deg, #fff3e0, white);
        }

        .financial-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0.5rem 0;
        }

        .financial-label {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 2rem;
        }

        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 600;
            color: var(--gray);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), transparent);
        }

        .nav-tab:hover {
            color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .crop-card {
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            background: white;
            transition: var(--transition);
        }

        .crop-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crop-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: scale(1.1);
        }

        .secondary-income-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: var(--transition);
        }

        .secondary-income-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .weather-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: none;
            color: #1565c0;
        }

        .pricing-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border: none;
            color: #7b1fa2;
        }

        .soil-card {
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            border: none;
            color: #5d4037;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .otp-input {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
            }
            
            .crop-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .financial-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .expense-category {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .nav-tab {
                font-size: 0.9rem;
                padding: 10px 16px;
            }
        }

        @media (max-width: 480px) {
            .financial-summary {
                grid-template-columns: 1fr;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .logo i {
                font-size: 2.5rem;
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 1rem 0;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .editable-field {
            background: transparent;
            border: 1px dashed #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            min-width: 100px;
            transition: var(--transition);
        }

        .editable-field:hover {
            background: #f0f0f0;
            border-style: solid;
        }

        .editable-field:focus {
            background: white;
            border-color: var(--primary);
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <h1>Jama App</h1>
            </div>
            <p>Complete Agricultural Financial Management System</p>
        </div>

        <div class="form-container">
            <div class="error-message message" id="errorMessage"></div>
            <div class="success-message message" id="successMessage"></div>

            <!-- Step 1: Phone Number Input -->
            <div class="step active" id="step1">
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <div class="input-group">
                        <select class="form-control" id="countryCode" style="max-width: 80px;">
                            <option value="+91">🇮🇳 +91</option>
                            <option value="+1">🇺🇸 +1</option>
                            <option value="+44">🇬🇧 +44</option>
                        </select>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="9876543210">
                    </div>
                </div>
                <button class="btn btn-primary btn-full" id="sendOtpBtn">
                    <i class="fas fa-paper-plane"></i> Send OTP
                </button>
            </div>

            <!-- Step 2: OTP Verification -->
            <div class="step" id="step2">
                <p style="text-align: center; margin-bottom: 2rem; font-size: 1.1rem;">
                    Enter the 6-digit OTP sent to <span id="phoneNumberDisplay" style="font-weight: 700; color: var(--primary);"></span>
                </p>
                
                <div class="otp-input-container">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                </div>

                <div class="countdown" id="countdown">02:00</div>
                
                <div class="resend-link">
                    Didn't receive OTP? <a href="#" id="resendOtp">Resend OTP</a>
                </div>
                
                <button class="btn btn-primary btn-full" id="verifyOtpBtn">
                    <i class="fas fa-shield-alt"></i> Verify & Login
                </button>
                <button class="btn btn-outline btn-full" id="changeNumberBtn" style="margin-top: 12px;">
                    <i class="fas fa-edit"></i> Change Phone Number
                </button>
            </div>

            <!-- Step 3: Registration Form -->
            <div class="step" id="step3">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">
                    <i class="fas fa-user-plus"></i> Complete Your Registration
                </h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName"><i class="fas fa-user"></i> First Name</label>
                        <input type="text" class="form-control" id="firstName" placeholder="Enter your first name">
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName"><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" class="form-control" id="lastName" placeholder="Enter your last name">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cropType"><i class="fas fa-seedling"></i> Primary Crop</label>
                    <div class="crop-grid">
                        <div class="crop-item" data-crop="paddy">
                            <img src="https://images.pexels.com/photos/764281/pexels-photo-764281.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Paddy">
                            <div>Paddy</div>
                        </div>
                        <div class="crop-item" data-crop="cotton">
                            <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Cotton">
                            <div>Cotton</div>
                        </div>
                        <div class="crop-item" data-crop="maize">
                            <img src="https://images.pexels.com/photos/547263/pexels-photo-547263.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Maize">
                            <div>Maize</div>
                        </div>
                        <div class="crop-item" data-crop="chickpea">
                            <img src="https://images.pexels.com/photos/4750274/pexels-photo-4750274.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Chickpea">
                            <div>Chickpea</div>
                        </div>
                        <div class="crop-item" data-crop="chilli">
                            <img src="https://images.pexels.com/photos/1835658/pexels-photo-1835658.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Chilli">
                            <div>Chilli</div>
                        </div>
                        <div class="crop-item" data-crop="tobacco">
                            <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Tobacco">
                            <div>Tobacco</div>
                        </div>
                        <div class="crop-item" data-crop="red-chickpea">
                            <img src="https://images.pexels.com/photos/4110251/pexels-photo-4110251.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Red Chickpea">
                            <div>Red Chickpea</div>
                        </div>
                        <div class="crop-item" data-crop="black-gram">
                            <img src="https://images.pexels.com/photos/4110258/pexels-photo-4110258.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Black Gram">
                            <div>Black Gram</div>
                        </div>
                        <div class="crop-item" data-crop="green-gram">
                            <img src="https://images.pexels.com/photos/4750267/pexels-photo-4750267.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Green Gram">
                            <div>Green Gram</div>
                        </div>
                    </div>
                    <input type="hidden" id="cropType" value="">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="acres"><i class="fas fa-map"></i> Number of Acres</label>
                        <input type="number" class="form-control" id="acres" placeholder="Enter number of acres" min="0.1" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="sowingDate"><i class="fas fa-calendar"></i> Sowing Date</label>
                        <input type="text" class="form-control" id="sowingDate" placeholder="Select sowing date">
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="durationSlider"><i class="fas fa-clock"></i> Crop Duration (days): <span id="durationValue">120</span></label>
                    <input type="range" min="30" max="365" value="120" class="slider" id="durationSlider">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 33%;"></div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-full" id="completeRegistrationBtn">
                    <i class="fas fa-arrow-right"></i> Continue to Financial Setup
                </button>
            </div>

            <!-- Step 4: Financial Setup -->
            <div class="step" id="step4">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">
                    <i class="fas fa-chart-line"></i> Financial Setup
                </h2>
                
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-dark);">
                    <i class="fas fa-money-bill-wave"></i> Investment Sources
                </h3>
                
                <div id="fundingSources">
                    <div class="funding-source">
                        <div class="funding-header">
                            <select class="form-control funding-type" style="max-width: 200px;">
                                <option value="own">Own Funds</option>
                                <option value="bank">Bank Loan</option>
                                <option value="family">Family/Friends Loan</option>
                                <option value="govt">Government Subsidy</option>
                                <option value="other">Other Source</option>
                            </select>
                            <span class="remove-funding" style="display: none;">×</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                                <input type="number" class="form-control funding-amount" placeholder="Enter amount" min="0">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-percentage"></i> Interest Rate (%)</label>
                                <input type="number" class="form-control funding-rate" value="0" min="0" step="0.1" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar-alt"></i> Date Taken</label>
                            <input type="text" class="form-control funding-date" placeholder="Select date">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline btn-full" id="addFundingBtn" style="margin-bottom: 2rem;">
                    <i class="fas fa-plus-circle"></i> Add Another Funding Source
                </button>
                
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-dark);">
                    <i class="fas fa-receipt"></i> Expected Expenses
                </h3>
                
                <div class="expense-category">
                    <div class="expense-item" data-expense="seeds">
                        <img src="https://images.pexels.com/photos/1431282/pexels-photo-1431282.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Seeds">
                        <div>Seeds</div>
                    </div>
                    <div class="expense-item" data-expense="ploughing">
                        <img src="https://images.pexels.com/photos/2132180/pexels-photo-2132180.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Ploughing">
                        <div>Ploughing</div>
                    </div>
                    <div class="expense-item" data-expense="weeding">
                        <img src="https://images.pexels.com/photos/1263986/pexels-photo-1263986.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Weeding">
                        <div>Weeding</div>
                    </div>
                    <div class="expense-item" data-expense="pesticides">
                        <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Pesticides">
                        <div>Pesticides</div>
                    </div>
                    <div class="expense-item" data-expense="irrigation">
                        <img src="https://images.pexels.com/photos/1552242/pexels-photo-1552242.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Irrigation">
                        <div>Irrigation</div>
                    </div>
                    <div class="expense-item" data-expense="harvesting">
                        <img src="https://images.pexels.com/photos/2132227/pexels-photo-2132227.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Harvesting">
                        <div>Harvesting</div>
                    </div>
                    <div class="expense-item" data-expense="transport">
                        <img src="https://images.pexels.com/photos/1624496/pexels-photo-1624496.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Transport">
                        <div>Transport</div>
                    </div>
                    <div class="expense-item" data-expense="storage">
                        <img src="https://images.pexels.com/photos/3095699/pexels-photo-3095699.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Storage">
                        <div>Storage</div>
                    </div>
                    <div class="expense-item" data-expense="leasing">
                        <img src="https://images.pexels.com/photos/1146709/pexels-photo-1146709.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Leasing">
                        <div>Leasing</div>
                    </div>
                    <div class="expense-item" data-expense="insurance">
                        <img src="https://images.pexels.com/photos/5428836/pexels-photo-5428836.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Insurance">
                        <div>Insurance</div>
                    </div>
                </div>
                
                <div id="expenseDetails" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseAmount"><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                            <input type="number" class="form-control" id="expenseAmount" placeholder="Enter amount" min="0">
                        </div>
                        <div class="form-group">
                            <label for="expenseDate"><i class="fas fa-calendar"></i> Date</label>
                            <input type="text" class="form-control" id="expenseDate" placeholder="Select date">
                        </div>
                    </div>
                    <button class="btn btn-success" id="addExpenseBtn">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </div>
                
                <div class="form-group">
                    <h4><i class="fas fa-list"></i> Added Expenses</h4>
                    <ul id="expenseList" style="list-style: none; margin-top: 15px;">
                        <!-- Expenses will be listed here -->
                    </ul>
                </div>
                
                <button class="btn btn-primary btn-full" id="finishSetupBtn">
                    <i class="fas fa-check-circle"></i> Complete Setup
                </button>
            </div>

            <!-- Step 5: Dashboard -->
            <div class="step" id="step5">
                <div class="dashboard-container">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Farm Dashboard</h2>
                        <div>
                            <button class="btn btn-success btn-small" id="addCropBtn">
                                <i class="fas fa-plus"></i> Add Crop
                            </button>
                            <button class="btn btn-outline btn-small" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                    
                    <div class="financial-summary">
                        <div class="financial-item income">
                            <div class="financial-label">Total Income</div>
                            <div class="financial-value" id="totalIncome">₹0</div>
                            <div class="financial-label">From all sources</div>
                        </div>
                        <div class="financial-item expense">
                            <div class="financial-label">Total Expenses</div>
                            <div class="financial-value" id="totalExpenses">₹0</div>
                            <div class="financial-label">Farming costs</div>
                        </div>
                        <div class="financial-item profit">
                            <div class="financial-label">Net Profit</div>
                            <div class="financial-value" id="netProfit">₹0</div>
                            <div class="financial-label">This year</div>
                        </div>
                        <div class="financial-item interest">
                            <div class="financial-label">Interest Cost</div>
                            <div class="financial-value" id="interestCost">₹0</div>
                            <div class="financial-label">Weighted avg</div>
                        </div>
                    </div>

                    <div class="nav-tabs">
                        <div class="nav-tab active" data-tab="crops">
                            <i class="fas fa-seedling"></i> Crops
                        </div>
                        <div class="nav-tab" data-tab="financials">
                            <i class="fas fa-chart-pie"></i> Financials
                        </div>
                        <div class="nav-tab" data-tab="secondary">
                            <i class="fas fa-coins"></i> Secondary Income
                        </div>
                        <div class="nav-tab" data-tab="advisory">
                            <i class="fas fa-cloud-sun"></i> Advisory
                        </div>
                    </div>

                    <!-- Crops Tab -->
                    <div class="tab-content active" id="crops-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-leaf"></i> Active Crops</h3>
                            <div id="cropsList">
                                <!-- Crops will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Financials Tab -->
                    <div class="tab-content" id="financials-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-money-bill-wave"></i> Investment Sources</h3>
                            <div id="fundingBreakdown"></div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-receipt"></i> Expense Analysis</h3>
                            <div id="expenseBreakdown"></div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                            <div id="recentActivities"></div>
                        </div>
                    </div>

                    <!-- Secondary Income Tab -->
                    <div class="tab-content" id="secondary-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-tractor"></i> Machinery & Equipment</h3>
                            <button class="btn btn-success btn-small" id="addMachineryBtn">
                                <i class="fas fa-plus"></i> Add Machinery
                            </button>
                            <div id="machineryList">
                                <!-- Machinery items will be listed here -->
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-paw"></i> Livestock</h3>
                            <button class="btn btn-success btn-small" id="addLivestockBtn">
                                <i class="fas fa-plus"></i> Add Livestock
                            </button>
                            <div id="livestockList">
                                <!-- Livestock items will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Advisory Tab -->
                    <div class="tab-content" id="advisory-tab">
                        <div class="dashboard-card weather-card">
                            <h3><i class="fas fa-cloud-sun"></i> Weather Forecast</h3>
                            <div id="weatherInfo">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div><i class="fas fa-thermometer-half"></i></div>
                                        <div><strong>28°C</strong></div>
                                        <div>Temperature</div>
                                    </div>
                                    <div class="stat-item">
                                        <div><i class="fas fa-tint"></i></div>
                                        <div><strong>65%</strong></div>
                                        <div>Humidity</div>
                                    </div>
                                </div>
                                <p style="margin-top: 1rem; text-align: center;">Sunny with moderate humidity. Good for irrigation.</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-card pricing-card">
                            <h3><i class="fas fa-tags"></i> Market Prices</h3>
                            <div id="pricingInfo">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div><strong>₹2,850</strong></div>
                                        <div>Paddy/Quintal</div>
                                    </div>
                                    <div class="stat-item">
                                        <div><strong>₹7,200</strong></div>
                                        <div>Cotton/Quintal</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card soil-card">
                            <h3><i class="fas fa-seedling"></i> Soil Health & Advisory</h3>
                            <div id="soilInfo">
                                <p><strong>Soil pH:</strong> <span class="editable-field" contenteditable="true">6.8</span> (Optimal)</p>
                                <p><strong>Nitrogen:</strong> <span class="editable-field" contenteditable="true">Medium</span></p>
                                <p><strong>Phosphorus:</strong> <span class="editable-field" contenteditable="true">High</span></p>
                                <p><strong>Potassium:</strong> <span class="editable-field" contenteditable="true">Low</span></p>
                                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.7); border-radius: 8px;">
                                    <strong>Recommendation:</strong> Consider potassium supplementation for better crop yield.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="addCropModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Add New Crop</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label>Select Crop Type</label>
                    <div class="crop-grid" id="modalCropGrid">
                        <!-- Same crop options as registration -->
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalAcres">Acres</label>
                        <input type="number" class="form-control" id="modalAcres" placeholder="Enter acres" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="modalSowingDate">Sowing Date</label>
                        <input type="text" class="form-control" id="modalSowingDate" placeholder="Select date">
                    </div>
                </div>
                <div class="slider-container">
                    <label for="modalDurationSlider">Duration (days): <span id="modalDurationValue">120</span></label>
                    <input type="range" min="30" max="365" value="120" class="slider" id="modalDurationSlider">
                </div>
                <div class="form-group">
                    <label for="modalNotes">Farm Notes</label>
                    <textarea class="form-control" id="modalNotes" rows="3" placeholder="Add any notes about this crop..."></textarea>
                </div>
                <button class="btn btn-primary btn-full" id="saveCropBtn">
                    <i class="fas fa-save"></i> Save Crop
                </button>
            </div>
        </div>

        <div class="modal" id="addMachineryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-tractor"></i> Add Machinery/Equipment</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label for="machineryType">Equipment Type</label>
                    <select class="form-control" id="machineryType">
                        <option value="">Select Equipment</option>
                        <option value="tractor">Tractor</option>
                        <option value="harvester">Harvester</option>
                        <option value="plough">Plough</option>
                        <option value="pump">Water Pump</option>
                        <option value="sprayer">Pesticide Sprayer</option>
                        <option value="custom">Custom Equipment</option>
                    </select>
                </div>
                <div id="customMachineryInput" style="display: none;">
                    <div class="form-group">
                        <label for="customMachineryName">Custom Equipment Name</label>
                        <input type="text" class="form-control" id="customMachineryName" placeholder="Enter equipment name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="machineryAmount">Amount (₹)</label>
                        <input type="number" class="form-control" id="machineryAmount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label for="machineryDate">Date</label>
                        <input type="text" class="form-control" id="machineryDate" placeholder="Select date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="machineryType2">Transaction Type</label>
                    <select class="form-control" id="machineryType2">
                        <option value="purchase">Purchase</option>
                        <option value="sale">Sale</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="rental">Rental Income</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-full" id="saveMachineryBtn">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>

        <div class="modal" id="addLivestockModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-paw"></i> Add Livestock Transaction</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label for="livestockType">Livestock Type</label>
                    <select class="form-control" id="livestockType">
                        <option value="">Select Livestock</option>
                        <option value="cow">Cow</option>
                        <option value="buffalo">Buffalo</option>
                        <option value="goat">Goat</option>
                        <option value="sheep">Sheep</option>
                        <option value="chicken">Chicken</option>
                        <option value="custom">Other</option>
                    </select>
                </div>
                <div id="customLivestockInput" style="display: none;">
                    <div class="form-group">
                        <label for="customLivestockName">Custom Livestock Name</label>
                        <input type="text" class="form-control" id="customLivestockName" placeholder="Enter livestock type">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="livestockAmount">Amount (₹)</label>
                        <input type="number" class="form-control" id="livestockAmount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label for="livestockDate">Date</label>
                        <input type="text" class="form-control" id="livestockDate" placeholder="Select date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="livestockTransactionType">Transaction Type</label>
                    <select class="form-control" id="livestockTransactionType">
                        <option value="purchase">Purchase Animal</option>
                        <option value="sale">Sale Animal</option>
                        <option value="milk-sale">Milk Sale</option>
                        <option value="egg-sale">Egg Sale</option>
                        <option value="meat-sale">Meat Sale</option>
                        <option value="feed-cost">Feed Cost</option>
                        <option value="medical-cost">Medical Cost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="livestockNotes">Notes</label>
                    <input type="text" class="form-control" id="livestockNotes" placeholder="Additional details...">
                </div>
                <button class="btn btn-primary btn-full" id="saveLivestockBtn">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>

        <div class="modal" id="editCropModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Edit Crop Details</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editYield">Actual Yield (Quintal)</label>
                        <input type="number" class="form-control" id="editYield" placeholder="Enter yield" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editSellingPrice">Selling Price (₹/Quintal)</label>
                        <input type="number" class="form-control" id="editSellingPrice" placeholder="Enter price" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editStatus">Crop Status</label>
                    <select class="form-control" id="editStatus">
                        <option value="planted">Planted</option>
                        <option value="growing">Growing</option>
                        <option value="harvested">Harvested</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editNotes">Farm Notes</label>
                    <textarea class="form-control" id="editNotes" rows="3" placeholder="Update your farm notes..."></textarea>
                </div>
                <button class="btn btn-primary btn-full" id="saveEditedCropBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 FarmPro. Empowering farmers with smart financial management.</p>
        </div>
    </div>

     <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdfgtj1gvZ-bkomW1V40h-4tyUPHy_peo",
            authDomain: "jama-3f427.firebaseapp.com",
            projectId: "jama-3f427",
            storageBucket: "jama-3f427.firebasestorage.app",
            messagingSenderId: "897112470741",
            appId: "1:897112470741:web:ee6388f0faae459fcb1e5c",
            measurementId: "G-NN1BRV0QKS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM Elements
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const countryCodeSelect = document.getElementById('countryCode');
        const phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resendOtpLink = document.getElementById('resendOtp');
        const changeNumberBtn = document.getElementById('changeNumberBtn');
        const otpInputs = document.querySelectorAll('.otp-input');
        const countdown = document.getElementById('countdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const navItems = document.querySelectorAll('.nav-item');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const sections = document.querySelectorAll('.section');

        // Form elements
        const cropItems = document.querySelectorAll('.crop-item');
        const durationSlider = document.getElementById('durationSlider');
        const durationValue = document.getElementById('durationValue');
        const addCropBtn = document.getElementById('addCropBtn');
        const cropsTable = document.getElementById('cropsTable');
        const expenseItems = document.querySelectorAll('.expense-item');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const addIncomeBtn = document.getElementById('addIncomeBtn');
        const financialTable = document.getElementById('financialTable');
        const addFundingBtn = document.getElementById('addFundingBtn');
        const fundingSources = document.getElementById('fundingSources');
        const addLivestockBtn = document.getElementById('addLivestockBtn');
        const livestockTable = document.getElementById('livestockTable');
        const addMachineryBtn = document.getElementById('addMachineryBtn');
        const machineryTable = document.getElementById('machineryTable');
        const expenseCrop = document.getElementById('expenseCrop');
        const incomeCrop = document.getElementById('incomeCrop');

        // Global variables
        let confirmationResult = null;
        let countdownTimer = null;
        let timeLeft = 120; // 2 minutes in seconds
        let selectedCrop = '';
        let selectedExpense = '';
        let userData = {
            profile: {},
            crops: [],
            expenses: [],
            income: [],
            funding: [],
            livestock: [],
            machinery: []
        };

        // Initialize date pickers
        const sowingDate = document.getElementById('sowingDate');
        if (sowingDate) {
            flatpickr(sowingDate, {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        const expenseDate = document.getElementById('expenseDate');
        if (expenseDate) {
            flatpickr(expenseDate, {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        const incomeDate = document.getElementById('incomeDate');
        if (incomeDate) {
            flatpickr(incomeDate, {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        const livestockPurchaseDate = document.getElementById('livestockPurchaseDate');
        if (livestockPurchaseDate) {
            flatpickr(livestockPurchaseDate, {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        const machineryPurchaseDate = document.getElementById('machineryPurchaseDate');
        if (machineryPurchaseDate) {
            flatpickr(machineryPurchaseDate, {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        // Initialize funding date pickers
        function initFundingDatePickers() {
            document.querySelectorAll('.funding-date').forEach(input => {
                if (!input._flatpickr) {
                    flatpickr(input, {
                        dateFormat: "Y-m-d",
                        maxDate: "today"
                    });
                }
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize all functionality
            if (sendOtpBtn) sendOtpBtn.addEventListener('click', sendOtp);
            if (verifyOtpBtn) verifyOtpBtn.addEventListener('click', verifyOtp);
            if (resendOtpLink) resendOtpLink.addEventListener('click', resendOtp);
            if (changeNumberBtn) changeNumberBtn.addEventListener('click', changeNumber);
            if (logoutBtn) logoutBtn.addEventListener('click', logout);

            // Navigation
            if (navItems) {
                navItems.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        const section = this.getAttribute('data-section');
                        changeSection(section);
                    });
                });
            }

            if (sidebarLinks) {
                sidebarLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        sidebarLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        // Here you would handle subsection changes
                    });
                });
            }

            // Crop selection
            if (cropItems) {
                cropItems.forEach(item => {
                    item.addEventListener('click', () => {
                        cropItems.forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedCrop = item.getAttribute('data-crop');
                        document.getElementById('cropType').value = selectedCrop;
                    });
                });
            }

            // Duration slider
            if (durationSlider && durationValue) {
                durationSlider.addEventListener('input', () => {
                    durationValue.textContent = durationSlider.value;
                });
            }

            // Add crop
            if (addCropBtn) {
                addCropBtn.addEventListener('click', addCrop);
            }

            // Expense selection
            if (expenseItems) {
                expenseItems.forEach(item => {
                    item.addEventListener('click', () => {
                        expenseItems.forEach(i => i.classList.remove('selected'));
                        item.classList.add('selected');
                        selectedExpense = item.getAttribute('data-expense');
                    });
                });
            }

            // Add expense
            if (addExpenseBtn) {
                addExpenseBtn.addEventListener('click', addExpense);
            }

            // Add income
            if (addIncomeBtn) {
                addIncomeBtn.addEventListener('click', addIncome);
            }

            // Add funding source
            if (addFundingBtn) {
                addFundingBtn.addEventListener('click', addFundingSource);
            }

            // Add livestock
            if (addLivestockBtn) {
                addLivestockBtn.addEventListener('click', addLivestock);
            }

            // Add machinery
            if (addMachineryBtn) {
                addMachineryBtn.addEventListener('click', addMachinery);
            }

            // OTP input navigation
            if (otpInputs) {
                otpInputs.forEach((input, index) => {
                    input.addEventListener('input', () => {
                        if (input.value.length === 1 && index < otpInputs.length - 1) {
                            otpInputs[index + 1].focus();
                        }
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && input.value === '' && index > 0) {
                            otpInputs[index - 1].focus();
                        }
                    });
                });
            }

            // Initialize funding date pickers
            initFundingDatePickers();

            // Set up funding type change event for the initial funding source
            const fundingTypeSelect = document.querySelector('.funding-type');
            if (fundingTypeSelect) {
                fundingTypeSelect.addEventListener('change', function() {
                    const rateInput = this.closest('.funding-source').querySelector('.funding-rate');
                    if (this.value === 'own') {
                        rateInput.value = 0;
                        rateInput.disabled = true;
                    } else {
                        rateInput.disabled = false;
                    }
                });
            }
        });

        // Functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            
            // Hide error after 5 seconds
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            
            // Hide success after 5 seconds
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function changeSection(section) {
            // Update navigation
            navItems.forEach(item => {
                if (item.getAttribute('data-section') === section) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Show selected section
            sections.forEach(sec => {
                if (sec.id === `${section}-section`) {
                    sec.classList.add('active');
                } else {
                    sec.classList.remove('active');
                }
            });

            // If crops section is selected, update crop dropdowns
            if (section === 'financials') {
                updateCropDropdowns();
            }
        }

        function updateCropDropdowns() {
            // Clear existing options
            while (expenseCrop.options.length > 1) {
                expenseCrop.remove(1);
            }
            while (incomeCrop.options.length > 1) {
                incomeCrop.remove(1);
            }

            // Add crops to dropdowns
            userData.crops.forEach(crop => {
                const option = document.createElement('option');
                option.value = crop.id;
                option.textContent = `${crop.type} (${crop.acres} acres)`;
                
                expenseCrop.appendChild(option.cloneNode(true));
                incomeCrop.appendChild(option);
            });
        }

        function startCountdown() {
            clearInterval(countdownTimer);
            timeLeft = 120;
            updateCountdown();
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                updateCountdown();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    countdown.textContent = "OTP expired";
                    countdown.style.color = "#d32f2f";
                }
            }, 1000);
        }

        function updateCountdown() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdown.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function sendOtp() {
            const phoneNumber = phoneNumberInput.value.trim();
            const countryCode = countryCodeSelect.value;
            
            if (!phoneNumber) {
                showError('Please enter your phone number');
                return;
            }
            
            if (!/^\d{10}$/.test(phoneNumber)) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }
            
            const fullPhoneNumber = countryCode + phoneNumber;
            
            // Show loading state
            sendOtpBtn.textContent = 'Sending...';
            sendOtpBtn.disabled = true;
            
            // Firebase phone authentication
            auth.signInWithPhoneNumber(fullPhoneNumber, window.recaptchaVerifier)
                .then((result) => {
                    confirmationResult = result;
                    phoneNumberDisplay.textContent = fullPhoneNumber;
                    changeStep(step1, step2);
                    startCountdown();
                    showSuccess('OTP sent successfully!');
                })
                .catch((error) => {
                    console.error('Error sending OTP:', error);
                    showError('Failed to send OTP. Please try again.');
                })
                .finally(() => {
                    sendOtpBtn.textContent = 'Send OTP';
                    sendOtpBtn.disabled = false;
                });
        }

        function verifyOtp() {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });
            
            if (otp.length !== 6) {
                showError('Please enter the complete 6-digit OTP');
                return;
            }
            
            // Show loading state
            verifyOtpBtn.textContent = 'Verifying...';
            verifyOtpBtn.disabled = true;
            
            confirmationResult.confirm(otp)
                .then((result) => {
                    // User signed in successfully
                    const user = result.user;
                    showSuccess('Login successful!');
                    
                    // Hide login container and show app container
                    loginContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    
                    // Load user data from localStorage or initialize
                    loadUserData();
                })
                .catch((error) => {
                    console.error('Error verifying OTP:', error);
                    showError('Invalid OTP. Please try again.');
                })
                .finally(() => {
                    verifyOtpBtn.textContent = 'Verify & Login';
                    verifyOtpBtn.disabled = false;
                });
        }

        function resendOtp(e) {
            e.preventDefault();
            
            if (timeLeft > 0) {
                showError(`Please wait ${timeLeft} seconds before requesting a new OTP`);
                return;
            }
            
            sendOtp();
        }

        function changeNumber() {
            changeStep(step2, step1);
            clearInterval(countdownTimer);
            // Reset OTP inputs
            otpInputs.forEach(input => {
                input.value = '';
            });
        }

        function changeStep(currentStep, nextStep) {
            currentStep.classList.remove('active');
            nextStep.classList.add('active');
        }

        function loadUserData() {
            const savedData = localStorage.getItem('farmProUserData');
            if (savedData) {
                userData = JSON.parse(savedData);
                updateDashboard();
                updateCropsTable();
                updateFinancialTable();
                updateLivestockTable();
                updateMachineryTable();
            } else {
                // Initialize with empty data
                userData = {
                    profile: {},
                    crops: [],
                    expenses: [],
                    income: [],
                    funding: [],
                    livestock: [],
                    machinery: []
                };
            }
        }

        function saveUserData() {
            localStorage.setItem('farmProUserData', JSON.stringify(userData));
        }

        function addCrop() {
            const cropType = document.getElementById('cropType').value;
            const acres = document.getElementById('acres').value;
            const sowingDate = document.getElementById('sowingDate').value;
            const duration = document.getElementById('durationSlider').value;
            const expectedYield = document.getElementById('expectedYield').value;
            
            if (!cropType || !acres || !sowingDate || !expectedYield) {
                showError('Please fill all the fields');
                return;
            }
            
            const cropId = Date.now().toString();
            
            // Add crop to userData
            userData.crops.push({
                id: cropId,
                type: cropType,
                acres: parseFloat(acres),
                sowingDate: sowingDate,
                duration: parseInt(duration),
                expectedYield: parseFloat(expectedYield),
                actualYield: 0,
                status: 'growing',
                harvestDate: ''
            });
            
            // Save data
            saveUserData();
            
            // Update UI
            updateCropsTable();
            updateDashboard();
            
            // Reset form
            document.getElementById('acres').value = '';
            document.getElementById('sowingDate').value = '';
            document.getElementById('durationSlider').value = 120;
            document.getElementById('durationValue').textContent = '120';
            document.getElementById('expectedYield').value = '';
            cropItems.forEach(item => item.classList.remove('selected'));
            selectedCrop = '';
            
            showSuccess('Crop added successfully!');
        }

        function updateCropsTable() {
            const tbody = cropsTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            userData.crops.forEach(crop => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${crop.type}</td>
                    <td>${crop.acres}</td>
                    <td>${crop.sowingDate}</td>
                    <td>${crop.duration} days</td>
                    <td>${crop.status}</td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${crop.id}">Edit</button>
                        <button class="action-btn delete-btn" data-id="${crop.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            tbody.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cropId = this.getAttribute('data-id');
                    editCrop(cropId);
                });
            });
            
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cropId = this.getAttribute('data-id');
                    deleteCrop(cropId);
                });
            });
        }

        function editCrop(cropId) {
            // Find the crop
            const crop = userData.crops.find(c => c.id === cropId);
            if (!crop) return;
            
            // For simplicity, we'll just create a prompt to edit yield and status
            const newYield = prompt('Enter actual yield (kg per acre):', crop.actualYield || crop.expectedYield);
            if (newYield === null) return;
            
            const newStatus = prompt('Enter status (growing/harvested):', crop.status);
            if (newStatus === null) return;
            
            // Update crop
            crop.actualYield = parseFloat(newYield) || 0;
            crop.status = newStatus;
            
            if (newStatus === 'harvested' && !crop.harvestDate) {
                crop.harvestDate = new Date().toISOString().split('T')[0];
            }
            
            // Save and update
            saveUserData();
            updateCropsTable();
            updateDashboard();
            
            showSuccess('Crop updated successfully!');
        }

        function deleteCrop(cropId) {
            if (!confirm('Are you sure you want to delete this crop?')) return;
            
            // Remove crop
            userData.crops = userData.crops.filter(c => c.id !== cropId);
            
            // Save and update
            saveUserData();
            updateCropsTable();
            updateDashboard();
            
            showSuccess('Crop deleted successfully!');
        }

        function addExpense() {
            const amount = document.getElementById('expenseAmount').value;
            const date = document.getElementById('expenseDate').value;
            const cropId = document.getElementById('expenseCrop').value;
            const notes = document.getElementById('expenseNotes').value;
            
            if (!selectedExpense || !amount || !date) {
                showError('Please select a category and enter amount and date');
                return;
            }
            
            const expenseId = Date.now().toString();
            
            // Add expense to userData
            userData.expenses.push({
                id: expenseId,
                category: selectedExpense,
                amount: parseFloat(amount),
                date: date,
                cropId: cropId || null,
                notes: notes
            });
            
            // Save data
            saveUserData();
            
            // Update UI
            updateFinancialTable();
            updateDashboard();
            
            // Reset form
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').value = '';
            document.getElementById('expenseCrop').value = '';
            document.getElementById('expenseNotes').value = '';
            expenseItems.forEach(item => item.classList.remove('selected'));
            selectedExpense = '';
            
            showSuccess('Expense added successfully!');
        }

        function addIncome() {
            const source = document.getElementById('incomeSource').value;
            const amount = document.getElementById('incomeAmount').value;
            const date = document.getElementById('incomeDate').value;
            const cropId = document.getElementById('incomeCrop').value;
            const notes = document.getElementById('incomeNotes').value;
            
            if (!amount || !date) {
                showError('Please enter amount and date');
                return;
            }
            
            const incomeId = Date.now().toString();
            
            // Add income to userData
            userData.income.push({
                id: incomeId,
                source: source,
                amount: parseFloat(amount),
                date: date,
                cropId: cropId || null,
                notes: notes
            });
            
            // Save data
            saveUserData();
            
            // Update UI
            updateFinancialTable();
            updateDashboard();
            
            // Reset form
            document.getElementById('incomeAmount').value = '';
            document.getElementById('incomeDate').value = '';
            document.getElementById('incomeCrop').value = '';
            document.getElementById('incomeNotes').value = '';
            
            showSuccess('Income added successfully!');
        }

        function updateFinancialTable() {
            const tbody = financialTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            // Combine expenses and income
            const allTransactions = [
                ...userData.expenses.map(expense => ({ ...expense, type: 'expense' })),
                ...userData.income.map(income => ({ ...income, type: 'income' }))
            ];
            
            // Sort by date (newest first)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.type === 'expense' ? 'Expense' : 'Income'}</td>
                    <td>${transaction.type === 'expense' ? transaction.category : transaction.source}</td>
                    <td>${transaction.type === 'expense' ? '-₹' : '₹'}${transaction.amount.toLocaleString()}</td>
                    <td>${transaction.notes || '-'}</td>
                    <td>
                        <button class="action-btn delete-btn" data-type="${transaction.type}" data-id="${transaction.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    const id = this.getAttribute('data-id');
                    deleteFinancialRecord(type, id);
                });
            });
        }

        function deleteFinancialRecord(type, id) {
            if (!confirm('Are you sure you want to delete this record?')) return;
            
            if (type === 'expense') {
                userData.expenses = userData.expenses.filter(e => e.id !== id);
            } else {
                userData.income = userData.income.filter(i => i.id !== id);
            }
            
            // Save and update
            saveUserData();
            updateFinancialTable();
            updateDashboard();
            
            showSuccess('Record deleted successfully!');
        }

        function addFundingSource() {
            const fundingSource = document.createElement('div');
            fundingSource.className = 'funding-source';
            fundingSource.innerHTML = `
                <div class="funding-header">
                    <select class="form-control funding-type" style="max-width: 200px;">
                        <option value="own">Own Funds</option>
                        <option value="bank">Bank Loan</option>
                        <option value="family">Family/Friends Loan</option>
                        <option value="govt">Government Subsidy</option>
                        <option value="other">Other Source</option>
                    </select>
                    <span class="remove-btn">×</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount (₹)</label>
                        <input type="number" class="form-control funding-amount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label>Interest Rate (%)</label>
                        <input type="number" class="form-control funding-rate" placeholder="Enter rate" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label>Date Taken</label>
                    <input type="text" class="form-control funding-date" placeholder="Select date">
                </div>
            `;
            
            // Initialize date picker for the new funding source
            flatpickr(fundingSource.querySelector('.funding-date'), {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
            
            // Add event listener for the remove button
            fundingSource.querySelector('.remove-btn').addEventListener('click', function() {
                fundingSource.remove();
            });
            
            // Add event listener for funding type change
            fundingSource.querySelector('.funding-type').addEventListener('change', function() {
                const rateInput = fundingSource.querySelector('.funding-rate');
                if (this.value === 'own') {
                    rateInput.value = 0;
                    rateInput.disabled = true;
                } else {
                    rateInput.disabled = false;
                }
            });
            
            fundingSources.appendChild(fundingSource);
        }

        function addLivestock() {
            const type = document.getElementById('livestockType').value;
            const count = document.getElementById('livestockCount').value;
            const purchaseDate = document.getElementById('livestockPurchaseDate').value;
            const cost = document.getElementById('livestockCost').value;
            const notes = document.getElementById('livestockNotes').value;
            
            if (!count || !purchaseDate || !cost) {
                showError('Please fill all required fields');
                return;
            }
            
            const livestockId = Date.now().toString();
            
            // Add livestock to userData
            userData.livestock.push({
                id: livestockId,
                type: type,
                count: parseInt(count),
                purchaseDate: purchaseDate,
                cost: parseFloat(cost),
                notes: notes
            });
            
            // Save data
            saveUserData();
            
            // Update UI
            updateLivestockTable();
            
            // Reset form
            document.getElementById('livestockCount').value = '';
            document.getElementById('livestockPurchaseDate').value = '';
            document.getElementById('livestockCost').value = '';
            document.getElementById('livestockNotes').value = '';
            
            showSuccess('Livestock added successfully!');
        }

        function updateLivestockTable() {
            const tbody = livestockTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            userData.livestock.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.type}</td>
                    <td>${item.count}</td>
                    <td>${item.purchaseDate}</td>
                    <td>₹${item.cost.toLocaleString()}</td>
                    <td>
                        <button class="action-btn delete-btn" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteLivestock(id);
                });
            });
        }

        function deleteLivestock(id) {
            if (!confirm('Are you sure you want to delete this livestock record?')) return;
            
            // Remove livestock
            userData.livestock = userData.livestock.filter(l => l.id !== id);
            
            // Save and update
            saveUserData();
            updateLivestockTable();
            
            showSuccess('Livestock record deleted successfully!');
        }

        function addMachinery() {
            const type = document.getElementById('machineryType').value;
            const cost = document.getElementById('machineryCost').value;
            const purchaseDate = document.getElementById('machineryPurchaseDate').value;
            const maintenance = document.getElementById('machineryMaintenance').value;
            const notes = document.getElementById('machineryNotes').value;
            
            if (!cost || !purchaseDate) {
                showError('Please fill all required fields');
                return;
            }
            
            const machineryId = Date.now().toString();
            
            // Add machinery to userData
            userData.machinery.push({
                id: machineryId,
                type: type,
                cost: parseFloat(cost),
                purchaseDate: purchaseDate,
                maintenance: maintenance ? parseFloat(maintenance) : 0,
                notes: notes
            });
            
            // Save data
            saveUserData();
            
            // Update UI
            updateMachineryTable();
            
            // Reset form
            document.getElementById('machineryCost').value = '';
            document.getElementById('machineryPurchaseDate').value = '';
            document.getElementById('machineryMaintenance').value = '';
            document.getElementById('machineryNotes').value = '';
            
            showSuccess('Machinery added successfully!');
        }

        function updateMachineryTable() {
            const tbody = machineryTable.querySelector('tbody');
            tbody.innerHTML = '';
            
            userData.machinery.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.type}</td>
                    <td>₹${item.cost.toLocaleString()}</td>
                    <td>${item.purchaseDate}</td>
                    <td>₹${item.maintenance.toLocaleString()}/year</td>
                    <td>
                        <button class="action-btn delete-btn" data-id="${item.id}">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to delete buttons
            tbody.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    deleteMachinery(id);
                });
            });
        }

        function deleteMachinery(id) {
            if (!confirm('Are you sure you want to delete this machinery record?')) return;
            
            // Remove machinery
            userData.machinery = userData.machinery.filter(m => m.id !== id);
            
            // Save and update
            saveUserData();
            updateMachineryTable();
            
            showSuccess('Machinery record deleted successfully!');
        }

        function updateDashboard() {
            // Calculate financial summary
            const totalExpenses = userData.expenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalIncome = userData.income.reduce((sum, income) => sum + income.amount, 0);
            const netProfit = totalIncome - totalExpenses;
            
            // Update financial summary
            document.querySelector('.financial-item.income .financial-value').textContent = `₹${totalIncome.toLocaleString()}`;
            document.querySelector('.financial-item.expense .financial-value').textContent = `₹${totalExpenses.toLocaleString()}`;
            document.querySelector('.financial-item.profit .financial-value').textContent = `₹${netProfit.toLocaleString()}`;
            
            // Update active crops
            const activeCropsContainer = document.getElementById('activeCrops');
            const activeCrops = userData.crops.filter(crop => crop.status === 'growing');
            
            if (activeCrops.length === 0) {
                activeCropsContainer.innerHTML = '<p>No active crops. Add your first crop to get started.</p>';
            } else {
                activeCropsContainer.innerHTML = '';
                activeCrops.forEach(crop => {
                    const cropEl = document.createElement('div');
                    cropEl.className = 'crop-card';
                    cropEl.innerHTML = `
                        <h4>${crop.type}</h4>
                        <p>${crop.acres} acres | Sown on ${crop.sowingDate}</p>
                        <p>Expected yield: ${crop.expectedYield} kg/acre</p>
                    `;
                    activeCropsContainer.appendChild(cropEl);
                });
            }
            
            // Update recent activities
            const recentActivitiesContainer = document.getElementById('recentActivities');
            const allActivities = [
                ...userData.expenses.map(expense => ({
                    type: 'expense',
                    text: `Added expense of ₹${expense.amount} for ${expense.category}`,
                    date: expense.date
                })),
                ...userData.income.map(income => ({
                    type: 'income',
                    text: `Added income of ₹${income.amount} from ${income.source}`,
                    date: income.date
                })),
                ...userData.crops.map(crop => ({
                    type: 'crop',
                    text: `Added ${crop.type} crop on ${crop.acres} acres`,
                    date: crop.sowingDate
                }))
            ];
            
            // Sort by date (newest first)
            allActivities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allActivities.length === 0) {
                recentActivitiesContainer.innerHTML = '<p>No recent activities.</p>';
            } else {
                recentActivitiesContainer.innerHTML = '';
                const ul = document.createElement('ul');
                
                allActivities.slice(0, 5).forEach(activity => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <p>${activity.text}</p>
                        <small>${activity.date}</small>
                    `;
                    ul.appendChild(li);
                });
                
                recentActivitiesContainer.appendChild(ul);
            }
        }

        function logout() {
            auth.signOut().then(() => {
                // Show login container and hide app container
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
                
                // Reset login form
                changeStep(step2, step1);
                phoneNumberInput.value = '';
                otpInputs.forEach(input => input.value = '');
            });
        }

        // Initialize recaptcha
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sendOtpBtn', {
            size: 'invisible',
            callback: function(response) {
                // reCAPTCHA solved, allow signInWithPhoneNumber.
                sendOtp();
            }
        });
    </script>
</body>
</html>
