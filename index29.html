<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JamaApp - Smart Farm Management System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Other Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2E7D32;
            --secondary-color: #4CAF50;
            --accent-color: #FF6B35;
            --background-light: #F8FAFC;
            --background-dark: #1A1A1A;
            --text-primary: #1F2937;
            --text-secondary: #6B7280;
            --card-bg: #FFFFFF;
            --border-color: #E5E7EB;
            --success-color: #10B981;
            --warning-color: #F59E0B;
            --error-color: #EF4444;
            --info-color: #3B82F6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --border-radius: 16px;
            --border-radius-sm: 12px;
            --border-radius-xs: 8px;
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
        }

        [data-theme="dark"] {
            --background-light: #0F172A;
            --card-bg: #1E293B;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --border-color: #334155;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            background: var(--background-light);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Enhanced Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s ease;
        }

        .loading-logo {
            font-size: 4rem;
            font-weight: bold;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .loading-logo i {
            font-size: 4rem;
            animation: rotate 2s linear infinite;
        }

        .loading-progress {
            width: 300px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 2rem 0;
            position: relative;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fff, #a5d6a7);
            border-radius: 3px;
            animation: loading 3s ease-in-out forwards;
        }

        .loading-features {
            text-align: center;
            margin-top: 1rem;
        }

        .loading-feature {
            opacity: 0;
            animation: fadeInUp 0.6s ease forwards;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .loading-feature:nth-child(1) { animation-delay: 0.5s; }
        .loading-feature:nth-child(2) { animation-delay: 1s; }
        .loading-feature:nth-child(3) { animation-delay: 1.5s; }
        .loading-feature:nth-child(4) { animation-delay: 2s; }

        /* Language Selection Screen */
        .language-selection {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            text-align: center;
        }

        .language-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 3rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            max-width: 450px;
            width: 90%;
            animation: slideIn 0.5s ease;
        }

        .language-options {
            display: grid;
            gap: 1rem;
            margin-top: 2rem;
        }

        .language-option {
            padding: 1.2rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: white;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .language-option:hover {
            border-color: var(--primary-color);
            background: rgba(46, 125, 50, 0.05);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .language-flag {
            font-size: 2rem;
        }

        /* Enhanced Authentication */
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=1200&h=800&fit=crop&crop=center&auto=format&q=60') center/cover;
            opacity: 0.1;
            z-index: 0;
            animation: float 20s ease-in-out infinite;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 2.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
            z-index: 1;
            animation: slideIn 0.6s ease;
        }

        .auth-logo {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .auth-logo i {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: pulse 2s infinite;
        }

        .form-group {
            margin-bottom: 1.5rem;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
            transform: translateY(-1px);
        }

        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            font-family: inherit;
            min-height: 48px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--text-secondary);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .btn-error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
        }

        .btn-google {
            background: linear-gradient(135deg, #DB4437, #C23321);
            color: white;
            width: 100%;
            margin: 0.5rem 0;
        }

        .btn-phone {
            background: linear-gradient(135deg, #0084FF, #0066CC);
            color: white;
            width: 100%;
            margin: 0.5rem 0;
        }

        /* Enhanced App Layout */
        .app-container {
            display: none;
            min-height: 100vh;
        }

        .app-header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .app-logo {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-logo i {
            animation: rotate 10s linear infinite;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .language-selector select {
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-xs);
            padding: 0.5rem;
            color: var(--text-primary);
        }

        .theme-toggle, .profile-btn {
            background: none;
            border: 2px solid transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            min-width: 40px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover, .profile-btn:hover {
            background: rgba(46, 125, 50, 0.1);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .main-content {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Enhanced Sidebar */
        .sidebar {
            width: 280px;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-right: 1px solid var(--border-color);
            padding: 1rem 0;
            overflow-y: auto;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin: 0.25rem 0;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-right: 4px solid transparent;
            position: relative;
            font-weight: 500;
        }

        .sidebar-nav a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
            opacity: 0.1;
        }

        .sidebar-nav a:hover::before,
        .sidebar-nav a.active::before {
            width: 100%;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            color: var(--primary-color);
            background: rgba(46, 125, 50, 0.05);
            border-right-color: var(--primary-color);
            transform: translateX(8px);
        }

        .sidebar-nav i {
            margin-right: 1rem;
            width: 24px;
            text-align: center;
            font-size: 1.2rem;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        /* Enhanced Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        /* Enhanced Stat Cards */
        .stat-card {
            text-align: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,250,252,0.9));
            position: relative;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent, rgba(46, 125, 50, 0.02), transparent);
            pointer-events: none;
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.8;
            animation: float 3s ease-in-out infinite;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1rem 0;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success-color);
            background: rgba(16, 185, 129, 0.1);
        }

        .stat-change.negative {
            color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Enhanced Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, #74b9ff, #0984e3, #00cec9);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .weather-widget::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('https://images.unsplash.com/photo-1559827260-dc66d52bef19?w=800&h=600&fit=crop&auto=format&q=60') center/cover;
            opacity: 0.2;
            z-index: 0;
        }

        .weather-widget > * {
            position: relative;
            z-index: 1;
        }

        .weather-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        .weather-temp {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .weather-desc {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 1rem;
        }

        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        .weather-detail-item {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--border-radius-xs);
        }

        .rain-percentage {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            font-weight: bold;
            margin: 1rem 0;
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: var(--border-radius-sm);
        }

        .rain-bar {
            width: 120px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .rain-fill {
            height: 100%;
            background: linear-gradient(90deg, #00cec9, #74b9ff);
            border-radius: 4px;
            transition: width 0.3s ease;
            position: relative;
        }

        .rain-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Enhanced Crop Cards */
        .crop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 2rem;
        }

        .crop-card {
            position: relative;
            overflow: hidden;
            background: var(--card-bg);
            transition: all 0.3s ease;
        }

        .crop-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: var(--border-radius-sm);
            margin-bottom: 1rem;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .crop-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
        }

        .crop-variety {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 400;
        }

        .crop-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .crop-status.active {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
            color: var(--success-color);
        }

        .crop-status.harvested {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.2));
            color: var(--warning-color);
        }

        .crop-status.planned {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2));
            color: var(--info-color);
        }

        .crop-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            display: grid;
            gap: 0.5rem;
        }

        .crop-info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--border-radius-xs);
        }

        .crop-info i {
            color: var(--primary-color);
            width: 16px;
            text-align: center;
        }

        .crop-progress {
            margin: 1.5rem 0;
        }

        .crop-progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .progress {
            width: 100%;
            height: 12px;
            background: var(--border-color);
            border-radius: 6px;
            overflow: hidden;
            margin: 0.5rem 0;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.8s ease;
            border-radius: 6px;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        .crop-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--border-radius-sm);
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .crop-actions {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .crop-actions .btn {
            font-size: 0.85rem;
            padding: 0.75rem 0.5rem;
            min-height: 44px;
        }

        .transaction-quick-add {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .transaction-quick-add:hover {
            transform: scale(1.1) rotate(90deg);
            background: #ff5722;
            box-shadow: var(--shadow-lg);
        }

        .yield-per-acre {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
            padding: 1rem;
            border-radius: var(--border-radius-sm);
            margin: 1rem 0;
            border-left: 4px solid var(--success-color);
        }

        .yield-calculation {
            font-size: 0.9rem;
            color: var(--success-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Enhanced Transaction Cards */
        .transaction-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .transaction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
        }

        .transaction-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .transaction-type {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .transaction-type.income {
            color: var(--success-color);
        }

        .transaction-type.expense {
            color: var(--error-color);
        }

        .transaction-amount {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .transaction-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .transaction-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 0.5rem;
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--border-radius-xs);
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(46, 125, 50, 0.1);
            transition: all 0.2s ease;
        }

        .transaction-item:hover {
            background: rgba(46, 125, 50, 0.05);
            border-radius: var(--border-radius-xs);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        /* Enhanced Tables */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            box-shadow: var(--shadow);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.1));
            font-weight: 700;
            color: var(--primary-color);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .table tr:hover {
            background: rgba(46, 125, 50, 0.05);
        }

        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .bg-success {
            background: linear-gradient(135deg, var(--success-color), #059669);
            color: white;
        }

        .bg-error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .bg-warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
            color: white;
        }

        .bg-info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
            color: white;
        }

        /* Enhanced Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(8px);
            z-index: 2000;
            animation: fadeIn 0.3s ease;
            overflow-y: auto;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideIn 0.4s ease;
            box-shadow: var(--shadow-lg);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            background: var(--error-color);
            color: white;
            transform: scale(1.1);
        }

        /* Mobile Navigation */
        .mobile-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            padding: 1rem 0.5rem;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .mobile-nav-items {
            display: flex;
            justify-content: space-around;
            max-width: 500px;
            margin: 0 auto;
        }

        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.7rem;
            transition: all 0.3s ease;
            border-radius: var(--border-radius-xs);
            min-width: 60px;
            font-weight: 500;
        }

        .mobile-nav-item.active,
        .mobile-nav-item:hover {
            color: var(--primary-color);
            background: rgba(46, 125, 50, 0.1);
            transform: translateY(-2px);
        }

        .mobile-nav-item i {
            font-size: 1.4rem;
            margin-bottom: 0.25rem;
        }

        /* Enhanced Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 999;
        }

        .fab {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.4);
        }

        .fab-menu {
            position: absolute;
            bottom: 80px;
            right: 0;
            display: none;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        .fab-menu.active {
            display: flex;
            animation: fadeInUp 0.3s ease;
        }

        .fab-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--card-bg);
            padding: 0.75rem 1rem;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
            color: var(--text-primary);
            font-weight: 500;
            min-width: 180px;
            justify-content: flex-start;
        }

        .fab-action:hover {
            transform: translateX(-8px) scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        .fab-action i {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: white;
        }

        .fab-crop i {
            background: linear-gradient(135deg, #4CAF50, #66bb6a);
        }

        .fab-transaction i {
            background: linear-gradient(135deg, #FF6B35, #ff8a65);
        }

        .fab-asset i {
            background: linear-gradient(135deg, #2196F3, #64b5f6);
        }

        .fab-loan i {
            background: linear-gradient(135deg, #FF9800, #ffb74d);
        }

        .fab-weather i {
            background: linear-gradient(135deg, #00BCD4, #4dd0e1);
        }

        /* Enhanced Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius-sm);
            color: white;
            font-weight: 500;
            z-index: 3000;
            animation: slideInRight 0.4s ease;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #059669);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #d97706);
        }

        .notification.info {
            background: linear-gradient(135deg, var(--info-color), #2563eb);
        }

        .notification i {
            font-size: 1.2rem;
        }

        /* EMI Reminders */
        .reminder-card {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
            border: 2px solid var(--warning-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1rem 0;
            animation: pulse 2s infinite;
            position: relative;
            overflow: hidden;
        }

        .reminder-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        .reminder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .reminder-icon {
            font-size: 2rem;
            color: var(--warning-color);
        }

        .reminder-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--warning-color);
        }

        .reminder-days {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--error-color);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--text-secondary);
            opacity: 0.5;
            margin-bottom: 2rem;
        }

        .empty-state h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .empty-state p {
            max-width: 400px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }

        /* Auto-save Indicator */
        .auto-save-indicator {
            position: fixed;
            top: 90px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 0.9rem;
            opacity: 0;
            transform: translateY(-30px);
            transition: all 0.3s ease;
            z-index: 3000;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        .auto-save-indicator.saving {
            background: var(--warning-color);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .crop-grid {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 81px;
                height: calc(100vh - 81px);
                z-index: 999;
                transition: left 0.3s ease;
            }

            .sidebar.active {
                left: 0;
            }

            .mobile-nav {
                display: block;
            }

            .content-area {
                padding: 1rem;
                padding-bottom: 100px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .crop-grid {
                grid-template-columns: 1fr;
            }

            .fab-container {
                bottom: 120px;
            }

            .modal-content {
                margin: 0.5rem;
                padding: 1.5rem;
                max-width: 95%;
            }

            .crop-actions {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .crop-metrics {
                grid-template-columns: 1fr 1fr;
            }

            .auth-card {
                padding: 2rem 1.5rem;
                margin: 1rem;
            }

            .app-header {
                padding: 1rem;
            }

            .app-logo {
                font-size: 1.5rem;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .weather-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .transaction-details {
                grid-template-columns: 1fr;
            }

            .table th,
            .table td {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
            }

            .menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 40px;
                height: 40px;
                border: none;
                background: none;
                color: var(--text-primary);
                font-size: 1.2rem;
                cursor: pointer;
                border-radius: var(--border-radius-xs);
                transition: all 0.3s ease;
            }

            .menu-toggle:hover {
                background: rgba(46, 125, 50, 0.1);
            }

            .fab-menu {
                right: -10px;
            }

            .fab-action {
                min-width: 160px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .crop-metrics {
                grid-template-columns: 1fr;
            }

            .auth-card {
                padding: 1.5rem 1rem;
            }

            .form-control {
                padding: 0.75rem;
            }

            .btn {
                padding: 0.75rem 1rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .modal-content {
                padding: 1rem;
            }

            .language-card {
                padding: 2rem 1rem;
            }

            .fab {
                width: 56px;
                height: 56px;
                font-size: 1.3rem;
            }

            .fab-container {
                bottom: 110px;
                right: 16px;
            }

            .mobile-nav-items {
                padding: 0 0.5rem;
            }

            .mobile-nav-item {
                font-size: 0.65rem;
                min-width: 50px;
                padding: 0.4rem;
            }

            .mobile-nav-item i {
                font-size: 1.2rem;
            }
        }

        /* Animations */
        @keyframes loading {
            from { width: 0%; }
            to { width: 100%; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-left { text-align: left; }
        .text-success { color: var(--success-color) !important; }
        .text-warning { color: var(--warning-color) !important; }
        .text-error { color: var(--error-color) !important; }
        .text-info { color: var(--info-color) !important; }
        .text-primary { color: var(--primary-color) !important; }
        .text-secondary { color: var(--text-secondary) !important; }
        
        .mb-1 { margin-bottom: var(--spacing-xs) !important; }
        .mb-2 { margin-bottom: var(--spacing-sm) !important; }
        .mb-3 { margin-bottom: var(--spacing-md) !important; }
        .mb-4 { margin-bottom: var(--spacing-lg) !important; }
        .mt-1 { margin-top: var(--spacing-xs) !important; }
        .mt-2 { margin-top: var(--spacing-sm) !important; }
        .mt-3 { margin-top: var(--spacing-md) !important; }
        .mt-4 { margin-top: var(--spacing-lg) !important; }
        
        .p-1 { padding: var(--spacing-xs) !important; }
        .p-2 { padding: var(--spacing-sm) !important; }
        .p-3 { padding: var(--spacing-md) !important; }
        .p-4 { padding: var(--spacing-lg) !important; }
        
        .flex { display: flex !important; }
        .flex-center { display: flex !important; justify-content: center !important; align-items: center !important; }
        .flex-between { display: flex !important; justify-content: space-between !important; align-items: center !important; }
        .flex-column { flex-direction: column !important; }
        .flex-wrap { flex-wrap: wrap !important; }
        
        .grid { display: grid !important; }
        .grid-2 { grid-template-columns: 1fr 1fr !important; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr !important; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr !important; }
        
        .gap-1 { gap: var(--spacing-xs) !important; }
        .gap-2 { gap: var(--spacing-sm) !important; }
        .gap-3 { gap: var(--spacing-md) !important; }
        .gap-4 { gap: var(--spacing-lg) !important; }
        
        .w-full { width: 100% !important; }
        .h-full { height: 100% !important; }
        .hidden { display: none !important; }
        .block { display: block !important; }
        
        .rounded { border-radius: var(--border-radius-xs) !important; }
        .rounded-lg { border-radius: var(--border-radius) !important; }
        .rounded-full { border-radius: 50% !important; }
        
        .shadow { box-shadow: var(--shadow) !important; }
        .shadow-md { box-shadow: var(--shadow-md) !important; }
        .shadow-lg { box-shadow: var(--shadow-lg) !important; }
        
        .cursor-pointer { cursor: pointer !important; }
        .overflow-hidden { overflow: hidden !important; }
        .relative { position: relative !important; }
        .absolute { position: absolute !important; }
    </style>
</head>
<body>
    <!-- Auto-save indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">
        <i class="fas fa-check-circle"></i> 
        <span data-lang="auto-saved">Auto-saved</span>
    </div>

    <!-- Enhanced Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-logo">
            <i class="fas fa-seedling"></i>
            JamaApp
        </div>
        <div class="loading-features">
            <div class="loading-feature">
                <i class="fas fa-seedling"></i>
                <span data-lang="smart-crop">Smart Crop Management</span>
            </div>
            <div class="loading-feature">
                <i class="fas fa-coins"></i>
                <span data-lang="financial-tracking">Financial Tracking</span>
            </div>
            <div class="loading-feature">
                <i class="fas fa-cloud-sun"></i>
                <span data-lang="weather-intel">Weather Intelligence</span>
            </div>
            <div class="loading-feature">
                <i class="fas fa-chart-line"></i>
                <span data-lang="analytics">Advanced Analytics</span>
            </div>
        </div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
        <p data-lang="initializing">Initializing your smart farm dashboard...</p>
    </div>

    <!-- Language Selection Screen -->
    <div id="languageSelection" class="language-selection">
        <div class="language-card">
            <h2 style="color: var(--primary-color); margin-bottom: 1rem; font-size: 2rem;">
                <i class="fas fa-globe"></i> Choose Your Language
            </h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem; font-size: 1.1rem;">
                कृपया अपनी भाषा चुनें | దయచేసి మీ भाషను ఎంచుకోండి | Please choose your language
            </p>
            <div class="language-options">
                <div class="language-option" onclick="selectLanguage('en')">
                    <span class="language-flag">🇺🇸</span>
                    <div>
                        <div style="font-weight: bold; font-size: 1.1rem;">English</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">Continue in English</div>
                    </div>
                </div>
                <div class="language-option" onclick="selectLanguage('hi')">
                    <span class="language-flag">🇮🇳</span>
                    <div>
                        <div style="font-weight: bold; font-size: 1.1rem;">हिंदी</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">हिंदी में जारी रखें</div>
                    </div>
                </div>
                <div class="language-option" onclick="selectLanguage('te')">
                    <span class="language-flag">🇮🇳</span>
                    <div>
                        <div style="font-weight: bold; font-size: 1.1rem;">తెలుగు</div>
                        <div style="font-size: 0.9rem; opacity: 0.7;">తెలుగులో కొనసాగించండి</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-seedling"></i>
                JamaApp
            </div>
            <p style="margin-bottom: 2rem; color: var(--text-secondary); font-size: 1.1rem;" data-lang="tagline">
                Smart Farm Management System
            </p>
            
            <!-- Login Form -->
            <div id="loginForm">
                <form id="emailLoginForm">
                    <div class="form-group">
                        <label for="loginEmail" data-lang="email">Email Address</label>
                        <input type="email" id="loginEmail" class="form-control" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword" data-lang="password">Password</label>
                        <input type="password" id="loginPassword" class="form-control" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="btn btn-primary w-full" data-lang="sign-in">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </form>
                
                <div style="margin: 1.5rem 0; text-align: center; color: var(--text-secondary);" data-lang="or-continue">
                    or continue with
                </div>
                
                <button id="googleSignIn" class="btn btn-google">
                    <i class="fab fa-google"></i> 
                    <span data-lang="google-signin">Sign in with Google</span>
                </button>
                
                <button id="phoneSignIn" class="btn btn-phone">
                    <i class="fas fa-phone"></i> 
                    <span data-lang="phone-signin">Sign in with Phone</span>
                </button>
                
                <p style="margin-top: 1.5rem; text-align: center;">
                    <span data-lang="no-account">Don't have an account?</span>
                    <a href="#" id="showRegister" style="color: var(--primary-color); font-weight: 600; margin-left: 0.5rem;" data-lang="register-here">Register here</a>
                </p>
            </div>

            <!-- Registration Form -->
            <div id="registerForm" style="display: none;">
                <form id="emailRegisterForm">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="regFirstName" data-lang="first-name">First Name</label>
                            <input type="text" id="regFirstName" class="form-control" required placeholder="First name">
                        </div>
                        <div class="form-group">
                            <label for="regLastName" data-lang="last-name">Last Name</label>
                            <input type="text" id="regLastName" class="form-control" required placeholder="Last name">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="regEmail" data-lang="email">Email Address</label>
                        <input type="email" id="regEmail" class="form-control" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="regPassword" data-lang="password">Password</label>
                        <input type="password" id="regPassword" class="form-control" required placeholder="Create a password" minlength="6">
                    </div>
                    <div class="form-group">
                        <label for="regPhone" data-lang="phone">Phone Number</label>
                        <input type="tel" id="regPhone" class="form-control" required placeholder="+91 XXXXXXXXXX">
                    </div>
                    <div class="form-group">
                        <label for="regLocation" data-lang="location">Location</label>
                        <input type="text" id="regLocation" class="form-control" required placeholder="Your location">
                    </div>
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="regFarmSize" data-lang="farm-size">Farm Size (acres)</label>
                            <input type="number" id="regFarmSize" class="form-control" step="0.1" required placeholder="0.0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="regPrimaryCrop" data-lang="primary-crop">Primary Crop</label>
                            <select id="regPrimaryCrop" class="form-control" required>
                                <option value="" data-lang="select-crop">Select Primary Crop</option>
                                <option value="rice">🌾 Rice / चावल / వరి</option>
                                <option value="wheat">🌾 Wheat / गेहूं / గోధుమ</option>
                                <option value="corn">🌽 Corn / मक्का / మొక్కజొన్న</option>
                                <option value="cotton">🌿 Cotton / कपास / పత్తి</option>
                                <option value="sugarcane">🎋 Sugarcane / गन्ना / చెరకు</option>
                                <option value="pulses">🫘 Pulses / दाल / పప్పులు</option>
                                <option value="vegetables">🥕 Vegetables / सब्जी / కూరగాయలు</option>
                                <option value="fruits">🍎 Fruits / फल / పండ్లు</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-full" data-lang="create-account">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                
                <p style="margin-top: 1.5rem; text-align: center;">
                    <span data-lang="have-account">Already have an account?</span>
                    <a href="#" id="showLogin" style="color: var(--primary-color); font-weight: 600; margin-left: 0.5rem;" data-lang="signin-here">Sign in here</a>
                </p>
            </div>

            <!-- Phone OTP Form -->
            <div id="otpForm" style="display: none;">
                <div class="form-group">
                    <label for="phoneNumber" data-lang="phone">Phone Number</label>
                    <input type="tel" id="phoneNumber" class="form-control" placeholder="+91XXXXXXXXXX">
                </div>
                <button id="sendOTP" class="btn btn-primary w-full" data-lang="send-otp">
                    <i class="fas fa-paper-plane"></i> Send OTP
                </button>
                
                <div id="otpInput" style="display: none; margin-top: 1rem;">
                    <div class="form-group">
                        <label for="otpCode" data-lang="enter-otp">Enter 6-digit OTP</label>
                        <input type="text" id="otpCode" class="form-control" maxlength="6" placeholder="123456">
                    </div>
                    <div id="otpTimer" class="text-center" style="margin-bottom: 1rem; color: var(--text-secondary);"></div>
                    <button id="verifyOTP" class="btn btn-primary w-full" data-lang="verify-otp">
                        <i class="fas fa-check"></i> Verify OTP
                    </button>
                    <button id="resendOTP" class="btn btn-secondary w-full" style="margin-top: 0.5rem;" data-lang="resend-otp">
                        <i class="fas fa-redo"></i> Resend OTP
                    </button>
                </div>
                
                <p style="margin-top: 1rem; text-align: center;">
                    <a href="#" id="backToLogin" style="color: var(--primary-color);" data-lang="back-login">
                        <i class="fas fa-arrow-left"></i> Back to Login
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <!-- Enhanced Header -->
        <header class="app-header">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <button class="menu-toggle" id="menuToggle" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="app-logo">
                    <i class="fas fa-seedling"></i>
                    JamaApp
                </div>
            </div>
            <div class="header-actions">
                <div class="language-selector">
                    <select id="languageSelect" class="form-control">
                        <option value="en">🇺🇸 English</option>
                        <option value="hi">🇮🇳 हिंदी</option>
                        <option value="te">🇮🇳 తెలుగు</option>
                    </select>
                </div>
                <button class="theme-toggle" id="themeToggle" data-lang="toggle-theme">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="profile-btn" id="profileBtn" onclick="signOut()" data-lang="sign-out">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <div class="main-content">
            <!-- Enhanced Sidebar Navigation -->
            <nav class="sidebar" id="sidebar">
                <ul class="sidebar-nav">
                    <li><a href="#" onclick="showSection('dashboard')" class="active" id="nav-dashboard">
                        <i class="fas fa-tachometer-alt"></i> 
                        <span data-lang="dashboard">Dashboard</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('crops')" id="nav-crops">
                        <i class="fas fa-seedling"></i> 
                        <span data-lang="crop-mgmt">Crop Management</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('money')" id="nav-money">
                        <i class="fas fa-coins"></i> 
                        <span data-lang="financial-mgmt">Financial Management</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('assets')" id="nav-assets">
                        <i class="fas fa-tractor"></i> 
                        <span data-lang="asset-mgmt">Asset Management</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('loans')" id="nav-loans">
                        <i class="fas fa-hand-holding-usd"></i> 
                        <span data-lang="loans-emi">Loans & EMI</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('ideas')" id="nav-ideas">
                        <i class="fas fa-lightbulb"></i> 
                        <span data-lang="smart-ideas">Smart Ideas</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('weather')" id="nav-weather">
                        <i class="fas fa-cloud-sun"></i> 
                        <span data-lang="weather">Weather</span>
                    </a></li>
                    <li><a href="#" onclick="showSection('profile')" id="nav-profile">
                        <i class="fas fa-user-cog"></i> 
                        <span data-lang="profile">Profile & Settings</span>
                    </a></li>
                </ul>
            </nav>

            <!-- Enhanced Content Area -->
            <main class="content-area">
                <!-- Enhanced Dashboard Section -->
                <div id="dashboard" class="section">
                    <h1 style="margin-bottom: 2rem; color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-chart-line"></i> 
                        <span data-lang="farm-dashboard">Farm Dashboard</span>
                    </h1>

                    <!-- EMI Reminders -->
                    <div id="emiReminders" class="mb-4">
                        <!-- EMI reminders will be loaded here -->
                    </div>
                    
                    <div class="dashboard-grid">
                        <!-- Enhanced Financial Summary Cards -->
                        <div class="card stat-card">
                            <i class="fas fa-rupee-sign stat-icon text-success"></i>
                            <div class="stat-value" id="totalIncome">₹0</div>
                            <div class="stat-label" data-lang="total-income">Total Income</div>
                            <div class="stat-change positive" id="incomeChange">+0% <span data-lang="from-last-month">from last month</span></div>
                        </div>

                        <div class="card stat-card">
                            <i class="fas fa-credit-card stat-icon text-error"></i>
                            <div class="stat-value" id="totalExpenses">₹0</div>
                            <div class="stat-label" data-lang="total-expenses">Total Expenses</div>
                            <div class="stat-change negative" id="expenseChange">+0% <span data-lang="from-last-month">from last month</span></div>
                        </div>

                        <div class="card stat-card">
                            <i class="fas fa-chart-line stat-icon text-primary"></i>
                            <div class="stat-value" id="netProfit">₹0</div>
                            <div class="stat-label" data-lang="net-profit">Net Profit</div>
                            <div class="stat-change positive" id="profitChange">+0% <span data-lang="from-last-month">from last month</span></div>
                        </div>

                        <div class="card stat-card">
                            <i class="fas fa-hand-holding-usd stat-icon text-warning"></i>
                            <div class="stat-value" id="activeLoans">₹0</div>
                            <div class="stat-label" data-lang="active-loans">Active Loans</div>
                            <div class="stat-change neutral" id="loanChange">0 <span data-lang="active-loans-count">active loans</span></div>
                        </div>

                        <!-- Enhanced Weather Widget -->
                        <div class="card weather-widget" id="weatherWidget">
                            <div class="weather-icon" id="weatherIcon">
                                <i class="fas fa-sun"></i>
                            </div>
                            <div class="weather-temp" id="weatherTemp">--°C</div>
                            <div class="weather-desc" id="weatherDesc" data-lang="loading-weather">Loading weather...</div>
                            <div class="rain-percentage">
                                <i class="fas fa-cloud-rain"></i>
                                <span id="weatherRain">--%</span>
                                <div class="rain-bar">
                                    <div class="rain-fill" id="rainFill" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="weather-details">
                                <div class="weather-detail-item">
                                    <i class="fas fa-tint"></i>
                                    <span data-lang="humidity">Humidity:</span> <span id="weatherHumidity">--%</span>
                                </div>
                                <div class="weather-detail-item">
                                    <i class="fas fa-wind"></i>
                                    <span data-lang="wind">Wind:</span> <span id="weatherWind">-- km/h</span>
                                </div>
                                <div class="weather-detail-item">
                                    <i class="fas fa-sun"></i>
                                    <span>UV:</span> <span id="weatherUV">--</span>
                                </div>
                                <div class="weather-detail-item">
                                    <i class="fas fa-thermometer-half"></i>
                                    <span data-lang="feels">Feels:</span> <span id="weatherFeels">--°C</span>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Monthly Insights -->
                        <div class="card">
                            <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-lightbulb"></i> 
                                <span data-lang="insights">Monthly Insights</span>
                            </h3>
                            <div class="insights-grid" style="display: grid; gap: 1rem;">
                                <div class="insight-item" style="padding: 1rem; background: rgba(46, 125, 50, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="insight-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="best-crop">Best Performing Crop</div>
                                    <div class="insight-value text-success" style="font-size: 1.2rem; font-weight: bold;" id="bestCrop">Rice</div>
                                </div>
                                <div class="insight-item" style="padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="insight-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="top-expense">Top Expense</div>
                                    <div class="insight-value text-warning" style="font-size: 1.2rem; font-weight: bold;" id="highestExpense">Seeds</div>
                                </div>
                                <div class="insight-item" style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="insight-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="season-roi">Season ROI</div>
                                    <div class="insight-value" style="font-size: 1.2rem; font-weight: bold; color: #3b82f6;" id="roiSeason">15.2%</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="dashboard-grid">
                        <div class="card">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-bar"></i> 
                                <span data-lang="income-expense-chart">Income vs Expenses (Last 6 Months)</span>
                            </h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="incomeExpenseChart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-chart-pie"></i> 
                                <span data-lang="crop-profit-chart">Crop Profitability</span>
                            </h3>
                            <div class="chart-container" style="height: 350px;">
                                <canvas id="cropProfitChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Recent Notifications -->
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-bell"></i> 
                            <span data-lang="notifications">Recent Notifications</span>
                        </h3>
                        <div id="notificationsList" class="notifications-list">
                            <!-- Notifications will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Crop Management Section -->
                <div id="crops" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-seedling"></i> 
                            <span data-lang="crop-mgmt">Crop Management</span>
                        </h1>
                        <button class="btn btn-primary" onclick="showAddCropModal()">
                            <i class="fas fa-plus"></i> 
                            <span data-lang="add-crop">Add New Crop</span>
                        </button>
                    </div>

                    <!-- Crop Filters -->
                    <div class="card mb-3">
                        <div class="flex gap-2 flex-wrap">
                            <select id="cropStatusFilter" class="form-control" style="width: auto;" onchange="filterCrops()">
                                <option value="" data-lang="all-status">All Status</option>
                                <option value="active">🌱 <span data-lang="active">Active</span></option>
                                <option value="harvested">🌾 <span data-lang="harvested">Harvested</span></option>
                                <option value="planned">📅 <span data-lang="planned">Planned</span></option>
                            </select>
                            <select id="cropSeasonFilter" class="form-control" style="width: auto;" onchange="filterCrops()">
                                <option value="" data-lang="all-seasons">All Seasons</option>
                                <option value="kharif">🌧️ <span data-lang="kharif">Kharif</span></option>
                                <option value="rabi">❄️ <span data-lang="rabi">Rabi</span></option>
                                <option value="zaid">☀️ <span data-lang="zaid">Zaid</span></option>
                            </select>
                            <input type="text" id="cropSearchFilter" class="form-control" placeholder="🔍 Search crops..." style="width: auto; min-width: 200px;" oninput="filterCrops()">
                        </div>
                    </div>

                    <!-- Enhanced Crop Grid -->
                    <div id="cropGrid" class="crop-grid">
                        <!-- Crops will be loaded here -->
                    </div>
                </div>

                <!-- Enhanced Financial Management Section -->
                <div id="money" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-coins"></i> 
                            <span data-lang="financial-mgmt">Financial Management</span>
                        </h1>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="showAddTransactionModal()">
                                <i class="fas fa-plus"></i> 
                                <span data-lang="add-transaction">Add Transaction</span>
                            </button>
                            <button class="btn btn-secondary" onclick="showLoanCalculator()">
                                <i class="fas fa-calculator"></i> 
                                <span data-lang="loan-calc">Loan Calculator</span>
                            </button>
                        </div>
                    </div>

                    <!-- Financial Summary -->
                    <div class="dashboard-grid mb-3">
                        <div class="card stat-card">
                            <i class="fas fa-arrow-up stat-icon text-success"></i>
                            <div class="stat-value text-success" id="monthlyIncome">₹0</div>
                            <div class="stat-label" data-lang="month-income">This Month Income</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-arrow-down stat-icon text-error"></i>
                            <div class="stat-value text-error" id="monthlyExpenses">₹0</div>
                            <div class="stat-label" data-lang="month-expenses">This Month Expenses</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-balance-scale stat-icon text-primary"></i>
                            <div class="stat-value text-primary" id="monthlyProfit">₹0</div>
                            <div class="stat-label" data-lang="monthly-profit">Monthly Profit</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-exchange-alt stat-icon text-warning"></i>
                            <div class="stat-value text-warning" id="cashFlow">₹0</div>
                            <div class="stat-label" data-lang="cash-flow">Cash Flow</div>
                        </div>
                    </div>

                    <!-- Transaction Filters -->
                    <div class="card mb-3">
                        <div class="flex gap-2 flex-wrap">
                            <select id="transactionTypeFilter" class="form-control" style="width: auto;" onchange="filterTransactions()">
                                <option value="" data-lang="all-types">All Types</option>
                                <option value="income">💰 <span data-lang="income">Income</span></option>
                                <option value="expense">💳 <span data-lang="expense">Expense</span></option>
                            </select>
                            <select id="transactionCategoryFilter" class="form-control" style="width: auto;" onchange="filterTransactions()">
                                <option value="" data-lang="all-categories">All Categories</option>
                                <option value="crop-sale">🌾 <span data-lang="crop-sale">Crop Sale</span></option>
                                <option value="seeds">🌱 <span data-lang="seeds">Seeds</span></option>
                                <option value="fertilizers">🧪 <span data-lang="fertilizers">Fertilizers</span></option>
                                <option value="equipment">🚜 <span data-lang="equipment">Equipment</span></option>
                                <option value="labor">👨‍🌾 <span data-lang="labor">Labor</span></option>
                                <option value="loan">🏦 <span data-lang="loan">Loan</span></option>
                                <option value="other">📋 <span data-lang="other">Other</span></option>
                            </select>
                            <input type="text" id="transactionSearchFilter" class="form-control" placeholder="🔍 Search transactions..." style="width: auto; min-width: 200px;" oninput="filterTransactions()">
                        </div>
                    </div>

                    <!-- Transaction Chart -->
                    <div class="card mb-3">
                        <h3 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-chart-line"></i> 
                            <span data-lang="cash-flow-trend">Cash Flow Trend</span>
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="cashFlowChart"></canvas>
                        </div>
                    </div>

                    <!-- Recent Transactions Cards -->
                    <div id="recentTransactions" class="mb-4">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-clock"></i> 
                            <span data-lang="recent-trans">Recent Transactions</span>
                        </h3>
                        <div id="transactionCards" class="grid gap-2">
                            <!-- Transaction cards will be loaded here -->
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="card">
                        <div class="flex-between mb-3">
                            <h3 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-list"></i> 
                                <span data-lang="all-transactions">All Transactions</span>
                            </h3>
                            <button class="btn btn-secondary" onclick="showAllTransactions()">
                                <i class="fas fa-eye"></i> 
                                <span data-lang="view-all">View All</span>
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-calendar-alt"></i> <span data-lang="date">Date</span></th>
                                        <th><i class="fas fa-file-alt"></i> <span data-lang="description">Description</span></th>
                                        <th><i class="fas fa-tags"></i> <span data-lang="category">Category</span></th>
                                        <th><i class="fas fa-exchange-alt"></i> <span data-lang="type">Type</span></th>
                                        <th><i class="fas fa-rupee-sign"></i> <span data-lang="amount">Amount</span></th>
                                        <th><i class="fas fa-cogs"></i> <span data-lang="actions">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTableBody">
                                    <!-- Transactions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Asset Management Section -->
                <div id="assets" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-tractor"></i> 
                            <span data-lang="asset-mgmt">Asset Management</span>
                        </h1>
                        <button class="btn btn-primary" onclick="showAddAssetModal()">
                            <i class="fas fa-plus"></i> 
                            <span data-lang="add-asset">Add Asset</span>
                        </button>
                    </div>

                    <!-- Asset Categories -->
                    <div class="dashboard-grid mb-3">
                        <div class="card text-center cursor-pointer" onclick="filterAssets('equipment')">
                            <i class="fas fa-tractor text-primary stat-icon"></i>
                            <h3 data-lang="equipment">Equipment</h3>
                            <p class="text-secondary" id="equipmentCount">0 <span data-lang="items">items</span></p>
                        </div>
                        <div class="card text-center cursor-pointer" onclick="filterAssets('livestock')">
                            <i class="fas fa-horse text-primary stat-icon"></i>
                            <h3 data-lang="livestock">Livestock</h3>
                            <p class="text-secondary" id="livestockCount">0 <span data-lang="items">items</span></p>
                        </div>
                        <div class="card text-center cursor-pointer" onclick="filterAssets('land')">
                            <i class="fas fa-map text-primary stat-icon"></i>
                            <h3 data-lang="land">Land</h3>
                            <p class="text-secondary" id="landCount">0 <span data-lang="plots">plots</span></p>
                        </div>
                        <div class="card text-center cursor-pointer" onclick="filterAssets('inventory')">
                            <i class="fas fa-boxes text-primary stat-icon"></i>
                            <h3 data-lang="inventory">Inventory</h3>
                            <p class="text-secondary" id="inventoryCount">0 <span data-lang="items">items</span></p>
                        </div>
                    </div>

                    <!-- Asset List -->
                    <div id="assetsList" class="crop-grid">
                        <!-- Assets will be loaded here -->
                    </div>
                </div>

                <!-- Enhanced Loans & EMI Section -->
                <div id="loans" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-hand-holding-usd"></i> 
                            <span data-lang="loans-emi">Loans & EMI Management</span>
                        </h1>
                        <div class="flex gap-2">
                            <button class="btn btn-primary" onclick="showAddLoanModal()">
                                <i class="fas fa-plus"></i> 
                                <span data-lang="add-loan">Add Loan</span>
                            </button>
                            <button class="btn btn-secondary" onclick="showLoanCalculator()">
                                <i class="fas fa-calculator"></i> 
                                <span data-lang="calculate">Calculate EMI</span>
                            </button>
                        </div>
                    </div>

                    <!-- Loan Summary -->
                    <div class="dashboard-grid mb-4">
                        <div class="card stat-card">
                            <i class="fas fa-money-bill-wave stat-icon text-error"></i>
                            <div class="stat-value text-error" id="totalLoanAmount">₹0</div>
                            <div class="stat-label" data-lang="total-loan">Total Loan Amount</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-calendar-check stat-icon text-warning"></i>
                            <div class="stat-value text-warning" id="monthlyEMITotal">₹0</div>
                            <div class="stat-label" data-lang="monthly-emi">Monthly EMI</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-clock stat-icon text-info"></i>
                            <div class="stat-value text-info" id="upcomingEMI">₹0</div>
                            <div class="stat-label" data-lang="upcoming-emi">Upcoming EMI</div>
                        </div>
                        <div class="card stat-card">
                            <i class="fas fa-exclamation-triangle stat-icon text-error"></i>
                            <div class="stat-value text-error" id="overdueEMI">₹0</div>
                            <div class="stat-label" data-lang="overdue-emi">Overdue EMI</div>
                        </div>
                    </div>

                    <!-- EMI Calendar/Reminders -->
                    <div class="card mb-4">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-alt"></i> 
                            <span data-lang="emi-calendar">EMI Calendar</span>
                        </h3>
                        <div id="emiCalendar" class="emi-calendar">
                            <!-- EMI calendar will be loaded here -->
                        </div>
                    </div>

                    <!-- Active Loans -->
                    <div class="card">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-list"></i> 
                            <span data-lang="active-loans-list">Active Loans</span>
                        </h3>
                        <div id="loansList" class="loans-list">
                            <!-- Loans will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Enhanced Smart Ideas Section -->
                <div id="ideas" class="section hidden">
                    <div class="flex-between mb-4">
                        <h1 style="color: var(--primary-color); display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-lightbulb"></i> 
                            <span data-lang="smart-ideas">Smart Farming Ideas</span>
                        </h1>
                        <button class="btn btn-primary" onclick="refreshIdeas()">
                            <i class="fas fa-sync-alt"></i> 
                            <span data-lang="refresh">Refresh Ideas</span>
                        </button>
                    </div>

                    <!-- Ideas Categories -->
                    <div class="card mb-3">
                        <div class="flex gap-2 flex-wrap">
                            <button class="btn btn-secondary active" onclick="filterIdeas('all')">
                                🌟 <span data-lang="all-ideas">All Ideas</span>
                            </button>
                            <button class="btn btn-secondary" onclick="filterIdeas('crop')">
                                🌱 <span data-lang="crop">Crop</span>
                            </button>
                            <button class="btn btn-secondary" onclick="filterIdeas('financial')">
                                💰 <span data-lang="financial">Financial</span>
                            </button>
                            <button class="btn btn-secondary" onclick="filterIdeas('technology')">
                                🔧 <span data-lang="technology">Technology</span>
                            </button>
                            <button class="btn btn-secondary" onclick="filterIdeas('market')">
                                📊 <span data-lang="market">Market</span>
                            </button>
                        </div>
                    </div>

                    <!-- Ideas Grid -->
                    <div id="ideasGrid" class="crop-grid">
                        <!-- Ideas will be loaded here -->
                    </div>
                </div>

                <!-- Enhanced Weather Section -->
                <div id="weather" class="section hidden">
                    <h1 style="color: var(--primary-color); margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-cloud-sun"></i> 
                        <span data-lang="weather-info">Weather Information</span>
                    </h1>
                    
                    <!-- Location Input -->
                    <div class="card mb-3">
                        <div class="flex gap-2">
                            <input type="text" id="weatherLocation" class="form-control" placeholder="🌍 Enter location (e.g., Delhi, India)">
                            <button class="btn btn-primary" onclick="getWeatherByLocation()">
                                <i class="fas fa-search"></i> 
                                <span data-lang="get-weather">Get Weather</span>
                            </button>
                            <button class="btn btn-secondary" onclick="getCurrentLocationWeather()">
                                <i class="fas fa-location-arrow"></i> 
                                <span data-lang="current-location">Current Location</span>
                            </button>
                        </div>
                    </div>

                    <!-- Current Weather -->
                    <div class="dashboard-grid mb-3">
                        <div class="card weather-widget">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-thermometer-half"></i> 
                                <span data-lang="current-weather">Current Weather</span>
                            </h3>
                            <div id="currentWeatherLocation" style="font-size: 1.1rem; margin-bottom: 0.5rem; opacity: 0.9;">--</div>
                            <div class="weather-icon">
                                <i id="currentWeatherIcon" class="fas fa-sun"></i>
                            </div>
                            <div class="weather-temp" id="currentTemp">--°C</div>
                            <div class="weather-desc" id="currentDesc">--</div>
                            <div class="weather-details">
                                <div><span data-lang="feels-like">Feels like:</span> <span id="feelsLike">--°C</span></div>
                                <div><span data-lang="humidity">Humidity:</span> <span id="currentHumidity">--%</span></div>
                                <div><span data-lang="wind">Wind:</span> <span id="currentWind">-- km/h</span></div>
                                <div><span data-lang="pressure">Pressure:</span> <span id="currentPressure">-- hPa</span></div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-seedling"></i> 
                                <span data-lang="agri-conditions">Agricultural Conditions</span>
                            </h3>
                            <div class="weather-details">
                                <div>☀️ UV Index: <span id="uvIndex" class="text-warning">--</span></div>
                                <div>🌡️ <span data-lang="soil-temp">Soil Temp:</span> <span id="soilTemp">--°C</span></div>
                                <div>🌧️ <span data-lang="rain-chance">Rain Chance:</span>
                                    <span id="rainChance" class="text-primary">--%</span>
                                    <div class="rain-bar" style="margin-top: 0.25rem;">
                                        <div class="rain-fill" id="rainChanceFill" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div>👁️ <span data-lang="visibility">Visibility:</span> <span id="visibility">-- km</span></div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <span data-lang="farming-alerts">Farming Alerts</span>
                            </h3>
                            <div id="farmingAlerts" class="farming-alerts">
                                <!-- Alerts will be populated here -->
                            </div>
                        </div>
                    </div>

                    <!-- 5-Day Forecast -->
                    <div class="card mb-3">
                        <h3 style="margin-bottom: 1rem;">
                            <i class="fas fa-calendar-week"></i> 
                            <span data-lang="forecast">5-Day Forecast</span>
                        </h3>
                        <div id="weatherForecast" class="weather-forecast grid gap-2" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                            <!-- Forecast will be populated here -->
                        </div>
                    </div>

                    <!-- Hourly Forecast Chart -->
                    <div class="card">
                        <h3 style="margin-bottom: 1rem;">
                            <i class="fas fa-chart-line"></i> 
                            <span data-lang="hourly-forecast">24-Hour Temperature & Rain Trend</span>
                        </h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="temperatureChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Profile & Settings Section -->
                <div id="profile" class="section hidden">
                    <h1 style="color: var(--primary-color); margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-user-cog"></i> 
                        <span data-lang="profile-settings">Profile & Settings</span>
                    </h1>
                    
                    <div class="dashboard-grid">
                        <!-- Profile Information -->
                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-user"></i> 
                                <span data-lang="profile-info">Profile Information</span>
                            </h3>
                            <form id="profileForm">
                                <div class="form-group">
                                    <label for="profileName" data-lang="full-name">Full Name</label>
                                    <input type="text" id="profileName" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="profileEmail" data-lang="email">Email</label>
                                    <input type="email" id="profileEmail" class="form-control" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="profilePhone" data-lang="phone">Phone</label>
                                    <input type="tel" id="profilePhone" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="profileLocation" data-lang="location">Location</label>
                                    <input type="text" id="profileLocation" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="profileFarmSize" data-lang="farm-size">Farm Size (acres)</label>
                                    <input type="number" id="profileFarmSize" class="form-control" step="0.1">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 
                                    <span data-lang="update-profile">Update Profile</span>
                                </button>
                            </form>
                        </div>

                        <!-- Farm Statistics -->
                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-chart-bar"></i> 
                                <span data-lang="farm-stats">Farm Statistics</span>
                            </h3>
                            <div class="stats-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="stat-item" style="text-align: center; padding: 1rem; background: rgba(46, 125, 50, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="total-crops">Total Crops</div>
                                    <div class="stat-value" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="statTotalCrops">0</div>
                                </div>
                                <div class="stat-item" style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="active-crops">Active Crops</div>
                                    <div class="stat-value" style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);" id="statActiveCrops">0</div>
                                </div>
                                <div class="stat-item" style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="transactions">Transactions</div>
                                    <div class="stat-value" style="font-size: 1.5rem; font-weight: bold; color: var(--warning-color);" id="statTotalTransactions">0</div>
                                </div>
                                <div class="stat-item" style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: var(--border-radius-sm);">
                                    <div class="stat-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="assets">Assets</div>
                                    <div class="stat-value" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="statTotalAssets">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- App Settings -->
                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-cog"></i> 
                                <span data-lang="app-settings">App Settings</span>
                            </h3>
                            <div class="form-group">
                                <label data-lang="theme">Theme</label>
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary" onclick="setTheme('light')">
                                        <i class="fas fa-sun"></i> 
                                        <span data-lang="light">Light</span>
                                    </button>
                                    <button class="btn btn-secondary" onclick="setTheme('dark')">
                                        <i class="fas fa-moon"></i> 
                                        <span data-lang="dark">Dark</span>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="settingsLanguage" data-lang="language">Language</label>
                                <select id="settingsLanguage" class="form-control" onchange="changeLanguage(this.value)">
                                    <option value="en">🇺🇸 English</option>
                                    <option value="hi">🇮🇳 हिंदी</option>
                                    <option value="te">🇮🇳 తెలుగు</option>
                                </select>
                            </div>
                        </div>

                        <!-- Data Management -->
                        <div class="card">
                            <h3 style="margin-bottom: 1rem;">
                                <i class="fas fa-database"></i> 
                                <span data-lang="data-mgmt">Data Management</span>
                            </h3>
                            <div class="flex-column gap-2">
                                <button class="btn btn-primary" onclick="exportAllData()">
                                    <i class="fas fa-download"></i> 
                                    <span data-lang="export-data">Export All Data (PDF)</span>
                                </button>
                                <button class="btn btn-secondary" onclick="backupData()">
                                    <i class="fas fa-cloud-upload-alt"></i> 
                                    <span data-lang="backup-cloud">Backup to Cloud</span>
                                </button>
                                <button class="btn btn-error" onclick="clearAllData()">
                                    <i class="fas fa-trash"></i> 
                                    <span data-lang="clear-data">Clear All Data</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Enhanced Mobile Navigation -->
        <nav class="mobile-nav">
            <div class="mobile-nav-items">
                <a href="#" onclick="showSection('dashboard')" class="mobile-nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span data-lang="dashboard">Dashboard</span>
                </a>
                <a href="#" onclick="showSection('crops')" class="mobile-nav-item">
                    <i class="fas fa-seedling"></i>
                    <span data-lang="crops">Crops</span>
                </a>
                <a href="#" onclick="showSection('money')" class="mobile-nav-item">
                    <i class="fas fa-coins"></i>
                    <span data-lang="money">Money</span>
                </a>
                <a href="#" onclick="showSection('loans')" class="mobile-nav-item">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span data-lang="loans">Loans</span>
                </a>
                <a href="#" onclick="showSection('profile')" class="mobile-nav-item">
                    <i class="fas fa-user"></i>
                    <span data-lang="profile">Profile</span>
                </a>
            </div>
        </nav>

        <!-- Enhanced Floating Action Button -->
        <div class="fab-container">
            <div class="fab-menu" id="fabMenu">
                <button class="fab-action fab-crop" onclick="showAddCropModal(); toggleFabMenu();">
                    <i class="fas fa-seedling"></i>
                    <span data-lang="add-crop">Add Crop</span>
                </button>
                <button class="fab-action fab-transaction" onclick="showAddTransactionModal(); toggleFabMenu();">
                    <i class="fas fa-coins"></i>
                    <span data-lang="add-transaction">Add Transaction</span>
                </button>
                <button class="fab-action fab-asset" onclick="showAddAssetModal(); toggleFabMenu();">
                    <i class="fas fa-tractor"></i>
                    <span data-lang="add-asset">Add Asset</span>
                </button>
                <button class="fab-action fab-loan" onclick="showAddLoanModal(); toggleFabMenu();">
                    <i class="fas fa-hand-holding-usd"></i>
                    <span data-lang="add-loan">Add Loan</span>
                </button>
                <button class="fab-action fab-weather" onclick="showSection('weather'); toggleFabMenu();">
                    <i class="fas fa-cloud-sun"></i>
                    <span data-lang="check-weather">Check Weather</span>
                </button>
            </div>
            <button class="fab" id="fabButton" onclick="toggleFabMenu()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Enhanced Modals -->
    <!-- Add Crop Modal -->
    <div id="addCropModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-seedling"></i> 
                    <span data-lang="add-crop">Add New Crop</span>
                </h2>
                <button class="close-modal" onclick="closeModal('addCropModal')">&times;</button>
            </div>
            <form id="addCropForm">
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="cropName" data-lang="crop-name">Crop Name</label>
                        <select id="cropName" class="form-control" required>
                            <option value="" data-lang="select-crop">Select Crop</option>
                            <option value="rice">🌾 Rice / चावल / వరి</option>
                            <option value="wheat">🌾 Wheat / गेहूं / గోధుమ</option>
                            <option value="corn">🌽 Corn / मक्का / మొక్కజొన్న</option>
                            <option value="cotton">🌿 Cotton / कपास / పత్తి</option>
                            <option value="sugarcane">🎋 Sugarcane / गन्ना / చెరకు</option>
                            <option value="pulses">🫘 Pulses / दाल / పప్పులు</option>
                            <option value="vegetables">🥕 Vegetables / सब्जी / కూరగాయలు</option>
                            <option value="fruits">🍎 Fruits / फल / పండ్లు</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cropVariety" data-lang="variety">Variety</label>
                        <input type="text" id="cropVariety" class="form-control" placeholder="e.g., Basmati, Hybrid">
                    </div>
                </div>
                <div class="grid grid-3 gap-2">
                    <div class="form-group">
                        <label for="cropArea" data-lang="area">Area (acres)</label>
                        <input type="number" id="cropArea" class="form-control" step="0.1" required placeholder="0.0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="cropSeason" data-lang="season">Season</label>
                        <select id="cropSeason" class="form-control" required>
                            <option value="" data-lang="select-season">Select Season</option>
                            <option value="kharif">🌧️ Kharif (Jun-Oct)</option>
                            <option value="rabi">❄️ Rabi (Nov-Apr)</option>
                            <option value="zaid">☀️ Zaid (May-Jun)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cropLocation" data-lang="location">Location</label>
                        <input type="text" id="cropLocation" class="form-control" placeholder="Field location">
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="sowingDate" data-lang="sowing-date">Sowing Date</label>
                        <input type="date" id="sowingDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="expectedHarvest" data-lang="harvest-date">Expected Harvest Date</label>
                        <input type="date" id="expectedHarvest" class="form-control" required>
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="expectedYield" data-lang="expected-yield">Expected Yield (tons)</label>
                        <input type="number" id="expectedYield" class="form-control" step="0.1" placeholder="0.0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="expectedPrice" data-lang="expected-price">Expected Price (₹/ton)</label>
                        <input type="number" id="expectedPrice" class="form-control" placeholder="0" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="cropNotes" data-lang="notes">Notes</label>
                    <textarea id="cropNotes" class="form-control" rows="3" placeholder="Additional notes about this crop..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        <span data-lang="add-crop">Add Crop</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCropModal')">
                        <i class="fas fa-times"></i> 
                        <span data-lang="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-circle"></i> 
                    <span data-lang="add-transaction">Add Transaction</span>
                </h2>
                <button class="close-modal" onclick="closeModal('addTransactionModal')">&times;</button>
            </div>
            <form id="addTransactionForm">
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="transactionType" data-lang="type">Type</label>
                        <select id="transactionType" class="form-control" required onchange="updateTransactionCategories()">
                            <option value="" data-lang="select-type">Select Type</option>
                            <option value="income">💰 <span data-lang="income">Income</span></option>
                            <option value="expense">💳 <span data-lang="expense">Expense</span></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transactionCategory" data-lang="category">Category</label>
                        <select id="transactionCategory" class="form-control" required>
                            <option value="" data-lang="select-category">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transactionDescription" data-lang="description">Description</label>
                    <input type="text" id="transactionDescription" class="form-control" required placeholder="Brief description">
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="transactionAmount" data-lang="amount">Amount (₹)</label>
                        <input type="number" id="transactionAmount" class="form-control" step="0.01" required placeholder="0.00" min="0">
                    </div>
                    <div class="form-group">
                        <label for="transactionDate" data-lang="date">Date</label>
                        <input type="date" id="transactionDate" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="transactionPaymentMethod" data-lang="payment-method">Payment Method</label>
                    <select id="transactionPaymentMethod" class="form-control">
                        <option value="cash">💵 <span data-lang="cash">Cash</span></option>
                        <option value="bank_transfer">🏦 <span data-lang="bank-transfer">Bank Transfer</span></option>
                        <option value="check">📄 <span data-lang="check">Check</span></option>
                        <option value="digital">📱 <span data-lang="digital">Digital Payment</span></option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionCropId" data-lang="related-crop">Related Crop (optional)</label>
                    <select id="transactionCropId" class="form-control">
                        <option value="" data-lang="select-crop">Select Crop</option>
                        <!-- Crops will be loaded dynamically -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionNotes" data-lang="notes">Notes</label>
                    <textarea id="transactionNotes" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        <span data-lang="add-transaction">Add Transaction</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addTransactionModal')">
                        <i class="fas fa-times"></i> 
                        <span data-lang="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Loan Modal -->
    <div id="addLoanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-hand-holding-usd"></i> 
                    <span data-lang="add-loan">Add Loan</span>
                </h2>
                <button class="close-modal" onclick="closeModal('addLoanModal')">&times;</button>
            </div>
            <form id="addLoanForm">
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="loanProvider" data-lang="loan-provider">Loan Provider</label>
                        <input type="text" id="loanProvider" class="form-control" required placeholder="Bank/Institution name">
                    </div>
                    <div class="form-group">
                        <label for="loanType" data-lang="loan-type">Loan Type</label>
                        <select id="loanType" class="form-control" required>
                            <option value="">Select Loan Type</option>
                            <option value="crop-loan">🌾 Crop Loan</option>
                            <option value="equipment-loan">🚜 Equipment Loan</option>
                            <option value="personal-loan">👤 Personal Loan</option>
                            <option value="kcc">💳 Kisan Credit Card</option>
                            <option value="other">📋 Other</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-3 gap-2">
                    <div class="form-group">
                        <label for="loanAmount" data-lang="loan-amount">Loan Amount (₹)</label>
                        <input type="number" id="loanAmount" class="form-control" required step="1000" placeholder="100000" min="0">
                    </div>
                    <div class="form-group">
                        <label for="interestRate" data-lang="interest-rate">Interest Rate (%)</label>
                        <input type="number" id="interestRate" class="form-control" required step="0.1" placeholder="12.0" min="0">
                    </div>
                    <div class="form-group">
                        <label for="loanTenure" data-lang="tenure">Tenure (months)</label>
                        <input type="number" id="loanTenure" class="form-control" required placeholder="12" min="1">
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="loanStartDate" data-lang="start-date">Loan Start Date</label>
                        <input type="date" id="loanStartDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="emiDate" data-lang="emi-date">EMI Due Date (day of month)</label>
                        <input type="number" id="emiDate" class="form-control" required min="1" max="31" placeholder="15">
                    </div>
                </div>
                <div class="form-group">
                    <label for="loanPurpose" data-lang="purpose">Loan Purpose</label>
                    <textarea id="loanPurpose" class="form-control" rows="2" placeholder="Purpose of the loan..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        <span data-lang="add-loan">Add Loan</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addLoanModal')">
                        <i class="fas fa-times"></i> 
                        <span data-lang="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loan Calculator Modal -->
    <div id="loanCalculatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-calculator"></i> 
                    <span data-lang="loan-calc">Loan Calculator</span>
                </h2>
                <button class="close-modal" onclick="closeModal('loanCalculatorModal')">&times;</button>
            </div>
            <div class="grid grid-2 gap-4">
                <div>
                    <h3 style="margin-bottom: 1rem;">
                        📋 <span data-lang="loan-details">Loan Details</span>
                    </h3>
                    <div class="form-group">
                        <label for="calcLoanAmount" data-lang="loan-amount">Principal Amount (₹)</label>
                        <input type="number" id="calcLoanAmount" class="form-control" oninput="calculateLoan()" placeholder="100000">
                    </div>
                    <div class="form-group">
                        <label for="calcInterestRate" data-lang="interest-rate">Interest Rate (%)</label>
                        <input type="number" id="calcInterestRate" class="form-control" step="0.1" oninput="calculateLoan()" placeholder="12.0">
                    </div>
                    <div class="form-group">
                        <label for="calcLoanTerm" data-lang="tenure">Term (months)</label>
                        <input type="number" id="calcLoanTerm" class="form-control" oninput="calculateLoan()" placeholder="12">
                    </div>
                    <div class="form-group">
                        <label for="calcLoanType" data-lang="interest-type">Interest Type</label>
                        <select id="calcLoanType" class="form-control" onchange="calculateLoan()">
                            <option value="compound">Compound</option>
                            <option value="simple">Simple</option>
                        </select>
                    </div>
                </div>
                <div>
                    <h3 style="margin-bottom: 1rem;">
                        📊 <span data-lang="calc-results">Calculation Results</span>
                    </h3>
                    <div class="loan-results" style="display: grid; gap: 1rem;">
                        <div class="result-item" style="padding: 1rem; background: rgba(46, 125, 50, 0.05); border-radius: var(--border-radius-sm); text-align: center;">
                            <div class="result-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="monthly-emi">Monthly EMI</div>
                            <div class="result-value" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" id="calcMonthlyEMI">₹0</div>
                        </div>
                        <div class="result-item" style="padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: var(--border-radius-sm); text-align: center;">
                            <div class="result-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="total-interest">Total Interest</div>
                            <div class="result-value" style="font-size: 1.5rem; font-weight: bold; color: var(--warning-color);" id="calcTotalInterest">₹0</div>
                        </div>
                        <div class="result-item" style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: var(--border-radius-sm); text-align: center;">
                            <div class="result-label" style="font-size: 0.9rem; color: var(--text-secondary);" data-lang="total-amount">Total Amount</div>
                            <div class="result-value" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="calcTotalAmount">₹0</div>
                        </div>
                    </div>
                    <button class="btn btn-primary w-full" style="margin-top: 1rem;" onclick="saveLoanFromCalculator()">
                        <i class="fas fa-save"></i> 
                        <span data-lang="save-loan">Save as Loan</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div id="addAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-plus-square"></i> 
                    <span data-lang="add-asset">Add Asset</span>
                </h2>
                <button class="close-modal" onclick="closeModal('addAssetModal')">&times;</button>
            </div>
            <form id="addAssetForm">
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="assetType" data-lang="asset-type">Asset Type</label>
                        <select id="assetType" class="form-control" required onchange="updateAssetFields()">
                            <option value="" data-lang="select-type">Select Type</option>
                            <option value="equipment">🚜 <span data-lang="equipment">Equipment</span></option>
                            <option value="livestock">🐄 <span data-lang="livestock">Livestock</span></option>
                            <option value="land">🌾 <span data-lang="land">Land</span></option>
                            <option value="inventory">📦 <span data-lang="inventory">Inventory</span></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="assetName" data-lang="name">Name</label>
                        <input type="text" id="assetName" class="form-control" required placeholder="Asset name">
                    </div>
                </div>
                <div class="grid grid-2 gap-2">
                    <div class="form-group">
                        <label for="assetPurchaseDate" data-lang="purchase-date">Purchase Date</label>
                        <input type="date" id="assetPurchaseDate" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="assetPurchasePrice" data-lang="purchase-price">Purchase Price (₹)</label>
                        <input type="number" id="assetPurchasePrice" class="form-control" step="0.01" placeholder="0.00" min="0">
                    </div>
                </div>
                <div id="equipmentFields" class="hidden">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="equipmentCondition" data-lang="condition">Condition</label>
                            <select id="equipmentCondition" class="form-control">
                                <option value="excellent">⭐ Excellent</option>
                                <option value="good">👍 Good</option>
                                <option value="fair">🆗 Fair</option>
                                <option value="poor">👎 Poor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="equipmentMaintenanceCost" data-lang="maintenance">Annual Maintenance (₹)</label>
                            <input type="number" id="equipmentMaintenanceCost" class="form-control" step="0.01" placeholder="0.00" min="0">
                        </div>
                    </div>
                </div>
                <div id="livestockFields" class="hidden">
                    <div class="grid grid-3 gap-2">
                        <div class="form-group">
                            <label for="animalCount" data-lang="count">Count</label>
                            <input type="number" id="animalCount" class="form-control" placeholder="1" min="1">
                        </div>
                        <div class="form-group">
                            <label for="animalBreed" data-lang="breed">Breed</label>
                            <input type="text" id="animalBreed" class="form-control" placeholder="Animal breed">
                        </div>
                        <div class="form-group">
                            <label for="animalHealth" data-lang="health">Health Status</label>
                            <select id="animalHealth" class="form-control">
                                <option value="healthy">💚 Healthy</option>
                                <option value="sick">🤒 Sick</option>
                                <option value="recovering">🔄 Recovering</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="landFields" class="hidden">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="landSize" data-lang="size">Size (acres)</label>
                            <input type="number" id="landSize" class="form-control" step="0.1" placeholder="0.0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="landType" data-lang="land-type">Land Type</label>
                            <select id="landType" class="form-control">
                                <option value="owned">🏠 Owned</option>
                                <option value="leased">📄 Leased</option>
                                <option value="rented">🏘️ Rented</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="inventoryFields" class="hidden">
                    <div class="grid grid-2 gap-2">
                        <div class="form-group">
                            <label for="inventoryQuantity" data-lang="quantity">Quantity</label>
                            <input type="number" id="inventoryQuantity" class="form-control" step="0.1" placeholder="0.0" min="0">
                        </div>
                        <div class="form-group">
                            <label for="inventoryUnit" data-lang="unit">Unit</label>
                            <select id="inventoryUnit" class="form-control">
                                <option value="kg">Kg</option>
                                <option value="tons">Tons</option>
                                <option value="liters">Liters</option>
                                <option value="pieces">Pieces</option>
                                <option value="bags">Bags</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="assetNotes" data-lang="notes">Notes</label>
                    <textarea id="assetNotes" class="form-control" rows="2" placeholder="Additional notes..."></textarea>
                </div>
                <div class="flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 
                        <span data-lang="add-asset">Add Asset</span>
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addAssetModal')">
                        <i class="fas fa-times"></i> 
                        <span data-lang="cancel">Cancel</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Crop Details Modal -->
    <div id="cropDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-seedling"></i> 
                    <span data-lang="crop-details">Crop Details</span>
                </h2>
                <button class="close-modal" onclick="closeModal('cropDetailsModal')">&times;</button>
            </div>
            <div id="cropDetailsContent">
                <!-- Crop details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- All Transactions Modal -->
    <div id="allTransactionsModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-list"></i> 
                    <span data-lang="all-transactions">All Transactions</span>
                </h2>
                <button class="close-modal" onclick="closeModal('allTransactionsModal')">&times;</button>
            </div>
            <div id="allTransactionsContent">
                <!-- All transactions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Firebase Configuration
        const firebaseConfig = {

    apiKey: "AIzaSyCdfgtj1gvZ-bkomW1V40h-4tyUPHy_peo",

    authDomain: "jama-3f427.firebaseapp.com",

    projectId: "jama-3f427",

    storageBucket: "jama-3f427.firebasestorage.app",

    messagingSenderId: "897112470741",

    appId: "1:897112470741:web:ee6388f0faae459fcb1e5c",

    measurementId: "G-NN1BRV0QKS"

  };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Weather API Configuration
        const WEATHER_API_KEY = '1G7YyF7MlPU3v0bx8oAL36JWwDziEgH5';
        const WEATHER_API_BASE = 'https://api.tomorrow.io/v4/weather/forecast';

        // Global Variables
        let currentUser = null;
        let currentSection = 'dashboard';
        let currentLanguage = 'en';
        let currentTheme = 'light';
        let otpTimer = null;
        let confirmationResult = null;
        let autoSaveInterval = null;
        let fabMenuOpen = false;

        // Storage Keys
        const STORAGE_KEYS = {
            USER_DATA: 'jama_user_data',
            CROPS: 'jama_crops',
            TRANSACTIONS: 'jama_transactions',
            ASSETS: 'jama_assets',
            LOANS: 'jama_loans',
            SETTINGS: 'jama_settings',
            WEATHER_CACHE: 'jama_weather_cache',
            LAST_SECTION: 'jama_last_section',
            SELECTED_LANGUAGE: 'jama_selected_language',
            CURRENT_PATH: 'jama_current_path'
        };

        // Enhanced Translations
        const translations = {
            en: {
                'smart-crop': 'Smart Crop Management',
                'financial-tracking': 'Financial Tracking',
                'weather-intel': 'Weather Intelligence',
                'analytics': 'Advanced Analytics',
                'initializing': 'Initializing your smart farm dashboard...',
                'auto-saved': 'Auto-saved',
                'tagline': 'Smart Farm Management System',
                'email': 'Email Address',
                'password': 'Password',
                'sign-in': 'Sign In',
                'or-continue': 'or continue with',
                'google-signin': 'Sign in with Google',
                'phone-signin': 'Sign in with Phone',
                'no-account': "Don't have an account?",
                'register-here': 'Register here',
                'first-name': 'First Name',
                'last-name': 'Last Name',
                'phone': 'Phone Number',
                'location': 'Location',
                'farm-size': 'Farm Size (acres)',
                'primary-crop': 'Primary Crop',
                'select-crop': 'Select Primary Crop',
                'create-account': 'Create Account',
                'have-account': 'Already have an account?',
                'signin-here': 'Sign in here',
                'dashboard': 'Dashboard',
                'crop-mgmt': 'Crop Management',
                'financial-mgmt': 'Financial Management',
                'asset-mgmt': 'Asset Management',
                'loans-emi': 'Loans & EMI',
                'smart-ideas': 'Smart Ideas',
                'weather': 'Weather',
                'profile': 'Profile & Settings',
                'total-income': 'Total Income',
                'total-expenses': 'Total Expenses',
                'net-profit': 'Net Profit',
                'active-loans': 'Active Loans',
                'from-last-month': 'from last month',
                'active-loans-count': 'active loans',
                'loading-weather': 'Loading weather...',
                'humidity': 'Humidity',
                'wind': 'Wind',
                'feels': 'Feels',
                'insights': 'Monthly Insights',
                'best-crop': 'Best Performing Crop',
                'top-expense': 'Top Expense',
                'season-roi': 'Season ROI',
                'income-expense-chart': 'Income vs Expenses (Last 6 Months)',
                'crop-profit-chart': 'Crop Profitability',
                'notifications': 'Recent Notifications',
                'add-crop': 'Add New Crop',
                'all-status': 'All Status',
                'active': 'Active',
                'harvested': 'Harvested',
                'planned': 'Planned',
                'all-seasons': 'All Seasons',
                'kharif': 'Kharif',
                'rabi': 'Rabi',
                'zaid': 'Zaid',
                'add-transaction': 'Add Transaction',
                'loan-calc': 'Loan Calculator',
                'month-income': 'This Month Income',
                'month-expenses': 'This Month Expenses',
                'monthly-profit': 'Monthly Profit',
                'cash-flow': 'Cash Flow',
                'all-types': 'All Types',
                'income': 'Income',
                'expense': 'Expense',
                'all-categories': 'All Categories',
                'crop-sale': 'Crop Sale',
                'seeds': 'Seeds',
                'fertilizers': 'Fertilizers',
                'equipment': 'Equipment',
                'labor': 'Labor',
                'loan': 'Loan',
                'other': 'Other',
                'cash-flow-trend': 'Cash Flow Trend',
                'recent-trans': 'Recent Transactions',
                'all-transactions': 'All Transactions',
                'view-all': 'View All',
                'date': 'Date',
                'description': 'Description',
                'category': 'Category',
                'type': 'Type',
                'amount': 'Amount',
                'actions': 'Actions',
                'add-asset': 'Add Asset',
                'items': 'items',
                'livestock': 'Livestock',
                'land': 'Land',
                'plots': 'plots',
                'inventory': 'Inventory',
                'add-loan': 'Add Loan',
                'calculate': 'Calculate EMI',
                'total-loan': 'Total Loan Amount',
                'monthly-emi': 'Monthly EMI',
                'upcoming-emi': 'Upcoming EMI',
                'overdue-emi': 'Overdue EMI',
                'emi-calendar': 'EMI Calendar',
                'active-loans-list': 'Active Loans',
                'refresh': 'Refresh Ideas',
                'all-ideas': 'All Ideas',
                'crop': 'Crop',
                'financial': 'Financial',
                'technology': 'Technology',
                'market': 'Market',
                'weather-info': 'Weather Information',
                'get-weather': 'Get Weather',
                'current-location': 'Current Location',
                'current-weather': 'Current Weather',
                'feels-like': 'Feels like',
                'pressure': 'Pressure',
                'agri-conditions': 'Agricultural Conditions',
                'soil-temp': 'Soil Temp',
                'rain-chance': 'Rain Chance',
                'visibility': 'Visibility',
                'farming-alerts': 'Farming Alerts',
                'forecast': '5-Day Forecast',
                'hourly-forecast': '24-Hour Temperature & Rain Trend',
                'profile-settings': 'Profile & Settings',
                'profile-info': 'Profile Information',
                'full-name': 'Full Name',
                'update-profile': 'Update Profile',
                'farm-stats': 'Farm Statistics',
                'total-crops': 'Total Crops',
                'active-crops': 'Active Crops',
                'transactions': 'Transactions',
                'assets': 'Assets',
                'app-settings': 'App Settings',
                'theme': 'Theme',
                'light': 'Light',
                'dark': 'Dark',
                'language': 'Language',
                'data-mgmt': 'Data Management',
                'export-data': 'Export All Data (PDF)',
                'backup-cloud': 'Backup to Cloud',
                'clear-data': 'Clear All Data',
                'crops': 'Crops',
                'money': 'Money',
                'loans': 'Loans',
                'crop-name': 'Crop Name',
                'variety': 'Variety',
                'area': 'Area (acres)',
                'season': 'Season',
                'select-season': 'Select Season',
                'sowing-date': 'Sowing Date',
                'harvest-date': 'Expected Harvest Date',
                'expected-yield': 'Expected Yield (tons)',
                'expected-price': 'Expected Price (₹/ton)',
                'notes': 'Notes',
                'cancel': 'Cancel',
                'save': 'Save',
                'select-type': 'Select Type',
                'select-category': 'Select Category',
                'payment-method': 'Payment Method',
                'cash': 'Cash',
                'bank-transfer': 'Bank Transfer',
                'check': 'Check',
                'digital': 'Digital Payment',
                'related-crop': 'Related Crop (optional)',
                'loan-provider': 'Loan Provider',
                'loan-type': 'Loan Type',
                'loan-amount': 'Loan Amount (₹)',
                'interest-rate': 'Interest Rate (%)',
                'tenure': 'Tenure (months)',
                'start-date': 'Loan Start Date',
                'emi-date': 'EMI Due Date (day of month)',
                'purpose': 'Loan Purpose',
                'loan-details': 'Loan Details',
                'calc-results': 'Calculation Results',
                'total-interest': 'Total Interest',
                'total-amount': 'Total Amount',
                'save-loan': 'Save as Loan',
                'interest-type': 'Interest Type',
                'asset-type': 'Asset Type',
                'name': 'Name',
                'purchase-date': 'Purchase Date',
                'purchase-price': 'Purchase Price (₹)',
                'condition': 'Condition',
                'maintenance': 'Annual Maintenance (₹)',
                'count': 'Count',
                'breed': 'Breed',
                'health': 'Health Status',
                'size': 'Size (acres)',
                'land-type': 'Land Type',
                'quantity': 'Quantity',
                'unit': 'Unit',
                'crop-details': 'Crop Details',
                'check-weather': 'Check Weather',
                'toggle-theme': 'Toggle Theme',
                'sign-out': 'Sign Out',
                'farm-dashboard': 'Farm Dashboard',
                'send-otp': 'Send OTP',
                'enter-otp': 'Enter 6-digit OTP',
                'verify-otp': 'Verify OTP',
                'resend-otp': 'Resend OTP',
                'back-login': 'Back to Login'
            },
            hi: {
                'smart-crop': 'स्मार्ट फसल प्रबंधन',
                'financial-tracking': 'वित्तीय ट्रैकिंग',
                'weather-intel': 'मौसम बुद्धिमत्ता',
                'analytics': 'उन्नत विश्लेषण',
                'initializing': 'आपका स्मार्ट फार्म डैशबोर्ड प्रारंभ हो रहा है...',
                'auto-saved': 'ऑटो-सेव हो गया',
                'tagline': 'स्मार्ट फार्म प्रबंधन सिस्टम',
                'email': 'ईमेल पता',
                'password': 'पासवर्ड',
                'sign-in': 'साइन इन करें',
                'or-continue': 'या जारी रखें',
                'google-signin': 'Google से साइन इन करें',
                'phone-signin': 'फोन से साइन इन करें',
                'no-account': 'क्या आपका खाता नहीं है?',
                'register-here': 'यहाँ रजिस्टर करें',
                'first-name': 'पहला नाम',
                'last-name': 'अंतिम नाम',
                'phone': 'फोन नंबर',
                'location': 'स्थान',
                'farm-size': 'फार्म का आकार (एकड़)',
                'primary-crop': 'मुख्य फसल',
                'select-crop': 'मुख्य फसल चुनें',
                'create-account': 'खाता बनाएं',
                'have-account': 'पहले से खाता है?',
                'signin-here': 'यहाँ साइन इन करें',
                'dashboard': 'डैशबोर्ड',
                'crop-mgmt': 'फसल प्रबंधन',
                'financial-mgmt': 'वित्तीय प्रबंधन',
                'asset-mgmt': 'संपत्ति प्रबंधन',
                'loans-emi': 'ऋण और ईएमआई',
                'smart-ideas': 'स्मार्ट आइडिया',
                'weather': 'मौसम',
                'profile': 'प्रोफाइल और सेटिंग्स',
                'total-income': 'कुल आय',
                'total-expenses': 'कुल व्यय',
                'net-profit': 'शुद्ध लाभ',
                'active-loans': 'सक्रिय ऋण',
                'from-last-month': 'पिछले महीने से',
                'active-loans-count': 'सक्रिय ऋण',
                'loading-weather': 'मौसम लोड हो रहा है...',
                'humidity': 'नमी',
                'wind': 'हवा',
                'feels': 'महसूस',
                'insights': 'मासिक अंतर्दृष्टि',
                'best-crop': 'सबसे अच्छी फसल',
                'top-expense': 'सबसे ज्यादा खर्च',
                'season-roi': 'सीजन ROI',
                'income-expense-chart': 'आय बनाम व्यय (पिछले 6 महीने)',
                'crop-profit-chart': 'फसल लाभप्रदता',
                'notifications': 'हाल की सूचनाएं',
                'add-crop': 'नई फसल जोड़ें',
                'all-status': 'सभी स्थिति',
                'active': 'सक्रिय',
                'harvested': 'कटाई की गई',
                'planned': 'योजनाबद्ध',
                'all-seasons': 'सभी मौसम',
                'kharif': 'खरीफ',
                'rabi': 'रबी',
                'zaid': 'जायद',
                'add-transaction': 'लेनदेन जोड़ें',
                'loan-calc': 'ऋण कैलकुलेटर',
                'month-income': 'इस महीने की आय',
                'month-expenses': 'इस महीने का खर्च',
                'monthly-profit': 'मासिक लाभ',
                'cash-flow': 'नकदी प्रवाह',
                'all-types': 'सभी प्रकार',
                'income': 'आय',
                'expense': 'व्यय',
                'all-categories': 'सभी श्रेणियां',
                'crop-sale': 'फसल बिक्री',
                'seeds': 'बीज',
                'fertilizers': 'उर्वरक',
                'equipment': 'उपकरण',
                'labor': 'श्रम',
                'loan': 'ऋण',
                'other': 'अन्य',
                'cash-flow-trend': 'नकदी प्रवाह प्रवृत्ति',
                'recent-trans': 'हालिया लेनदेन',
                'all-transactions': 'सभी लेनदेन',
                'view-all': 'सभी देखें',
                'date': 'दिनांक',
                'description': 'विवरण',
                'category': 'श्रेणी',
                'type': 'प्रकार',
                'amount': 'राशि',
                'actions': 'कार्रवाई',
                'add-asset': 'संपत्ति जोड़ें',
                'items': 'वस्तुएं',
                'livestock': 'पशुधन',
                'land': 'जमीन',
                'plots': 'भूखंड',
                'inventory': 'इन्वेंटरी',
                'add-loan': 'ऋण जोड़ें',
                'calculate': 'ईएमआई गणना करें',
                'total-loan': 'कुल ऋण राशि',
                'monthly-emi': 'मासिक ईएमआई',
                'upcoming-emi': 'आगामी ईएमआई',
                'overdue-emi': 'बकाया ईएमआई',
                'emi-calendar': 'ईएमआई कैलेंडर',
                'active-loans-list': 'सक्रिय ऋण',
                'refresh': 'रिफ्रेश आइडिया',
                'all-ideas': 'सभी आइडिया',
                'crop': 'फसल',
                'financial': 'वित्तीय',
                'technology': 'प्रौद्योगिकी',
                'market': 'बाजार',
                'weather-info': 'मौसम की जानकारी',
                'get-weather': 'मौसम प्राप्त करें',
                'current-location': 'वर्तमान स्थान',
                'current-weather': 'वर्तमान मौसम',
                'feels-like': 'जैसा लगता है',
                'pressure': 'दबाव',
                'agri-conditions': 'कृषि स्थितियां',
                'soil-temp': 'मिट्टी का तापमान',
                'rain-chance': 'बारिश की संभावना',
                'visibility': 'दृश्यता',
                'farming-alerts': 'कृषि अलर्ट',
                'forecast': '5-दिन पूर्वानुमान',
                'hourly-forecast': '24-घंटे तापमान और बारिश ट्रेंड',
                'profile-settings': 'प्रोफाइल और सेटिंग्स',
                'profile-info': 'प्रोफाइल जानकारी',
                'full-name': 'पूरा नाम',
                'update-profile': 'प्रोफाइल अपडेट करें',
                'farm-stats': 'फार्म आंकड़े',
                'total-crops': 'कुल फसलें',
                'active-crops': 'सक्रिय फसलें',
                'transactions': 'लेनदेन',
                'assets': 'संपत्ति',
                'app-settings': 'ऐप सेटिंग्स',
                'theme': 'थीम',
                'light': 'हल्का',
                'dark': 'गहरा',
                'language': 'भाषा',
                'data-mgmt': 'डेटा प्रबंधन',
                'export-data': 'सभी डेटा निर्यात करें (PDF)',
                'backup-cloud': 'क्लाउड में बैकअप',
                'clear-data': 'सभी डेटा साफ़ करें',
                'crops': 'फसलें',
                'money': 'पैसा',
                'loans': 'ऋण',
                'crop-name': 'फसल का नाम',
                'variety': 'किस्म',
                'area': 'क्षेत्र (एकड़)',
                'season': 'मौसम',
                'select-season': 'मौसम चुनें',
                'sowing-date': 'बुवाई की तारीख',
                'harvest-date': 'अपेक्षित कटाई की तारीख',
                'expected-yield': 'अपेक्षित उत्पादन (टन)',
                'expected-price': 'अपेक्षित मूल्य (₹/टन)',
                'notes': 'नोट्स',
                'cancel': 'रद्द करें',
                'save': 'सेव करें',
                'select-type': 'प्रकार चुनें',
                'select-category': 'श्रेणी चुनें',
                'payment-method': 'भुगतान विधि',
                'cash': 'नकद',
                'bank-transfer': 'बैंक स्थानांतरण',
                'check': 'चेक',
                'digital': 'डिजिटल भुगतान',
                'related-crop': 'संबंधित फसल (वैकल्पिक)',
                'loan-provider': 'ऋणदाता',
                'loan-type': 'ऋण प्रकार',
                'loan-amount': 'ऋण राशि (₹)',
                'interest-rate': 'ब्याज दर (%)',
                'tenure': 'अवधि (महीने)',
                'start-date': 'ऋण प्रारंभ तिथि',
                'emi-date': 'ईएमआई देय तिथि (महीने का दिन)',
                'purpose': 'ऋण उद्देश्य',
                'loan-details': 'ऋण विवरण',
                'calc-results': 'गणना परिणाम',
                'total-interest': 'कुल ब्याज',
                'total-amount': 'कुल राशि',
                'save-loan': 'ऋण के रूप में सेव करें',
                'interest-type': 'ब्याज प्रकार',
                'asset-type': 'संपत्ति प्रकार',
                'name': 'नाम',
                'purchase-date': 'खरीद की तारीख',
                'purchase-price': 'खरीद मूल्य (₹)',
                'condition': 'स्थिति',
                'maintenance': 'वार्षिक रखरखाव (₹)',
                'count': 'संख्या',
                'breed': 'नस्ल',
                'health': 'स्वास्थ्य स्थिति',
                'size': 'आकार (एकड़)',
                'land-type': 'भूमि प्रकार',
                'quantity': 'मात्रा',
                'unit': 'इकाई',
                'crop-details': 'फसल विवरण',
                'check-weather': 'मौसम जांचें',
                'toggle-theme': 'थीम बदलें',
                'sign-out': 'साइन आउट',
                'farm-dashboard': 'फार्म डैशबोर्ड',
                'send-otp': 'OTP भेजें',
                'enter-otp': '6-अंकीय OTP दर्ज करें',
                'verify-otp': 'OTP सत्यापित करें',
                'resend-otp': 'OTP पुनः भेजें',
                'back-login': 'लॉगिन पर वापस'
            },
            te: {
                'smart-crop': 'స్మార్ట్ పంట నిర్వహణ',
                'financial-tracking': 'ఆర్థిక ట్రాకింగ్',
                'weather-intel': 'వాతావరణ మేధస్సు',
                'analytics': 'అధునాతన విశ్లేషణ',
                'initializing': 'మీ స్మార్ట్ ఫార్మ్ డాష్‌బోర్డ్ ప్రారంభమవుతోంది...',
                'auto-saved': 'ఆటో-సేవ్ అయింది',
                'tagline': 'స్మార్ట్ ఫార్మ్ నిర్వహణ వ్యవస్థ',
                'email': 'ఇమెయిల్ చిరునామా',
                'password': 'పాస్‌వర్డ్',
                'sign-in': 'సైన్ ఇన్',
                'or-continue': 'లేదా కొనసాగించండి',
                'google-signin': 'Google తో సైన్ ఇన్',
                'phone-signin': 'ఫోన్‌తో సైన్ ఇన్',
                'no-account': 'ఖాతా లేదా?',
                'register-here': 'ఇక్కడ నమోదు చేసుకోండి',
                'first-name': 'మొదటి పేరు',
                'last-name': 'చివరి పేరు',
                'phone': 'ఫోన్ నంబర్',
                'location': 'స్థలం',
                'farm-size': 'పొలం పరిమాణం (ఎకరాలు)',
                'primary-crop': 'ప్రధాన పంట',
                'select-crop': 'ప్రధాన పంట ఎంచుకోండి',
                'create-account': 'ఖాతా సృష్టించండి',
                'have-account': 'ఇప్పటికే ఖాతా ఉందా?',
                'signin-here': 'ఇక్కడ సైన్ ఇన్ చేయండి',
                'dashboard': 'డాష్‌బోర్డ్',
                'crop-mgmt': 'పంట నిర్వహణ',
                'financial-mgmt': 'ఆర్థిక నిర్వహణ',
                'asset-mgmt': 'ఆస్తి నిర్వహణ',
                'loans-emi': 'రుణాలు మరియు EMI',
                'smart-ideas': 'స్మార్ట్ ఐడియాలు',
                'weather': 'వాతావరణం',
                'profile': 'ప్రొఫైల్ మరియు సెట్టింగులు',
                'total-income': 'మొత్తం ఆదాయం',
                'total-expenses': 'మొత్తం ఖర్చులు',
                'net-profit': 'నికర లాభం',
                'active-loans': 'క్రియాశీల రుణాలు',
                'from-last-month': 'గత నెల నుండి',
                'active-loans-count': 'క్రియాశీల రుణాలు',
                'loading-weather': 'వాతావరణం లోడ్ అవుతోంది...',
                'humidity': 'తేమ',
                'wind': 'గాలి',
                'feels': 'అనుభవం',
                'insights': 'నెలవారీ అంతర్దృష్టులు',
                'best-crop': 'ఉత్తమ ప్రదర్శన పంట',
                'top-expense': 'అత్యధిక ఖర్చు',
                'season-roi': 'సీజన్ ROI',
                'income-expense-chart': 'ఆదాయం vs ఖర్చులు (గత 6 నెలలు)',
                'crop-profit-chart': 'పంట లాభదాయకత',
                'notifications': 'ఇటీవలి నోటిఫికేషన్లు',
                'add-crop': 'కొత్త పంట జోడించండి',
                'all-status': 'అన్ని స్థితులు',
                'active': 'క్రియాశీలం',
                'harvested': 'కోత చేయబడింది',
                'planned': 'ప్రణాళికాబద్ధం',
                'all-seasons': 'అన్ని సీజన్లు',
                'kharif': 'ఖరీఫ్',
                'rabi': 'రబీ',
                'zaid': 'జైద్',
                'add-transaction': 'లావాదేవీ జోడించండి',
                'loan-calc': 'రుణ కాలిక్యులేటర్',
                'month-income': 'ఈ నెల ఆదాయం',
                'month-expenses': 'ఈ నెల ఖర్చులు',
                'monthly-profit': 'నెలవారీ లాభం',
                'cash-flow': 'నగదు ప్రవాహం',
                'all-types': 'అన్ని రకాలు',
                'income': 'ఆదాయం',
                'expense': 'ఖర్చు',
                'all-categories': 'అన్ని వర్గాలు',
                'crop-sale': 'పంట అమ్మకం',
                'seeds': 'విత్తనాలు',
                'fertilizers': 'ఎరువులు',
                'equipment': 'పరికరాలు',
                'labor': 'కార్మికులు',
                'loan': 'రుణం',
                'other': 'ఇతర',
                'cash-flow-trend': 'నగదు ప్రవాహ ట్రెండ్',
                'recent-trans': 'ఇటీవలి లావాదేవీలు',
                'all-transactions': 'అన్ని లావాదేవీలు',
                'view-all': 'అన్నీ చూడండి',
                'date': 'తేదీ',
                'description': 'వివరణ',
                'category': 'వర్గం',
                'type': 'రకం',
                'amount': 'మొత్తం',
                'actions': 'చర్యలు',
                'add-asset': 'ఆస్తి జోడించండి',
                'items': 'వస్తువులు',
                'livestock': 'పశువులు',
                'land': 'భూమి',
                'plots': 'ప్లాట్లు',
                'inventory': 'ఇన్వెంటరీ',
                'add-loan': 'రుణం జోడించండి',
                'calculate': 'EMI లెక్కించండి',
                'total-loan': 'మొత్తం రుణ మొత్తం',
                'monthly-emi': 'నెలవారీ EMI',
                'upcoming-emi': 'రాబోయే EMI',
                'overdue-emi': 'కాలం దాటిన EMI',
                'emi-calendar': 'EMI క్యాలెండర్',
                'active-loans-list': 'క్రియాశీల రుణాలు',
                'refresh': 'ఐడియాలను రిఫ్రెష్ చేయండి',
                'all-ideas': 'అన్ని ఐడియాలు',
                'crop': 'పంట',
                'financial': 'ఆర్థిక',
                'technology': 'సాంకేతికత',
                'market': 'మార్కెట్',
                'weather-info': 'వాతావరణ సమాచారం',
                'get-weather': 'వాతావరణం పొందండి',
                'current-location': 'ప్రస్తుత స్థలం',
                'current-weather': 'ప్రస్తుత వాతావరణం',
                'feels-like': 'అనిపిస్తుంది',
                'pressure': 'ఒత్తిడి',
                'agri-conditions': 'వ్యవసాయ పరిస్థితులు',
                'soil-temp': 'నేల ఉష్ణోగ్రత',
                'rain-chance': 'వర్షం అవకాశం',
                'visibility': 'దృశ్యమానత',
                'farming-alerts': 'వ్యవసాయ హెచ్చరికలు',
                'forecast': '5-రోజుల అంచనా',
                'hourly-forecast': '24-గంటల ఉష్ణోగ్రత మరియు వర్షం ట్రెండ్',
                'profile-settings': 'ప్రొఫైల్ మరియు సెట్టింగులు',
                'profile-info': 'ప్రొఫైల్ సమాచారం',
                'full-name': 'పూర్తి పేరు',
                'update-profile': 'ప్రొఫైల్ అప్‌డేట్ చేయండి',
                'farm-stats': 'పొలం గణాంకాలు',
                'total-crops': 'మొత్తం పంటలు',
                'active-crops': 'క్రియాశీల పంటలు',
                'transactions': 'లావాదేవీలు',
                'assets': 'ఆస్తులు',
                'app-settings': 'యాప్ సెట్టింగులు',
                'theme': 'థీమ్',
                'light': 'తేలిక',
                'dark': 'చీకటి',
                'language': 'భాష',
                'data-mgmt': 'డేటా నిర్వహణ',
                'export-data': 'అన్ని డేటాను ఎగుమతి చేయండి (PDF)',
                'backup-cloud': 'క్లౌడ్‌కు బ్యాకప్',
                'clear-data': 'అన్ని డేటాను క్లియర్ చేయండి',
                'crops': 'పంటలు',
                'money': 'డబ్బు',
                'loans': 'రుణాలు',
                'crop-name': 'పంట పేరు',
                'variety': 'రకం',
                'area': 'విస్తీర్ణం (ఎకరాలు)',
                'season': 'సీజన్',
                'select-season': 'సీజన్ ఎంచుకోండి',
                'sowing-date': 'విత్తనం వేసిన తేదీ',
                'harvest-date': 'కోత అంచనా తేదీ',
                'expected-yield': 'అంచనా దిగుబడి (టన్నులు)',
                'expected-price': 'అంచనా ధర (₹/టన్ను)',
                'notes': 'గమనికలు',
                'cancel': 'రద్దు చేయండి',
                'save': 'సేవ్ చేయండి',
                'select-type': 'రకం ఎంచుకోండి',
                'select-category': 'వర్గం ఎంచుకోండి',
                'payment-method': 'చెల్లింపు పద్ధతి',
                'cash': 'నగదు',
                'bank-transfer': 'బ్యాంక్ బదిలీ',
                'check': 'చెక్',
                'digital': 'డిజిటల్ చెల్లింపు',
                'related-crop': 'సంబంధిత పంట (ఐచ్ఛికం)',
                'loan-provider': 'రుణ ప్రదాత',
                'loan-type': 'రుణ రకం',
                'loan-amount': 'రుణ మొత్తం (₹)',
                'interest-rate': 'వడ్డీ రేటు (%)',
                'tenure': 'కాలవిధి (నెలలు)',
                'start-date': 'రుణ ప్రారంభ తేదీ',
                'emi-date': 'EMI చెల్లింపు తేదీ (నెలలో రోజు)',
                'purpose': 'రుణ ప్రయోజనం',
                'loan-details': 'రుణ వివరాలు',
                'calc-results': 'లెక్కింపు ఫలితాలు',
                'total-interest': 'మొత్తం వడ్డీ',
                'total-amount': 'మొత్తం మొత్తం',
                'save-loan': 'రుణంగా సేవ్ చేయండి',
                'interest-type': 'వడ్డీ రకం',
                'asset-type': 'ఆస్తి రకం',
                'name': 'పేరు',
                'purchase-date': 'కొనుగోలు తేదీ',
                'purchase-price': 'కొనుగోలు ధర (₹)',
                'condition': 'పరిస్థితి',
                'maintenance': 'వార్షిక నిర్వహణ (₹)',
                'count': 'సంఖ్య',
                'breed': 'జాతి',
                'health': 'ఆరోగ్య స్థితి',
                'size': 'పరిమాణం (ఎకరాలు)',
                'land-type': 'భూమి రకం',
                'quantity': 'పరిమాణం',
                'unit': 'యూనిట్',
                'crop-details': 'పంట వివరాలు',
                'check-weather': 'వాతావరణం చూడండి',
                'toggle-theme': 'థీమ్ మార్చండి',
                'sign-out': 'సైన్ అవుట్',
                'farm-dashboard': 'ఫార్మ్ డాష్‌బోర్డ్',
                'send-otp': 'OTP పంపండి',
                'enter-otp': '6-అంకెల OTP ప్రవేశపెట్టండి',
                'verify-otp': 'OTP ధృవీకరించండి',
                'resend-otp': 'OTP మళ్లీ పంపండి',
                'back-login': 'లాగిన్‌కు తిరిగి'
            }
        };

        // Sample Data
        const SAMPLE_CROPS = [
            {
                id: '1',
                name: 'rice',
                variety: 'Basmati',
                area: 2.5,
                season: 'kharif',
                location: 'Field A',
                sowingDate: '2024-06-15',
                expectedHarvest: '2024-11-15',
                expectedYield: 3.5,
                expectedPrice: 25000,
                status: 'active',
                image: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=300&fit=crop&auto=format&q=60',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                name: 'wheat',
                variety: 'HD-2967',
                area: 1.8,
                season: 'rabi',
                location: 'Field B',
                sowingDate: '2024-11-01',
                expectedHarvest: '2025-04-15',
                expectedYield: 2.8,
                expectedPrice: 22000,
                status: 'active',
                image: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=300&fit=crop&auto=format&q=60',
                createdAt: new Date().toISOString()
            }
        ];

        const SAMPLE_TRANSACTIONS = [
            {
                id: '1',
                type: 'income',
                category: 'crop-sale',
                description: 'Rice harvest sale',
                amount: 87500,
                date: '2024-11-20',
                paymentMethod: 'bank_transfer',
                cropId: '1',
                createdAt: new Date().toISOString()
            },
            {
                id: '2',
                type: 'expense',
                category: 'seeds',
                description: 'Wheat seeds purchase',
                amount: 15000,
                date: '2024-10-25',
                paymentMethod: 'cash',
                cropId: '2',
                createdAt: new Date().toISOString()
            },
            {
                id: '3',
                type: 'expense',
                category: 'fertilizers',
                description: 'NPK fertilizer',
                amount: 8500,
                date: '2024-10-28',
                paymentMethod: 'digital',
                cropId: '1',
                createdAt: new Date().toISOString()
            }
        ];

        const SAMPLE_LOANS = [
            {
                id: '1',
                provider: 'State Bank of India',
                type: 'crop-loan',
                amount: 200000,
                interestRate: 7.5,
                tenure: 12,
                monthlyEMI: 17358,
                startDate: '2024-06-01',
                emiDate: 15,
                purpose: 'Crop cultivation and inputs',
                status: 'active',
                remainingAmount: 180000,
                paidEMIs: 2,
                createdAt: new Date().toISOString()
            }
        ];

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Check if language is selected
            const savedLanguage = localStorage.getItem(STORAGE_KEYS.SELECTED_LANGUAGE);
            if (!savedLanguage) {
                document.getElementById('languageSelection').style.display = 'flex';
                return;
            }

            currentLanguage = savedLanguage;
            updateLanguage();
            
            // Show loading screen
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                checkAuthState();
            }, 3000);

            // Initialize event listeners
            initializeEventListeners();
            
            // Load settings
            loadSettings();
            
            // Initialize auto-save
            initializeAutoSave();
            
            // Load sample data if none exists
            initializeSampleData();

            // Initialize mobile menu toggle
            initializeMobileMenu();
        }

        function selectLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem(STORAGE_KEYS.SELECTED_LANGUAGE, lang);
            updateLanguage();
            document.getElementById('languageSelection').style.display = 'none';
            
            // Start the app
            setTimeout(() => {
                document.getElementById('loadingScreen').style.display = 'none';
                checkAuthState();
            }, 2000);

            // Show loading screen
            document.getElementById('loadingScreen').style.display = 'flex';
        }

        function updateLanguage() {
            if (!translations[currentLanguage]) return;

            const elements = document.querySelectorAll('[data-lang]');
            elements.forEach(element => {
                const key = element.getAttribute('data-lang');
                if (translations[currentLanguage][key]) {
                    if (element.tagName === 'INPUT' && element.placeholder !== undefined) {
                        // For input placeholders, check if it's already translated
                        const placeholder = element.getAttribute('placeholder');
                        if (!placeholder.includes('🔍') && !placeholder.includes('🌍')) {
                            element.placeholder = translations[currentLanguage][key];
                        }
                    } else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });

            // Update language selectors
            const languageSelects = document.querySelectorAll('#languageSelect, #settingsLanguage');
            languageSelects.forEach(select => {
                select.value = currentLanguage;
            });
        }

        function initializeSampleData() {
            if (!localStorage.getItem(STORAGE_KEYS.CROPS)) {
                localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(SAMPLE_CROPS));
            }
            if (!localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) {
                localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(SAMPLE_TRANSACTIONS));
            }
            if (!localStorage.getItem(STORAGE_KEYS.LOANS)) {
                localStorage.setItem(STORAGE_KEYS.LOANS, JSON.stringify(SAMPLE_LOANS));
            }
            if (!localStorage.getItem(STORAGE_KEYS.ASSETS)) {
                localStorage.setItem(STORAGE_KEYS.ASSETS, JSON.stringify([]));
            }
        }

        function initializeAutoSave() {
            autoSaveInterval = setInterval(() => {
                if (currentUser) {
                    autoSaveData();
                }
            }, 30000);
        }

        function autoSaveData() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show', 'saving');
            indicator.innerHTML = '<i class="fas fa-sync fa-spin"></i> <span data-lang="saving">Saving...</span>';
            
            setTimeout(() => {
                indicator.classList.remove('saving');
                indicator.innerHTML = '<i class="fas fa-check-circle"></i> <span data-lang="auto-saved">Auto-saved</span>';
                updateLanguage();
                
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }, 1000);
        }

        function initializeMobileMenu() {
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');

            // Show menu toggle on mobile
            if (window.innerWidth <= 768) {
                menuToggle.style.display = 'flex';
            }

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
            });

            // Close sidebar when clicking outside
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !menuToggle.contains(e.target) && 
                    sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                }
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) {
                    menuToggle.style.display = 'flex';
                } else {
                    menuToggle.style.display = 'none';
                    sidebar.classList.remove('active');
                }
            });
        }

        function initializeEventListeners() {
            // Authentication form handlers
            document.getElementById('emailLoginForm').addEventListener('submit', handleEmailLogin);
            document.getElementById('emailRegisterForm').addEventListener('submit', handleEmailRegister);
            document.getElementById('googleSignIn').addEventListener('click', handleGoogleSignIn);
            document.getElementById('phoneSignIn').addEventListener('click', showPhoneAuth);
            
            // Form toggle handlers
            document.getElementById('showRegister').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('register');
            });
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('login');
            });
            document.getElementById('backToLogin').addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForm('login');
            });

            // Theme and language handlers
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('languageSelect').addEventListener('change', (e) => {
                changeLanguage(e.target.value);
            });

            // Form handlers
            document.getElementById('addCropForm').addEventListener('submit', handleAddCrop);
            document.getElementById('addTransactionForm').addEventListener('submit', handleAddTransaction);
            document.getElementById('addAssetForm').addEventListener('submit', handleAddAsset);
            document.getElementById('addLoanForm').addEventListener('submit', handleAddLoan);
            document.getElementById('profileForm').addEventListener('submit', handleUpdateProfile);

            // Close modals when clicking outside
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    const modalId = e.target.id;
                    closeModal(modalId);
                }
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'n':
                            e.preventDefault();
                            showAddCropModal();
                            break;
                        case 't':
                            e.preventDefault();
                            showAddTransactionModal();
                            break;
                        case 's':
                            e.preventDefault();
                            autoSaveData();
                            break;
                    }
                }
            });
        }

        // Enhanced Authentication Functions
        function checkAuthState() {
            const savedUser = localStorage.getItem(STORAGE_KEYS.USER_DATA);
            const savedPath = localStorage.getItem(STORAGE_KEYS.CURRENT_PATH);
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadUserData();
                
                // Restore previous section or default to dashboard
                const sectionToShow = savedPath || 'dashboard';
                showSection(sectionToShow);
                initializeDashboard();
            } else {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify({
                            uid: user.uid,
                            email: user.email,
                            displayName: user.displayName
                        }));
                        document.getElementById('authContainer').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'block';
                        loadUserData();
                        initializeDashboard();
                    } else {
                        document.getElementById('authContainer').style.display = 'flex';
                        document.getElementById('appContainer').style.display = 'none';
                    }
                });
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            try {
                showNotification('Signing in...', 'info');
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Welcome back! 🎉', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification(getErrorMessage(error), 'error');
            }
        }

        async function handleEmailRegister(e) {
            e.preventDefault();
            const formData = {
                firstName: document.getElementById('regFirstName').value,
                lastName: document.getElementById('regLastName').value,
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                phone: document.getElementById('regPhone').value,
                location: document.getElementById('regLocation').value,
                farmSize: parseFloat(document.getElementById('regFarmSize').value),
                primaryCrop: document.getElementById('regPrimaryCrop').value,
                language: currentLanguage
            };

            try {
                showNotification('Creating your farm account...', 'info');
                const userCredential = await auth.createUserWithEmailAndPassword(formData.email, formData.password);
                
                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: `${formData.firstName} ${formData.lastName}`
                });

                // Save additional user data to Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    ...formData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                });

                showNotification('Account created successfully! Welcome to JamaApp! 🌱', 'success');
            } catch (error) {
                console.error('Registration error:', error);
                showNotification(getErrorMessage(error), 'error');
            }
        }

        async function handleGoogleSignIn() {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                showNotification('Signing in with Google...', 'info');
                const result = await auth.signInWithPopup(provider);
                
                // Save user data to Firestore
                await db.collection('users').doc(result.user.uid).set({
                    email: result.user.email,
                    displayName: result.user.displayName,
                    language: currentLanguage,
                    lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                showNotification('Google sign-in successful! 🎉', 'success');
            } catch (error) {
                console.error('Google sign-in error:', error);
                showNotification(getErrorMessage(error), 'error');
            }
        }

        function getErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                default:
                    return error.message || 'An error occurred. Please try again.';
            }
        }

        function showPhoneAuth() {
            toggleAuthForm('otp');
        }

        function toggleAuthForm(formType) {
            document.getElementById('loginForm').style.display = formType === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = formType === 'register' ? 'block' : 'none';
            document.getElementById('otpForm').style.display = formType === 'otp' ? 'block' : 'none';
        }

        async function signOut() {
            try {
                await auth.signOut();
                localStorage.clear();
                currentUser = null;
                showNotification('Signed out successfully! 👋', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } catch (error) {
                console.error('Sign out error:', error);
                showNotification('Error signing out', 'error');
            }
        }

        // Enhanced Data Management
        async function loadUserData() {
            try {
                if (currentUser && currentUser.uid) {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        populateProfileForm(userData);
                        if (userData.language) {
                            currentLanguage = userData.language;
                            updateLanguage();
                        }
                    }
                }

                loadCrops();
                loadTransactions();
                loadAssets();
                loadLoans();
                loadWeatherData();
                updateDashboardStats();
                loadCropsIntoTransactionModal();
                checkEMIReminders();
            } catch (error) {
                console.error('Error loading user data:', error);
                loadCrops();
                loadTransactions();
                loadAssets();
                loadLoans();
                updateDashboardStats();
                checkEMIReminders();
            }
        }

        function populateProfileForm(userData) {
            document.getElementById('profileName').value = userData.displayName || `${userData.firstName || ''} ${userData.lastName || ''}`.trim();
            document.getElementById('profileEmail').value = userData.email || (currentUser ? currentUser.email : '');
            document.getElementById('profilePhone').value = userData.phone || '';
            document.getElementById('profileLocation').value = userData.location || '';
            document.getElementById('profileFarmSize').value = userData.farmSize || '';
        }

        // Enhanced Navigation with Path Saving
        function showSection(sectionName) {
            // Save current section to localStorage
            localStorage.setItem(STORAGE_KEYS.CURRENT_PATH, sectionName);
            
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionName).classList.remove('hidden');

            // Update navigation active states
            document.querySelectorAll('.sidebar-nav a, .mobile-nav-item').forEach(nav => {
                nav.classList.remove('active');
            });
            
            const sidebarNav = document.getElementById(`nav-${sectionName}`);
            if (sidebarNav) sidebarNav.classList.add('active');
            
            const mobileNavs = document.querySelectorAll('.mobile-nav-item');
            mobileNavs.forEach(nav => {
                const onclick = nav.getAttribute('onclick');
                if (onclick && onclick.includes(sectionName)) {
                    nav.classList.add('active');
                }
            });

            currentSection = sectionName;

            // Load section-specific data
            switch(sectionName) {
                case 'dashboard':
                    initializeDashboard();
                    break;
                case 'crops':
                    loadCrops();
                    break;
                case 'money':
                    loadTransactions();
                    updateMonthlyStats();
                    break;
                case 'assets':
                    loadAssets();
                    break;
                case 'loans':
                    loadLoans();
                    break;
                case 'weather':
                    loadWeatherData();
                    break;
                case 'ideas':
                    generateSmartIdeas();
                    break;
            }

            // Close mobile menu if open
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('active');
            }
        }

        // Enhanced Dashboard Functions
        function initializeDashboard() {
            updateDashboardStats();
            loadWeatherData();
            loadNotifications();
            checkEMIReminders();
            setTimeout(() => {
                initializeCharts();
            }, 1000);
        }

        function updateDashboardStats() {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            
            let totalIncome = 0;
            let totalExpenses = 0;
            let activeLoansAmount = 0;

            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                } else if (transaction.type === 'expense') {
                    totalExpenses += transaction.amount;
                }
            });

            loans.forEach(loan => {
                if (loan.status === 'active') {
                    activeLoansAmount += loan.remainingAmount || loan.amount;
                }
            });

            const netProfit = totalIncome - totalExpenses;

            document.getElementById('totalIncome').textContent = `₹${totalIncome.toLocaleString('en-IN')}`;
            document.getElementById('totalExpenses').textContent = `₹${totalExpenses.toLocaleString('en-IN')}`;
            document.getElementById('netProfit').textContent = `₹${netProfit.toLocaleString('en-IN')}`;
            document.getElementById('activeLoans').textContent = `₹${activeLoansAmount.toLocaleString('en-IN')}`;

            updateMonthlyStats(transactions);
            updateInsights(crops, transactions);
            updateProfileStats(crops, transactions, assets);
            updateLoanStats(loans);
        }

        function updateMonthlyStats(transactions) {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let monthlyIncome = 0;
            let monthlyExpenses = 0;
            
            if (!transactions) {
                transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            }
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                if (transactionDate.getMonth() === currentMonth && transactionDate.getFullYear() === currentYear) {
                    if (transaction.type === 'income') {
                        monthlyIncome += transaction.amount;
                    } else {
                        monthlyExpenses += transaction.amount;
                    }
                }
            });
            
            const monthlyProfit = monthlyIncome - monthlyExpenses;
            const cashFlow = monthlyIncome - monthlyExpenses;
            
            const monthlyIncomeEl = document.getElementById('monthlyIncome');
            const monthlyExpensesEl = document.getElementById('monthlyExpenses');
            const monthlyProfitEl = document.getElementById('monthlyProfit');
            const cashFlowEl = document.getElementById('cashFlow');
            
            if (monthlyIncomeEl) monthlyIncomeEl.textContent = `₹${monthlyIncome.toLocaleString('en-IN')}`;
            if (monthlyExpensesEl) monthlyExpensesEl.textContent = `₹${monthlyExpenses.toLocaleString('en-IN')}`;
            if (monthlyProfitEl) monthlyProfitEl.textContent = `₹${monthlyProfit.toLocaleString('en-IN')}`;
            if (cashFlowEl) cashFlowEl.textContent = `₹${cashFlow.toLocaleString('en-IN')}`;
        }

        function updateInsights(crops, transactions) {
            const cropProfits = {};
            crops.forEach(crop => {
                if (crop.expectedYield && crop.expectedPrice) {
                    const expectedRevenue = crop.expectedYield * crop.expectedPrice;
                    cropProfits[crop.name] = (cropProfits[crop.name] || 0) + expectedRevenue;
                }
            });
            
            const bestCrop = Object.keys(cropProfits).reduce((a, b) => 
                cropProfits[a] > cropProfits[b] ? a : b, 'Rice');
            document.getElementById('bestCrop').textContent = bestCrop.charAt(0).toUpperCase() + bestCrop.slice(1);
            
            const expenseCategories = {};
            transactions.filter(t => t.type === 'expense').forEach(transaction => {
                expenseCategories[transaction.category] = (expenseCategories[transaction.category] || 0) + transaction.amount;
            });
            
            const highestExpense = Object.keys(expenseCategories).reduce((a, b) => 
                expenseCategories[a] > expenseCategories[b] ? a : b, 'Seeds');
            document.getElementById('highestExpense').textContent = 
                highestExpense.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function updateProfileStats(crops, transactions, assets) {
            const elements = {
                statTotalCrops: document.getElementById('statTotalCrops'),
                statActiveCrops: document.getElementById('statActiveCrops'),
                statTotalTransactions: document.getElementById('statTotalTransactions'),
                statTotalAssets: document.getElementById('statTotalAssets')
            };
            
            if (elements.statTotalCrops) elements.statTotalCrops.textContent = crops.length;
            if (elements.statActiveCrops) elements.statActiveCrops.textContent = crops.filter(c => c.status === 'active').length;
            if (elements.statTotalTransactions) elements.statTotalTransactions.textContent = transactions.length;
            if (elements.statTotalAssets) elements.statTotalAssets.textContent = assets.length;
        }

        function updateLoanStats(loans) {
            let totalLoanAmount = 0;
            let monthlyEMITotal = 0;
            let upcomingEMI = 0;
            let overdueEMI = 0;

            const today = new Date();
            
            loans.forEach(loan => {
                if (loan.status === 'active') {
                    totalLoanAmount += loan.remainingAmount || loan.amount;
                    monthlyEMITotal += loan.monthlyEMI;
                    
                    const nextEMIDate = getNextEMIDate(loan);
                    const daysToEMI = Math.ceil((nextEMIDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysToEMI <= 30 && daysToEMI > 0) {
                        upcomingEMI += loan.monthlyEMI;
                    } else if (daysToEMI < 0) {
                        overdueEMI += loan.monthlyEMI;
                    }
                }
            });

            const elements = {
                totalLoanAmount: document.getElementById('totalLoanAmount'),
                monthlyEMITotal: document.getElementById('monthlyEMITotal'),
                upcomingEMI: document.getElementById('upcomingEMI'),
                overdueEMI: document.getElementById('overdueEMI')
            };

            if (elements.totalLoanAmount) elements.totalLoanAmount.textContent = `₹${totalLoanAmount.toLocaleString('en-IN')}`;
            if (elements.monthlyEMITotal) elements.monthlyEMITotal.textContent = `₹${monthlyEMITotal.toLocaleString('en-IN')}`;
            if (elements.upcomingEMI) elements.upcomingEMI.textContent = `₹${upcomingEMI.toLocaleString('en-IN')}`;
            if (elements.overdueEMI) elements.overdueEMI.textContent = `₹${overdueEMI.toLocaleString('en-IN')}`;
        }

        function checkEMIReminders() {
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            const reminderContainer = document.getElementById('emiReminders');
            if (!reminderContainer) return;
            
            const reminders = [];
            const today = new Date();

            loans.forEach(loan => {
                if (loan.status === 'active') {
                    const nextEMIDate = getNextEMIDate(loan);
                    const daysToEMI = Math.ceil((nextEMIDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysToEMI <= 50 && daysToEMI >= 10) {
                        reminders.push({
                            loan,
                            daysToEMI,
                            nextEMIDate
                        });
                    }
                }
            });

            if (reminders.length > 0) {
                reminderContainer.innerHTML = reminders.map(reminder => `
                    <div class="reminder-card">
                        <div class="reminder-header">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="reminder-icon fas fa-exclamation-triangle"></i>
                                <div>
                                    <div class="reminder-title">EMI Reminder - ${reminder.loan.provider}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">EMI Due: ₹${reminder.loan.monthlyEMI.toLocaleString('en-IN')}</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="reminder-days">${reminder.daysToEMI} days</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Due: ${reminder.nextEMIDate.toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-warning" onclick="payEMI('${reminder.loan.id}')">
                                <i class="fas fa-credit-card"></i> Pay Now
                            </button>
                            <button class="btn btn-secondary" onclick="snoozeReminder('${reminder.loan.id}')">
                                <i class="fas fa-clock"></i> Remind Later
                            </button>
                        </div>
                    </div>
                `).join('');
            } else {
                reminderContainer.innerHTML = '';
            }
        }

        function getNextEMIDate(loan) {
            const startDate = new Date(loan.startDate);
            const today = new Date();
            const emiDay = loan.emiDate;
            
            let nextDate = new Date(today.getFullYear(), today.getMonth(), emiDay);
            
            if (nextDate < today) {
                nextDate.setMonth(nextDate.getMonth() + 1);
            }
            
            return nextDate;
        }

        function payEMI(loanId) {
            showAddTransactionModal();
            document.getElementById('transactionType').value = 'expense';
            updateTransactionCategories();
            document.getElementById('transactionCategory').value = 'loan-payment';
            document.getElementById('transactionDescription').value = `EMI Payment - ${loanId}`;
            
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            const loan = loans.find(l => l.id === loanId);
            if (loan) {
                document.getElementById('transactionAmount').value = loan.monthlyEMI;
            }
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
        }

        function snoozeReminder(loanId) {
            showNotification('Reminder snoozed for 7 days', 'info');
        }

        function loadNotifications() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            const notifications = [];
            const today = new Date();
            
            crops.forEach(crop => {
                if (crop.status === 'active') {
                    const harvestDate = new Date(crop.expectedHarvest);
                    const daysToHarvest = Math.ceil((harvestDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysToHarvest <= 7 && daysToHarvest > 0) {
                        notifications.push({
                            type: 'warning',
                            icon: 'fas fa-calendar-check',
                            message: `${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)} harvest due in ${daysToHarvest} days`,
                            date: new Date().toLocaleDateString()
                        });
                    } else if (daysToHarvest <= 0 && daysToHarvest > -30) {
                        notifications.push({
                            type: 'error',
                            icon: 'fas fa-exclamation-triangle',
                            message: `${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)} harvest is overdue`,
                            date: new Date().toLocaleDateString()
                        });
                    }
                }
            });

            loans.forEach(loan => {
                if (loan.status === 'active') {
                    const nextEMIDate = getNextEMIDate(loan);
                    const daysToEMI = Math.ceil((nextEMIDate - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysToEMI <= 7 && daysToEMI > 0) {
                        notifications.push({
                            type: 'warning',
                            icon: 'fas fa-money-bill-wave',
                            message: `EMI of ₹${loan.monthlyEMI.toLocaleString('en-IN')} due in ${daysToEMI} days (${loan.provider})`,
                            date: new Date().toLocaleDateString()
                        });
                    }
                }
            });
            
            // Add positive notifications if no alerts
            if (notifications.length === 0) {
                notifications.push({
                    type: 'success',
                    icon: 'fas fa-chart-line',
                    message: 'Your farm is performing well this season!',
                    date: new Date().toLocaleDateString()
                });
                notifications.push({
                    type: 'info',
                    icon: 'fas fa-cloud-sun',
                    message: 'Weather conditions are favorable for farming activities',
                    date: new Date().toLocaleDateString()
                });
            }
            
            const notificationsList = document.getElementById('notificationsList');
            if (notificationsList) {
                notificationsList.innerHTML = notifications.map(notification => `
                    <div class="notification-item" style="display: flex; align-items: center; padding: 1rem; margin-bottom: 0.5rem; border-left: 4px solid var(--${getNotificationColor(notification.type)}-color); background: rgba(${getNotificationRGB(notification.type)}, 0.1); border-radius: var(--border-radius-sm); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform='translateX(0)'">
                        <i class="${notification.icon}" style="font-size: 1.2rem; color: var(--${getNotificationColor(notification.type)}-color); margin-right: 1rem;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${notification.message}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${notification.date}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function getNotificationColor(type) {
            switch(type) {
                case 'success': return 'success';
                case 'warning': return 'warning';
                case 'error': return 'error';
                default: return 'primary';
            }
        }

        function getNotificationRGB(type) {
            switch(type) {
                case 'success': return '16,185,129';
                case 'warning': return '245,158,11';
                case 'error': return '239,68,68';
                default: return '46,125,50';
            }
        }

        // Enhanced Crop Management
        function loadCrops() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            displayCrops(crops);
            loadCropsIntoTransactionModal();
        }

        function loadCropsIntoTransactionModal() {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const cropSelect = document.getElementById('transactionCropId');
            if (cropSelect) {
                cropSelect.innerHTML = '<option value="">Select Crop</option>' +
                    crops.map(crop => `<option value="${crop.id}">${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)} - ${crop.variety || 'Standard'}</option>`).join('');
            }
        }

        function displayCrops(crops) {
            const cropGrid = document.getElementById('cropGrid');
            
            if (crops.length === 0) {
                cropGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                        <i class="fas fa-seedling" style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 2rem; opacity: 0.5;"></i>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">No crops added yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                            Start your farming journey by adding your first crop. Track growth, manage expenses, and maximize your harvest yield.
                        </p>
                        <button class="btn btn-primary" onclick="showAddCropModal()">
                            <i class="fas fa-plus"></i> Add Your First Crop
                        </button>
                    </div>
                `;
                return;
            }
            
            cropGrid.innerHTML = crops.map(crop => {
                const progress = calculateCropProgress(crop);
                const yieldPerAcre = crop.expectedYield ? (crop.expectedYield / crop.area).toFixed(2) : '0.00';
                const revenuePerAcre = crop.expectedPrice && crop.expectedYield ? 
                    ((crop.expectedYield * crop.expectedPrice) / crop.area).toLocaleString('en-IN') : '0';
                const relatedTransactions = getRelatedTransactions(crop.id);
                const weatherAlert = getWeatherAlertForCrop(crop);
                
                return `
                    <div class="card crop-card" style="animation: slideInUp 0.5s ease;">
                        <button class="transaction-quick-add" onclick="quickAddTransaction('${crop.id}')" title="Quick add transaction">
                            <i class="fas fa-plus"></i>
                        </button>
                        
                        <img src="${crop.image || getCropImage(crop.name)}" alt="${crop.name}" class="crop-image" onerror="this.src='https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=300&fit=crop&auto=format&q=60'">
                        
                        <div class="crop-header">
                            <div>
                                <div class="crop-name">
                                    ${getCropEmoji(crop.name)} ${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)}
                                </div>
                                ${crop.variety ? `<div class="crop-variety">${crop.variety}</div>` : ''}
                            </div>
                            <div class="crop-status ${crop.status}">${crop.status.charAt(0).toUpperCase() + crop.status.slice(1)}</div>
                        </div>
                        
                        <div class="crop-info">
                            <div class="crop-info-item">
                                <i class="fas fa-map-marker-alt"></i> 
                                <strong>Location:</strong> ${crop.location || 'Not specified'}
                            </div>
                            <div class="crop-info-item">
                                <i class="fas fa-calendar-alt"></i> 
                                <strong>Season:</strong> ${crop.season.charAt(0).toUpperCase() + crop.season.slice(1)}
                            </div>
                            <div class="crop-info-item">
                                <i class="fas fa-ruler-combined"></i> 
                                <strong>Area:</strong> ${crop.area} acres
                            </div>
                            <div class="crop-info-item">
                                <i class="fas fa-calendar-check"></i> 
                                <strong>Harvest:</strong> ${new Date(crop.expectedHarvest).toLocaleDateString()}
                            </div>
                        </div>
                        
                        ${crop.status === 'active' ? `
                            <div class="crop-progress">
                                <div class="crop-progress-label">
                                    <span><i class="fas fa-chart-line"></i> Growth Progress</span>
                                    <span><strong>${progress}%</strong></span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" style="width: ${progress}%"></div>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">
                                    ${getDaysRemaining(crop.expectedHarvest)} days remaining
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="crop-metrics">
                            <div class="metric">
                                <div class="metric-value">₹${((crop.expectedYield || 0) * (crop.expectedPrice || 0)).toLocaleString('en-IN')}</div>
                                <div class="metric-label">Expected Revenue</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${yieldPerAcre}t</div>
                                <div class="metric-label">Yield/Acre</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">₹${revenuePerAcre}</div>
                                <div class="metric-label">Revenue/Acre</div>
                            </div>
                        </div>
                        
                        <!-- Yield per acre calculation display -->
                        <div class="yield-per-acre">
                            <div class="yield-calculation">
                                <i class="fas fa-calculator"></i>
                                Yield Calculation: ${crop.expectedYield || 0}t ÷ ${crop.area}ac = ${yieldPerAcre}t/ac
                            </div>
                        </div>
                        
                        ${weatherAlert ? `
                            <div class="crop-weather-alert" style="background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(9, 132, 227, 0.1)); padding: 1rem; border-radius: var(--border-radius-sm); margin: 1rem 0; border-left: 4px solid #74b9ff;">
                                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">
                                    ${getWeatherIcon()} Weather Alert
                                </div>
                                <div style="font-size: 0.9rem;">${weatherAlert}</div>
                            </div>
                        ` : ''}
                        
                        ${relatedTransactions.length > 0 ? `
                            <div style="background: rgba(255, 107, 53, 0.05); padding: 1.5rem; border-radius: var(--border-radius-sm); margin: 1.5rem 0; border-left: 4px solid var(--accent-color);">
                                <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.75rem; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center;">
                                    <span><i class="fas fa-receipt"></i> Related Transactions</span>
                                    <button class="btn btn-secondary" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" onclick="showCropTransactions('${crop.id}')">
                                        View All (${relatedTransactions.length})
                                    </button>
                                </div>
                                ${relatedTransactions.slice(0, 3).map(transaction => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(255, 107, 53, 0.1); transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255, 107, 53, 0.05)'; this.style.borderRadius='var(--border-radius-xs)'" onmouseout="this.style.background='transparent'">
                                        <div>
                                            <span style="font-size: 0.8rem;">${transaction.description}</span>
                                            <div style="font-size: 0.7rem; color: var(--text-secondary);">${new Date(transaction.date).toLocaleDateString()}</div>
                                        </div>
                                        <div class="${transaction.type === 'income' ? 'text-success' : 'text-error'}" style="font-weight: 600;">
                                            ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString('en-IN')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="crop-actions">
                            <button class="btn btn-secondary" onclick="viewCropDetails('${crop.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-primary" onclick="editCrop('${crop.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            ${crop.status === 'active' ? `
                                <button class="btn btn-success" onclick="harvestCrop('${crop.id}')">
                                    <i class="fas fa-cut"></i> Harvest
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getCropImage(cropName) {
            const images = {
                rice: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=300&fit=crop&auto=format&q=60',
                wheat: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=300&fit=crop&auto=format&q=60',
                corn: 'https://images.unsplash.com/photo-1551754655-cd27e38d2076?w=400&h=300&fit=crop&auto=format&q=60',
                cotton: 'https://images.unsplash.com/photo-1592085189859-b372d7d7d1d6?w=400&h=300&fit=crop&auto=format&q=60',
                sugarcane: 'https://images.unsplash.com/photo-1571115764595-644a1f56a55c?w=400&h=300&fit=crop&auto=format&q=60',
                vegetables: 'https://images.unsplash.com/photo-1566385101042-1a0aa0c1268c?w=400&h=300&fit=crop&auto=format&q=60',
                fruits: 'https://images.unsplash.com/photo-1610832958506-aa56368176cf?w=400&h=300&fit=crop&auto=format&q=60',
                pulses: 'https://images.unsplash.com/photo-1588868054673-8194da3ddb3b?w=400&h=300&fit=crop&auto=format&q=60'
            };
            return images[cropName] || 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=300&fit=crop&auto=format&q=60';
        }

        function getCropEmoji(cropName) {
            const emojis = {
                rice: '🌾',
                wheat: '🌾',
                corn: '🌽',
                cotton: '🌿',
                sugarcane: '🎋',
                pulses: '🫘',
                vegetables: '🥕',
                fruits: '🍎'
            };
            return emojis[cropName] || '🌱';
        }

        function calculateCropProgress(crop) {
            if (crop.status !== 'active') return 100;
            
            const sowingDate = new Date(crop.sowingDate);
            const harvestDate = new Date(crop.expectedHarvest);
            const today = new Date();
            
            const totalDays = (harvestDate - sowingDate) / (1000 * 60 * 60 * 24);
            const daysPassed = (today - sowingDate) / (1000 * 60 * 60 * 24);
            
            const progress = Math.min(Math.max((daysPassed / totalDays) * 100, 0), 100);
            return Math.round(progress);
        }

        function getDaysRemaining(harvestDate) {
            const today = new Date();
            const harvest = new Date(harvestDate);
            const daysRemaining = Math.ceil((harvest - today) / (1000 * 60 * 60 * 24));
            return Math.max(daysRemaining, 0);
        }

        function getWeatherAlertForCrop(crop) {
            const alerts = [
                'Favorable conditions for growth',
                'Light rain expected - good for irrigation',
                'High temperature - monitor water levels',
                'Perfect humidity for this crop',
                'Optimal weather conditions detected'
            ];
            return alerts[Math.floor(Math.random() * alerts.length)];
        }

        function getWeatherIcon() {
            const icons = ['☀️', '🌤️', '⛅', '🌧️', '⛈️'];
            return icons[Math.floor(Math.random() * icons.length)];
        }

        function getRelatedTransactions(cropId) {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            return transactions.filter(t => t.cropId === cropId);
        }

        function quickAddTransaction(cropId) {
            showAddTransactionModal();
            document.getElementById('transactionCropId').value = cropId;
        }

        function showCropTransactions(cropId) {
            const transactions = getRelatedTransactions(cropId);
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const crop = crops.find(c => c.id === cropId);
            
            const modal = document.getElementById('allTransactionsModal');
            const content = document.getElementById('allTransactionsContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-color);">
                        ${getCropEmoji(crop.name)} ${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)} Transactions
                    </h3>
                    <p style="color: var(--text-secondary);">All financial activities related to this crop</p>
                </div>
                
                <div class="transaction-summary" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                            ₹${transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0).toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Income</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-color);">
                            ₹${transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0).toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Expenses</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(46, 125, 50, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                            ₹${(transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) - transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)).toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Net Profit</div>
                    </div>
                </div>
                
                <div class="transactions-list" style="max-height: 400px; overflow-y: auto;">
                    ${transactions.length > 0 ? 
                        transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).map(transaction => `
                            <div class="transaction-card">
                                <div class="transaction-header">
                                    <div class="transaction-type ${transaction.type}">
                                        <i class="fas fa-${transaction.type === 'income' ? 'arrow-up' : 'arrow-down'}"></i>
                                        ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                                    </div>
                                    <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-error'}">
                                        ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString('en-IN')}
                                    </div>
                                </div>
                                <div class="transaction-details">
                                    <div class="transaction-detail">
                                        <i class="fas fa-tag"></i>
                                        <span>${transaction.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                    </div>
                                    <div class="transaction-detail">
                                        <i class="fas fa-calendar"></i>
                                        <span>${new Date(transaction.date).toLocaleDateString()}</span>
                                    </div>
                                </div>
                                <div style="margin-top: 0.5rem;">
                                    <strong>Description:</strong> ${transaction.description}
                                </div>
                                ${transaction.notes ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-secondary);">${transaction.notes}</div>` : ''}
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="editTransaction('${transaction.id}'); closeModal('allTransactionsModal');">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-error" style="font-size: 0.8rem;" onclick="deleteTransaction('${transaction.id}'); setTimeout(() => showCropTransactions('${cropId}'), 100);">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `).join('') : 
                        '<div style="text-center; padding: 2rem; color: var(--text-secondary);">No transactions found for this crop</div>'
                    }
                </div>
            `;
            
            modal.classList.add('active');
        }

        function filterCrops() {
            const statusFilter = document.getElementById('cropStatusFilter').value;
            const seasonFilter = document.getElementById('cropSeasonFilter').value;
            const searchFilter = document.getElementById('cropSearchFilter').value.toLowerCase();
            
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            
            const filteredCrops = crops.filter(crop => {
                const matchesStatus = !statusFilter || crop.status === statusFilter;
                const matchesSeason = !seasonFilter || crop.season === seasonFilter;
                const matchesSearch = !searchFilter || 
                    crop.name.toLowerCase().includes(searchFilter) ||
                    (crop.variety && crop.variety.toLowerCase().includes(searchFilter)) ||
                    (crop.location && crop.location.toLowerCase().includes(searchFilter));
                
                return matchesStatus && matchesSeason && matchesSearch;
            });
            
            displayCrops(filteredCrops);
        }

        function showAddCropModal() {
            document.getElementById('addCropModal').classList.add('active');
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sowingDate').value = today;
            
            const harvestDate = new Date();
            harvestDate.setDate(harvestDate.getDate() + 90);
            document.getElementById('expectedHarvest').value = harvestDate.toISOString().split('T')[0];
        }

        function handleAddCrop(e) {
            e.preventDefault();
            
            const isEditing = document.getElementById('addCropForm').dataset.editingId;
            const cropData = {
                id: isEditing || Date.now().toString(),
                name: document.getElementById('cropName').value,
                variety: document.getElementById('cropVariety').value,
                area: parseFloat(document.getElementById('cropArea').value),
                season: document.getElementById('cropSeason').value,
                location: document.getElementById('cropLocation').value,
                sowingDate: document.getElementById('sowingDate').value,
                expectedHarvest: document.getElementById('expectedHarvest').value,
                expectedYield: parseFloat(document.getElementById('expectedYield').value) || 0,
                expectedPrice: parseFloat(document.getElementById('expectedPrice').value) || 0,
                
                notes: document.getElementById('cropNotes').value,
                status: 'active',
                image: getCropImage(document.getElementById('cropName').value),
                createdAt: isEditing ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            let crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            
            if (isEditing) {
                const index = crops.findIndex(c => c.id === isEditing);
                if (index !== -1) {
                    crops[index] = { ...crops[index], ...cropData };
                }
            } else {
                crops.push(cropData);
            }
            
            localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
            
            // Save to Firebase if user is authenticated
            if (currentUser && currentUser.uid) {
                db.collection('crops').doc(cropData.id).set({
                    ...cropData,
                    userId: currentUser.uid
                }).catch(error => console.error('Error saving to Firestore:', error));
            }
            
            loadCrops();
            closeModal('addCropModal');
            document.getElementById('addCropForm').reset();
            delete document.getElementById('addCropForm').dataset.editingId;
            
            showNotification(
                isEditing ? 'Crop updated successfully! 🌱' : 'New crop added successfully! 🌱', 
                'success'
            );
            autoSaveData();
        }

        function editCrop(cropId) {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const crop = crops.find(c => c.id === cropId);
            if (!crop) return;
            
            document.getElementById('cropName').value = crop.name;
            document.getElementById('cropVariety').value = crop.variety || '';
            document.getElementById('cropArea').value = crop.area;
            document.getElementById('cropSeason').value = crop.season;
            document.getElementById('cropLocation').value = crop.location || '';
            document.getElementById('sowingDate').value = crop.sowingDate;
            document.getElementById('expectedHarvest').value = crop.expectedHarvest;
            document.getElementById('expectedYield').value = crop.expectedYield || '';
            document.getElementById('expectedPrice').value = crop.expectedPrice || '';
            document.getElementById('cropNotes').value = crop.notes || '';
            
            document.querySelector('#addCropModal .modal-title span').textContent = 'Edit Crop';
            document.querySelector('#addCropForm button[type="submit"] span').textContent = 'Update Crop';
            
            document.getElementById('addCropForm').dataset.editingId = cropId;
            
            showAddCropModal();
        }

        function harvestCrop(cropId) {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const cropIndex = crops.findIndex(c => c.id === cropId);
            if (cropIndex === -1) return;
            
            crops[cropIndex].status = 'harvested';
            crops[cropIndex].harvestDate = new Date().toISOString().split('T')[0];
            
            localStorage.setItem(STORAGE_KEYS.CROPS, JSON.stringify(crops));
            
            // Update in Firebase
            if (currentUser && currentUser.uid) {
                db.collection('crops').doc(cropId).update({
                    status: 'harvested',
                    harvestDate: new Date().toISOString().split('T')[0],
                    updatedAt: new Date().toISOString()
                }).catch(error => console.error('Error updating Firestore:', error));
            }
            
            loadCrops();
            showNotification(`🎉 ${crops[cropIndex].name.charAt(0).toUpperCase() + crops[cropIndex].name.slice(1)} marked as harvested!`, 'success');
            autoSaveData();
        }

        function viewCropDetails(cropId) {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const crop = crops.find(c => c.id === cropId);
            if (!crop) return;
            
            const relatedTransactions = getRelatedTransactions(cropId);
            const totalExpenses = relatedTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalIncome = relatedTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const yieldPerAcre = crop.expectedYield ? (crop.expectedYield / crop.area).toFixed(2) : 'N/A';
            const progress = calculateCropProgress(crop);
            
            const modal = document.getElementById('cropDetailsModal');
            const content = document.getElementById('cropDetailsContent');
            
            content.innerHTML = `
                <div class="crop-details-header" style="display: flex; gap: 2rem; margin-bottom: 2rem;">
                    <img src="${crop.image || getCropImage(crop.name)}" alt="${crop.name}" style="width: 200px; height: 150px; object-fit: cover; border-radius: var(--border-radius-sm);">
                    <div style="flex: 1;">
                        <h2 style="color: var(--primary-color); margin-bottom: 0.5rem;">
                            ${getCropEmoji(crop.name)} ${crop.name.charAt(0).toUpperCase() + crop.name.slice(1)}
                            ${crop.variety ? `<small style="color: var(--text-secondary);"> (${crop.variety})</small>` : ''}
                        </h2>
                        <div class="crop-status ${crop.status}" style="display: inline-block; margin-bottom: 1rem;">
                            ${crop.status.charAt(0).toUpperCase() + crop.status.slice(1)}
                        </div>
                        <div class="grid grid-2 gap-1">
                            <div><strong>Location:</strong> ${crop.location || 'Not specified'}</div>
                            <div><strong>Season:</strong> ${crop.season.charAt(0).toUpperCase() + crop.season.slice(1)}</div>
                            <div><strong>Area:</strong> ${crop.area} acres</div>
                            <div><strong>Sowing Date:</strong> ${new Date(crop.sowingDate).toLocaleDateString()}</div>
                            <div><strong>Expected Harvest:</strong> ${new Date(crop.expectedHarvest).toLocaleDateString()}</div>
                            <div><strong>Progress:</strong> ${progress}%</div>
                        </div>
                    </div>
                </div>
                
                <div class="crop-financial-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--success-color);">
                            ₹${totalIncome.toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Income</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--error-color);">
                            ₹${totalExpenses.toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Expenses</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(46, 125, 50, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary-color);">
                            ₹${(totalIncome - totalExpenses).toLocaleString('en-IN')}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Net Profit</div>
                    </div>
                    <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.1); border-radius: var(--border-radius-sm);">
                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--warning-color);">
                            ${yieldPerAcre}t/ac
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Yield per Acre</div>
                    </div>
                </div>
                
                <div class="crop-progress-section" style="margin-bottom: 2rem;">
                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Growth Progress</h3>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar" style="width: ${progress}%"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.9rem; color: var(--text-secondary);">
                        <span>Sowing: ${new Date(crop.sowingDate).toLocaleDateString()}</span>
                        <span>${progress}% Complete</span>
                        <span>Harvest: ${new Date(crop.expectedHarvest).toLocaleDateString()}</span>
                    </div>
                </div>
                
                ${crop.notes ? `
                    <div class="crop-notes" style="margin-bottom: 2rem;">
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Notes</h3>
                        <p style="background: rgba(46, 125, 50, 0.05); padding: 1rem; border-radius: var(--border-radius-sm); border-left: 4px solid var(--primary-color);">
                            ${crop.notes}
                        </p>
                    </div>
                ` : ''}
                
                <div class="crop-actions-section" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="quickAddTransaction('${crop.id}'); closeModal('cropDetailsModal');">
                        <i class="fas fa-plus"></i> Add Transaction
                    </button>
                    <button class="btn btn-secondary" onclick="showCropTransactions('${crop.id}'); closeModal('cropDetailsModal');">
                        <i class="fas fa-list"></i> View All Transactions
                    </button>
                    <button class="btn btn-secondary" onclick="editCrop('${crop.id}'); closeModal('cropDetailsModal');">
                        <i class="fas fa-edit"></i> Edit Crop
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Enhanced Transaction Management
        function loadTransactions() {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            displayTransactions(transactions);
            displayRecentTransactionCards(transactions);
        }

        function displayRecentTransactionCards(transactions) {
            const recentTransactions = transactions.slice(-6).reverse();
            const container = document.getElementById('transactionCards');
            
            if (recentTransactions.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-coins" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>No recent transactions found</p>
                        <button class="btn btn-primary" style="margin-top: 1rem;" onclick="showAddTransactionModal()">
                            <i class="fas fa-plus"></i> Add First Transaction
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recentTransactions.map(transaction => {
                const crop = getCropById(transaction.cropId);
                const cropName = crop ? crop.name.charAt(0).toUpperCase() + crop.name.slice(1) : '';
                
                return `
                    <div class="transaction-card">
                        <div class="transaction-header">
                            <div class="transaction-type ${transaction.type}">
                                <i class="fas fa-${transaction.type === 'income' ? 'arrow-up' : 'arrow-down'}"></i>
                                ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                            </div>
                            <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-error'}">
                                ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString('en-IN')}
                            </div>
                        </div>
                        <div style="margin: 0.5rem 0;">
                            <strong>${transaction.description}</strong>
                        </div>
                        <div class="transaction-details">
                            <div class="transaction-detail">
                                <i class="fas fa-tag"></i>
                                <span>${transaction.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            </div>
                            <div class="transaction-detail">
                                <i class="fas fa-calendar"></i>
                                <span>${new Date(transaction.date).toLocaleDateString()}</span>
                            </div>
                        </div>
                        ${cropName ? `
                            <div style="margin-top: 0.5rem;">
                                <span style="background: rgba(46, 125, 50, 0.1); color: var(--primary-color); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                    🌱 ${cropName}
                                </span>
                            </div>
                        ` : ''}
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" style="font-size: 0.8rem; flex: 1;" onclick="editTransaction('${transaction.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-error" style="font-size: 0.8rem; flex: 1;" onclick="deleteTransaction('${transaction.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsTableBody');
            
            if (transactions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 3rem;">
                            <div>
                                <i class="fas fa-coins" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem; opacity: 0.5;"></i>
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">No transactions recorded yet</h3>
                                <p style="color: var(--text-secondary); margin-bottom: 2rem;">Start tracking your farm's financial activities by adding your first transaction.</p>
                                <button class="btn btn-primary" onclick="showAddTransactionModal()">
                                    <i class="fas fa-plus"></i> Add First Transaction
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const displayTransactions = transactions.slice(-10).reverse();
            tbody.innerHTML = displayTransactions.map(transaction => {
                const crop = getCropById(transaction.cropId);
                const cropName = crop ? crop.name.charAt(0).toUpperCase() + crop.name.slice(1) : '';
                
                return `
                    <tr style="transition: all 0.2s ease;">
                        <td>${new Date(transaction.date).toLocaleDateString('en-IN')}</td>
                        <td>
                            ${transaction.description}
                            ${cropName ? `<small style="color: var(--text-secondary); display: block;">🌱 ${cropName}</small>` : ''}
                        </td>
                        <td><span class="badge" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">${transaction.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span></td>
                        <td><span class="badge ${transaction.type === 'income' ? 'bg-success' : 'bg-error'}">${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}</span></td>
                        <td class="${transaction.type === 'income' ? 'text-success' : 'text-error'}" style="font-weight: bold;">
                            ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString('en-IN')}
                        </td>
                        <td>
                            <button class="btn btn-secondary" style="font-size: 0.8rem; margin-right: 0.25rem;" onclick="editTransaction('${transaction.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-error" style="font-size: 0.8rem;" onclick="deleteTransaction('${transaction.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getCropById(cropId) {
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            return crops.find(c => c.id === cropId);
        }

        function showAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.add('active');
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            loadCropsIntoTransactionModal();
        }

        function updateTransactionCategories() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('transactionCategory');
            
            let categories = [];
            if (type === 'income') {
                categories = [
                    { value: 'crop-sale', label: '🌾 Crop Sale' },
                    { value: 'livestock-sale', label: '🐄 Livestock Sale' },
                    { value: 'government-subsidy', label: '🏛️ Government Subsidy' },
                    { value: 'contract-farming', label: '📋 Contract Farming' },
                    { value: 'other-income', label: '💰 Other Income' }
                ];
            } else if (type === 'expense') {
                categories = [
                    { value: 'seeds', label: '🌱 Seeds' },
                    { value: 'fertilizers', label: '🧪 Fertilizers' },
                    { value: 'pesticides', label: '🪲 Pesticides' },
                    { value: 'equipment', label: '🚜 Equipment' },
                    { value: 'labor', label: '👨‍🌾 Labor' },
                    { value: 'fuel', label: '⛽ Fuel' },
                    { value: 'irrigation', label: '💧 Irrigation' },
                    { value: 'transportation', label: '🚚 Transportation' },
                    { value: 'loan-payment', label: '🏦 Loan Payment' },
                    { value: 'other-expense', label: '💳 Other Expense' }
                ];
            }
            
            categorySelect.innerHTML = '<option value="">Select Category</option>' +
                categories.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('');
        }

        function handleAddTransaction(e) {
            e.preventDefault();
            
            const isEditing = document.getElementById('addTransactionForm').dataset.editingId;
            const transactionData = {
                id: isEditing || Date.now().toString(),
                type: document.getElementById('transactionType').value,
                category: document.getElementById('transactionCategory').value,
                description: document.getElementById('transactionDescription').value,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                date: document.getElementById('transactionDate').value,
                paymentMethod: document.getElementById('transactionPaymentMethod').value,
                cropId: document.getElementById('transactionCropId').value || null,
                notes: document.getElementById('transactionNotes').value,
                createdAt: isEditing ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            
            if (isEditing) {
                const index = transactions.findIndex(t => t.id === isEditing);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...transactionData };
                }
            } else {
                transactions.push(transactionData);
            }
            
            localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(transactions));
            
            // Save to Firebase if user is authenticated
            if (currentUser && currentUser.uid) {
                db.collection('transactions').doc(transactionData.id).set({
                    ...transactionData,
                    userId: currentUser.uid
                }).catch(error => console.error('Error saving to Firestore:', error));
            }
            
            loadTransactions();
            updateDashboardStats();
            loadCrops();
            closeModal('addTransactionModal');
            document.getElementById('addTransactionForm').reset();
            delete document.getElementById('addTransactionForm').dataset.editingId;
            
            const emoji = transactionData.type === 'income' ? '💰' : '💳';
            showNotification(
                `${emoji} ${isEditing ? 'Transaction updated' : 'Transaction added'} successfully!`, 
                'success'
            );
            autoSaveData();
        }

        function editTransaction(transactionId) {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            const transaction = transactions.find(t => t.id === transactionId);
            if (!transaction) return;
            
            document.getElementById('transactionType').value = transaction.type;
            updateTransactionCategories();
            document.getElementById('transactionCategory').value = transaction.category;
            document.getElementById('transactionDescription').value = transaction.description;
            document.getElementById('transactionAmount').value = transaction.amount;
            document.getElementById('transactionDate').value = transaction.date;
            document.getElementById('transactionPaymentMethod').value = transaction.paymentMethod || 'cash';
            document.getElementById('transactionCropId').value = transaction.cropId || '';
            document.getElementById('transactionNotes').value = transaction.notes || '';
            
            document.querySelector('#addTransactionModal .modal-title span').textContent = 'Edit Transaction';
            document.querySelector('#addTransactionForm button[type="submit"] span').textContent = 'Update Transaction';
            document.getElementById('addTransactionForm').dataset.editingId = transactionId;
            
            showAddTransactionModal();
        }

        function deleteTransaction(transactionId) {
            if (confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
                const filteredTransactions = transactions.filter(t => t.id !== transactionId);
                localStorage.setItem(STORAGE_KEYS.TRANSACTIONS, JSON.stringify(filteredTransactions));
                
                // Delete from Firebase
                if (currentUser && currentUser.uid) {
                    db.collection('transactions').doc(transactionId).delete()
                        .catch(error => console.error('Error deleting from Firestore:', error));
                }
                
                loadTransactions();
                updateDashboardStats();
                loadCrops();
                showNotification('🗑️ Transaction deleted successfully!', 'success');
                autoSaveData();
            }
        }

        function filterTransactions() {
            const typeFilter = document.getElementById('transactionTypeFilter').value;
            const categoryFilter = document.getElementById('transactionCategoryFilter').value;
            const searchFilter = document.getElementById('transactionSearchFilter').value.toLowerCase();
            
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            
            const filteredTransactions = transactions.filter(transaction => {
                const matchesType = !typeFilter || transaction.type === typeFilter;
                const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
                const matchesSearch = !searchFilter || 
                    transaction.description.toLowerCase().includes(searchFilter) ||
                    (transaction.notes && transaction.notes.toLowerCase().includes(searchFilter));
                
                return matchesType && matchesCategory && matchesSearch;
            });
            
            displayTransactions(filteredTransactions);
        }

        function showAllTransactions() {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            const modal = document.getElementById('allTransactionsModal');
            const content = document.getElementById('allTransactionsContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <div class="transaction-summary" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: var(--border-radius-sm);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--success-color);">
                                ₹${transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0).toLocaleString('en-IN')}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Income</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.1); border-radius: var(--border-radius-sm);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--error-color);">
                                ₹${transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0).toLocaleString('en-IN')}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Total Expenses</div>
                        </div>
                        <div class="stat-card" style="text-align: center; padding: 1rem; background: rgba(46, 125, 50, 0.1); border-radius: var(--border-radius-sm);">
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);">
                                ₹${(transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) - transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0)).toLocaleString('en-IN')}
                            </div>
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">Net Profit</div>
                        </div>
                    </div>
                </div>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    ${transactions.length > 0 ? 
                        transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).map(transaction => {
                            const crop = getCropById(transaction.cropId);
                            const cropName = crop ? crop.name.charAt(0).toUpperCase() + crop.name.slice(1) : '';
                            
                            return `
                                <div class="transaction-card">
                                    <div class="transaction-header">
                                        <div class="transaction-type ${transaction.type}">
                                            <i class="fas fa-${transaction.type === 'income' ? 'arrow-up' : 'arrow-down'}"></i>
                                            ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
                                        </div>
                                        <div class="transaction-amount ${transaction.type === 'income' ? 'text-success' : 'text-error'}">
                                            ${transaction.type === 'income' ? '+' : '-'}₹${transaction.amount.toLocaleString('en-IN')}
                                        </div>
                                    </div>
                                    <div class="transaction-details">
                                        <div class="transaction-detail">
                                            <i class="fas fa-tag"></i>
                                            <span>${transaction.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                        </div>
                                        <div class="transaction-detail">
                                            <i class="fas fa-calendar"></i>
                                            <span>${new Date(transaction.date).toLocaleDateString()}</span>
                                        </div>
                                        ${cropName ? `
                                            <div class="transaction-detail">
                                                <i class="fas fa-seedling"></i>
                                                <span>${cropName}</span>
                                            </div>
                                        ` : ''}
                                    </div>
                                    <div style="margin-top: 0.5rem;">
                                        <strong>Description:</strong> ${transaction.description}
                                    </div>
                                    ${transaction.notes ? `<div style="margin-top: 0.5rem; font-style: italic; color: var(--text-secondary);">${transaction.notes}</div>` : ''}
                                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                        <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="editTransaction('${transaction.id}'); closeModal('allTransactionsModal');">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-error" style="font-size: 0.8rem;" onclick="deleteTransaction('${transaction.id}'); setTimeout(() => showAllTransactions(), 100);">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('') : 
                        '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No transactions found</div>'
                    }
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Enhanced Weather Functions
        async function loadWeatherData() {
            try {
                const location = localStorage.getItem('weather_location') || 'Delhi,IN';
                await getWeatherByTomorrowAPI(location);
            } catch (error) {
                console.error('Error loading weather data:', error);
                showSampleWeatherData();
            }
        }

        async function getWeatherByTomorrowAPI(location) {
            try {
                const response = await fetch(`${WEATHER_API_BASE}?location=${location}&apikey=${WEATHER_API_KEY}&units=metric&timesteps=1h&fields=temperature,humidity,windSpeed,precipitationProbability,weatherCode,uvIndex,visibility,pressureSurfaceLevel&startTime=now&endTime=nowPlus5d`);
                
                if (!response.ok) {
                    throw new Error('Weather API request failed');
                }
                
                const data = await response.json();
                updateWeatherDisplay(data);
            } catch (error) {
                console.error('Tomorrow.io API error:', error);
                showSampleWeatherData();
            }
        }

        function updateWeatherDisplay(data) {
            if (!data.timelines || !data.timelines.hourly || data.timelines.hourly.length === 0) {
                showSampleWeatherData();
                return;
            }

            const current = data.timelines.hourly[0].values;
            const temperature = Math.round(current.temperature);
            const humidity = Math.round(current.humidity);
            const windSpeed = Math.round(current.windSpeed * 3.6); // Convert m/s to km/h
            const rainChance = Math.round(current.precipitationProbability);
            const uvIndex = Math.round(current.uvIndex);
            const pressure = Math.round(current.pressureSurfaceLevel);
            const visibility = Math.round(current.visibility);
            const feelsLike = temperature + 2; // Approximate feels like temperature

            // Update dashboard weather
            const weatherIcon = getWeatherIconFromCode(current.weatherCode);
            updateWeatherIcon(weatherIcon);
            document.getElementById('weatherTemp').textContent = `${temperature}°C`;
            document.getElementById('weatherDesc').textContent = getWeatherDescription(temperature, rainChance);
            document.getElementById('weatherRain').textContent = `${rainChance}%`;
            document.getElementById('rainFill').style.width = `${rainChance}%`;
            document.getElementById('weatherHumidity').textContent = `${humidity}%`;
            document.getElementById('weatherWind').textContent = `${windSpeed} km/h`;
            document.getElementById('weatherUV').textContent = uvIndex;
            document.getElementById('weatherFeels').textContent = `${feelsLike}°C`;

            // Update detailed weather section if visible
            if (!document.getElementById('weather').classList.contains('hidden')) {
                const elements = {
                    currentTemp: document.getElementById('currentTemp'),
                    currentDesc: document.getElementById('currentDesc'),
                    feelsLike: document.getElementById('feelsLike'),
                    currentHumidity: document.getElementById('currentHumidity'),
                    currentWind: document.getElementById('currentWind'),
                    currentPressure: document.getElementById('currentPressure'),
                    uvIndex: document.getElementById('uvIndex'),
                    rainChance: document.getElementById('rainChance'),
                    rainChanceFill: document.getElementById('rainChanceFill'),
                    visibility: document.getElementById('visibility'),
                    soilTemp: document.getElementById('soilTemp')
                };

                if (elements.currentTemp) elements.currentTemp.textContent = `${temperature}°C`;
                if (elements.currentDesc) elements.currentDesc.textContent = getWeatherDescription(temperature, rainChance);
                if (elements.feelsLike) elements.feelsLike.textContent = `${feelsLike}°C`;
                if (elements.currentHumidity) elements.currentHumidity.textContent = `${humidity}%`;
                if (elements.currentWind) elements.currentWind.textContent = `${windSpeed} km/h`;
                if (elements.currentPressure) elements.currentPressure.textContent = `${pressure} hPa`;
                if (elements.uvIndex) elements.uvIndex.textContent = uvIndex;
                if (elements.rainChance) elements.rainChance.textContent = `${rainChance}%`;
                if (elements.rainChanceFill) elements.rainChanceFill.style.width = `${rainChance}%`;
                if (elements.visibility) elements.visibility.textContent = `${visibility} km`;
                if (elements.soilTemp) elements.soilTemp.textContent = `${temperature - 2}°C`;
                
                updateFarmingAlerts(temperature, humidity, rainChance, uvIndex);
                updateWeatherForecast(data);
            }
        }

        function getWeatherIconFromCode(weatherCode) {
            const codes = {
                1000: 'sunny',
                1100: 'partly-cloudy',
                1101: 'cloudy',
                1102: 'cloudy',
                2000: 'cloudy',
                4000: 'rainy',
                4001: 'rainy',
                8000: 'rainy'
            };
            return codes[weatherCode] || 'sunny';
        }

        function showSampleWeatherData() {
            const temperature = 28 + Math.random() * 10 - 5;
            const humidity = 65 + Math.random() * 20 - 10;
            const windSpeed = 12 + Math.random() * 8;
            const uvIndex = 6 + Math.random() * 4;
            const rainChance = Math.floor(Math.random() * 100);
            const feelsLike = temperature + 3;
            
            updateWeatherIcon('sunny');
            document.getElementById('weatherTemp').textContent = `${Math.round(temperature)}°C`;
            document.getElementById('weatherDesc').textContent = getWeatherDescription(temperature, rainChance);
            document.getElementById('weatherRain').textContent = `${rainChance}%`;
            document.getElementById('rainFill').style.width = `${rainChance}%`;
            document.getElementById('weatherHumidity').textContent = `${Math.round(humidity)}%`;
            document.getElementById('weatherWind').textContent = `${Math.round(windSpeed)} km/h`;
            document.getElementById('weatherUV').textContent = Math.round(uvIndex);
            document.getElementById('weatherFeels').textContent = `${Math.round(feelsLike)}°C`;
            
            if (!document.getElementById('weather').classList.contains('hidden')) {
                const elements = {
                    currentTemp: document.getElementById('currentTemp'),
                    currentDesc: document.getElementById('currentDesc'),
                    feelsLike: document.getElementById('feelsLike'),
                    currentHumidity: document.getElementById('currentHumidity'),
                    currentWind: document.getElementById('currentWind'),
                    currentPressure: document.getElementById('currentPressure'),
                    uvIndex: document.getElementById('uvIndex'),
                    rainChance: document.getElementById('rainChance'),
                    rainChanceFill: document.getElementById('rainChanceFill'),
                    visibility: document.getElementById('visibility'),
                    soilTemp: document.getElementById('soilTemp')
                };

                if (elements.currentTemp) elements.currentTemp.textContent = `${Math.round(temperature)}°C`;
                if (elements.currentDesc) elements.currentDesc.textContent = getWeatherDescription(temperature, rainChance);
                if (elements.feelsLike) elements.feelsLike.textContent = `${Math.round(feelsLike)}°C`;
                if (elements.currentHumidity) elements.currentHumidity.textContent = `${Math.round(humidity)}%`;
                if (elements.currentWind) elements.currentWind.textContent = `${Math.round(windSpeed)} km/h`;
                if (elements.currentPressure) elements.currentPressure.textContent = `1013 hPa`;
                if (elements.uvIndex) elements.uvIndex.textContent = Math.round(uvIndex);
                if (elements.rainChance) elements.rainChance.textContent = `${rainChance}%`;
                if (elements.rainChanceFill) elements.rainChanceFill.style.width = `${rainChance}%`;
                if (elements.visibility) elements.visibility.textContent = `10 km`;
                if (elements.soilTemp) elements.soilTemp.textContent = `${Math.round(temperature - 2)}°C`;
                
                updateFarmingAlerts(temperature, humidity, rainChance, uvIndex);
                updateSampleWeatherForecast();
            }
        }

        function getWeatherDescription(temperature, rainChance) {
            if (rainChance > 80) return 'Heavy Rain Expected ⛈️';
            if (rainChance > 60) return 'Rain Likely 🌧️';
            if (rainChance > 30) return 'Partly Cloudy ⛅';
            if (temperature > 35) return 'Very Hot ☀️';
            if (temperature > 25) return 'Warm & Sunny 🌤️';
            if (temperature > 15) return 'Pleasant 😊';
            return 'Cool 🌥️';
        }

        function updateWeatherIcon(condition) {
            const iconElement = document.getElementById('weatherIcon');
            const currentIconElement = document.getElementById('currentWeatherIcon');
            
            let iconClass;
            switch(condition) {
                case 'rainy':
                    iconClass = 'fas fa-cloud-rain';
                    break;
                case 'cloudy':
                    iconClass = 'fas fa-cloud';
                    break;
                case 'sunny':
                    iconClass = 'fas fa-sun';
                    break;
                case 'partly-cloudy':
                    iconClass = 'fas fa-cloud-sun';
                    break;
                default:
                    iconClass = 'fas fa-sun';
            }
            
            if (iconElement) iconElement.className = iconClass;
            if (currentIconElement) currentIconElement.className = iconClass;
        }

        function updateFarmingAlerts(temperature, humidity, rainChance, uvIndex) {
            const alerts = [];
            
            if (temperature > 35) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-thermometer-full',
                    message: 'High temperature alert! Consider extra irrigation for sensitive crops.',
                    color: 'warning'
                });
            }
            
            if (humidity > 80) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-tint',
                    message: 'High humidity detected. Monitor crops for fungal diseases.',
                    color: 'warning'
                });
            }
            
            if (rainChance > 70) {
                alerts.push({
                    type: 'info',
                    icon: 'fas fa-cloud-rain',
                    message: 'Heavy rain expected. Ensure proper drainage in fields.',
                    color: 'primary'
                });
            }
            
            if (uvIndex > 7) {
                alerts.push({
                    type: 'warning',
                    icon: 'fas fa-sun',
                    message: 'High UV index. Consider shade protection for sensitive plants.',
                    color: 'warning'
                });
            }
            
            if (alerts.length === 0) {
                alerts.push({
                    type: 'success',
                    icon: 'fas fa-check-circle',
                    message: 'Weather conditions are favorable for farming activities.',
                    color: 'success'
                });
            }
            
            const alertsContainer = document.getElementById('farmingAlerts');
            if (alertsContainer) {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="alert" style="display: flex; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; border-radius: var(--border-radius-sm); border-left: 4px solid var(--${alert.color}-color); background: rgba(${alert.color === 'success' ? '16,185,129' : alert.color === 'warning' ? '245,158,11' : '46,125,50'}, 0.1);">
                        <i class="${alert.icon}" style="color: var(--${alert.color}-color); margin-right: 0.75rem; font-size: 1.1rem;"></i>
                        <span>${alert.message}</span>
                    </div>
                `).join('');
            }
        }

        function updateWeatherForecast(data) {
            const forecastContainer = document.getElementById('weatherForecast');
            if (!forecastContainer || !data.timelines || !data.timelines.daily) return;
            
            const dailyData = data.timelines.daily.slice(0, 5);
            
            forecastContainer.innerHTML = dailyData.map((day, index) => {
                const values = day.values;
                const temp = Math.round(values.temperatureAvg || values.temperature);
                const rain = Math.round(values.precipitationProbability);
                const dayName = index === 0 ? 'Today' : new Date(day.time).toLocaleDateString('en', { weekday: 'short' });
                const weatherIcon = getWeatherIconFromCode(values.weatherCode);
                
                return `
                    <div class="forecast-day" style="text-align: center; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--card-bg); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">${dayName}</div>
                        <i class="fas fa-${weatherIcon === 'sunny' ? 'sun' : weatherIcon === 'cloudy' ? 'cloud' : weatherIcon === 'rainy' ? 'cloud-rain' : 'cloud-sun'}" style="font-size: 1.8rem; color: var(--accent-color); margin-bottom: 0.5rem;"></i>
                        <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.25rem;">${temp}°C</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${getWeatherDescription(temp, rain)}</div>
                        <div class="rain-percentage" style="font-size: 0.7rem; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                            <i class="fas fa-cloud-rain"></i> ${rain}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateSampleWeatherForecast() {
            const forecastContainer = document.getElementById('weatherForecast');
            if (!forecastContainer) return;
            
            const days = ['Today', 'Tomorrow', 'Day 3', 'Day 4', 'Day 5'];
            const icons = ['fas fa-sun', 'fas fa-cloud-sun', 'fas fa-cloud-rain', 'fas fa-cloud', 'fas fa-sun'];
            
            forecastContainer.innerHTML = days.map((day, index) => {
                const temp = 28 + (Math.random() * 10 - 5);
                const rain = Math.floor(Math.random() * 100);
                
                return `
                    <div class="forecast-day" style="text-align: center; padding: 1.5rem; border: 1px solid var(--border-color); border-radius: var(--border-radius); background: var(--card-bg); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--primary-color);">${day}</div>
                        <i class="${icons[index]}" style="font-size: 1.8rem; color: var(--accent-color); margin-bottom: 0.5rem;"></i>
                        <div style="font-size: 1.3rem; font-weight: bold; margin-bottom: 0.25rem;">${Math.round(temp)}°C</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${getWeatherDescription(temp, rain)}</div>
                        <div class="rain-percentage" style="font-size: 0.7rem; color: var(--primary-color); display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                            <i class="fas fa-cloud-rain"></i> ${rain}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function getWeatherByLocation() {
            const location = document.getElementById('weatherLocation').value;
            if (!location) {
                showNotification('Please enter a location', 'warning');
                return;
            }
            
            showNotification(`Getting weather for ${location}... 🌤️`, 'info');
            localStorage.setItem('weather_location', location);
            await getWeatherByTomorrowAPI(location);
            showNotification(`Weather updated for ${location}! ✅`, 'success');
        }

        async function getCurrentLocationWeather() {
            if (navigator.geolocation) {
                showNotification('Getting your location... 📍', 'info');
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        const location = `${latitude},${longitude}`;
                        localStorage.setItem('weather_location', location);
                        await getWeatherByTomorrowAPI(location);
                        showNotification('Weather updated for current location! 🎯', 'success');
                    },
                    () => {
                        showNotification('Unable to get your location 📍', 'error');
                    }
                );
            } else {
                showNotification('Geolocation not supported by your browser', 'error');
            }
        }

        // Enhanced Loan Management
        function loadLoans() {
            const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            displayLoans(loans);
            displayEMICalendar(loans);
        }

        function displayLoans(loans) {
            const container = document.getElementById('loansList');
            
            if (loans.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <i class="fas fa-hand-holding-usd" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">No loans recorded yet</h3>
                        <p style="margin-bottom: 2rem;">Start tracking your agricultural loans and EMI payments.</p>
                        <button class="btn btn-primary" onclick="showAddLoanModal()">
                            <i class="fas fa-plus"></i> Add Your First Loan
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = loans.map(loan => {
                const nextEMIDate = getNextEMIDate(loan);
                const daysToEMI = Math.ceil((nextEMIDate - new Date()) / (1000 * 60 * 60 * 24));
                const progressPercentage = ((loan.paidEMIs || 0) / loan.tenure) * 100;
                
                return `
                    <div class="card" style="margin-bottom: 1rem; animation: slideInUp 0.5s ease;">
                        <div class="loan-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <div>
                                <h3 style="color: var(--primary-color); margin-bottom: 0.25rem;">${loan.provider}</h3>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">${loan.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</div>
                            </div>
                            <div class="loan-status" style="text-align: right;">
                                <div class="badge ${loan.status === 'active' ? 'bg-success' : 'bg-warning'}">${loan.status.toUpperCase()}</div>
                                ${daysToEMI <= 7 && daysToEMI > 0 ? `<div style="font-size: 0.8rem; color: var(--warning-color); margin-top: 0.25rem;">EMI Due in ${daysToEMI} days</div>` : ''}
                            </div>
                        </div>
                        
                        <div class="loan-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="loan-detail" style="text-align: center; padding: 1rem; background: rgba(46, 125, 50, 0.05); border-radius: var(--border-radius-sm);">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">₹${loan.amount.toLocaleString('en-IN')}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Loan Amount</div>
                            </div>
                            <div class="loan-detail" style="text-align: center; padding: 1rem; background: rgba(245, 158, 11, 0.05); border-radius: var(--border-radius-sm);">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning-color);">₹${loan.monthlyEMI.toLocaleString('en-IN')}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Monthly EMI</div>
                            </div>
                            <div class="loan-detail" style="text-align: center; padding: 1rem; background: rgba(239, 68, 68, 0.05); border-radius: var(--border-radius-sm);">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--error-color);">₹${(loan.remainingAmount || loan.amount).toLocaleString('en-IN')}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Remaining</div>
                            </div>
                            <div class="loan-detail" style="text-align: center; padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: var(--border-radius-sm);">
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--info-color);">${loan.interestRate}%</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Interest Rate</div>
                            </div>
                        </div>
                        
                        <div class="loan-progress" style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                <span>Payment Progress</span>
                                <span>${loan.paidEMIs || 0}/${loan.tenure} EMIs paid</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" style="width: ${progressPercentage}%"></div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                            <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                <i class="fas fa-calendar-alt"></i> Next EMI: ${nextEMIDate.toLocaleDateString()}
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-warning" style="font-size: 0.8rem;" onclick="payEMI('${loan.id}')">
                                    <i class="fas fa-credit-card"></i> Pay EMI
                                </button>
                                <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="viewLoanDetails('${loan.id}')">
                                    <i class="fas fa-eye"></i> Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function displayEMICalendar(loans) {
            const container = document.getElementById('emiCalendar');
            const today = new Date();
            const upcomingEMIs = [];
            
            loans.forEach(loan => {
                if (loan.status === 'active') {
                    for (let i = 0; i < 12; i++) {
                        const emiDate = new Date(today);
                        emiDate.setMonth(emiDate.getMonth() + i);
                        emiDate.setDate(loan.emiDate);
                        
                        if (emiDate > today) {
                            upcomingEMIs.push({
                                loan,
                                date: emiDate,
                                amount: loan.monthlyEMI
                            });
                        }
                    }
                }
            });
            
            upcomingEMIs.sort((a, b) => a.date - b.date);
            
            container.innerHTML = `
                <div class="emi-calendar-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem;">
                    ${upcomingEMIs.slice(0, 6).map(emi => {
                        const daysUntil = Math.ceil((emi.date - today) / (1000 * 60 * 60 * 24));
                        
                        return `
                            <div class="emi-item" style="padding: 1rem; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); background: var(--card-bg); transition: transform 0.2s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 0.5rem;">
                                    ${emi.loan.provider}
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                    ${emi.date.toLocaleDateString()}
                                </div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: var(--warning-color); margin-bottom: 0.5rem;">
                                    ₹${emi.amount.toLocaleString('en-IN')}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">
                                    ${daysUntil} days remaining
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function showAddLoanModal() {
            document.getElementById('addLoanModal').classList.add('active');
            document.getElementById('loanStartDate').value = new Date().toISOString().split('T')[0];
        }

        function handleAddLoan(e) {
            e.preventDefault();
            
            const isEditing = document.getElementById('addLoanForm').dataset.editingId;
            const loanData = {
                id: isEditing || Date.now().toString(),
                provider: document.getElementById('loanProvider').value,
                type: document.getElementById('loanType').value,
                amount: parseFloat(document.getElementById('loanAmount').value),
                interestRate: parseFloat(document.getElementById('interestRate').value),
                tenure: parseInt(document.getElementById('loanTenure').value),
                startDate: document.getElementById('loanStartDate').value,
                emiDate: parseInt(document.getElementById('emiDate').value),
                purpose: document.getElementById('loanPurpose').value,
                status: 'active',
                paidEMIs: 0,
                remainingAmount: parseFloat(document.getElementById('loanAmount').value),
                createdAt: isEditing ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // Calculate EMI
            const monthlyRate = loanData.interestRate / 100 / 12;
            loanData.monthlyEMI = Math.round(loanData.amount * (monthlyRate * Math.pow(1 + monthlyRate, loanData.tenure)) / (Math.pow(1 + monthlyRate, loanData.tenure) - 1));
            
            let loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
            
            if (isEditing) {
                const index = loans.findIndex(l => l.id === isEditing);
                if (index !== -1) {
                    loans[index] = { ...loans[index], ...loanData };
                }
            } else {
                loans.push(loanData);
            }
            
            localStorage.setItem(STORAGE_KEYS.LOANS, JSON.stringify(loans));
            
            // Save to Firebase if user is authenticated
            if (currentUser && currentUser.uid) {
                db.collection('loans').doc(loanData.id).set({
                    ...loanData,
                    userId: currentUser.uid
                }).catch(error => console.error('Error saving to Firestore:', error));
            }
            
            loadLoans();
            updateDashboardStats();
            checkEMIReminders();
            closeModal('addLoanModal');
            document.getElementById('addLoanForm').reset();
            delete document.getElementById('addLoanForm').dataset.editingId;
            
            showNotification(
                `💳 ${isEditing ? 'Loan updated' : 'Loan added'} successfully!`, 
                'success'
            );
            autoSaveData();
        }

        // Enhanced Asset Management
        function loadAssets() {
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            displayAssets(assets);
            updateAssetCounts(assets);
        }

        function displayAssets(assets) {
            const assetsList = document.getElementById('assetsList');
            
            if (assets.length === 0) {
                assetsList.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                        <i class="fas fa-tractor" style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 2rem; opacity: 0.5;"></i>
                        <h3 style="color: var(--primary-color); margin-bottom: 1rem;">No assets recorded yet</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                            Start tracking your farm equipment, livestock, land, and inventory to better manage your agricultural assets.
                        </p>
                        <button class="btn btn-primary" onclick="showAddAssetModal()">
                            <i class="fas fa-plus"></i> Add Your First Asset
                        </button>
                    </div>
                `;
                return;
            }
            
            assetsList.innerHTML = assets.map(asset => {
                const icon = getAssetIcon(asset.type);
                const currentValue = calculateCurrentValue(asset);
                const relatedTransactions = getAssetTransactions(asset.id);
                
                return `
                    <div class="card asset-card" style="animation: slideInUp 0.5s ease;">
                        <div class="asset-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <i class="${icon}" style="color: var(--primary-color); font-size: 1.5rem;"></i>
                                    <h3 style="margin: 0;">${asset.name}</h3>
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); text-transform: capitalize;">${asset.type.replace('-', ' ')}</div>
                            </div>
                            <div class="asset-value" style="text-align: right;">
                                <div style="font-size: 1.3rem; font-weight: bold; color: var(--primary-color);">₹${currentValue.toLocaleString('en-IN')}</div>
                                <div style="font-size: 0.8rem; color: var(--text-secondary);">Current Value</div>
                            </div>
                        </div>
                        
                        ${asset.purchaseDate ? `
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">
                                <i class="fas fa-calendar"></i> Purchased: ${new Date(asset.purchaseDate).toLocaleDateString('en-IN')}
                            </div>
                        ` : ''}
                        
                        ${getAssetDetails(asset)}
                        
                        ${relatedTransactions.length > 0 ? `
                            <div style="background: rgba(255, 107, 53, 0.05); padding: 1.5rem; border-radius: var(--border-radius-sm); margin: 1.5rem 0; border-left: 4px solid var(--accent-color);">
                                <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--accent-color);">
                                    <i class="fas fa-receipt"></i> Related Expenses (${relatedTransactions.length})
                                </div>
                                ${relatedTransactions.slice(0, 2).map(transaction => `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid rgba(255, 107, 53, 0.1); transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255, 107, 53, 0.05)'; this.style.borderRadius='var(--border-radius-xs)'" onmouseout="this.style.background='transparent'">
                                        <div>
                                            <span style="font-size: 0.8rem;">${transaction.description}</span>
                                        </div>
                                        <div class="text-error" style="font-weight: 500;">
                                            -₹${transaction.amount.toLocaleString('en-IN')}
                                        </div>
                                    </div>
                                `).join('')}
                                ${relatedTransactions.length > 2 ? `<div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center; margin-top: 0.5rem;">+${relatedTransactions.length - 2} more</div>` : ''}
                            </div>
                        ` : ''}
                        
                        <div class="asset-actions" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="viewAssetDetails('${asset.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-primary" style="font-size: 0.8rem;" onclick="addAssetTransaction('${asset.id}')">
                                <i class="fas fa-plus"></i> Add Expense
                            </button>
                            <button class="btn btn-error" style="font-size: 0.8rem;" onclick="deleteAsset('${asset.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getAssetTransactions(assetId) {
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            return transactions.filter(t => t.assetId === assetId);
        }

        function addAssetTransaction(assetId) {
            showAddTransactionModal();
            document.getElementById('transactionType').value = 'expense';
            updateTransactionCategories();
            
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const asset = assets.find(a => a.id === assetId);
            if (asset) {
                document.getElementById('transactionDescription').value = `${asset.name} - `;
                document.getElementById('transactionNotes').value = `Related to asset: ${asset.name}`;
            }
        }

        function getAssetDetails(asset) {
            switch(asset.type) {
                case 'equipment':
                    return `
                        <div class="asset-details" style="background: rgba(46, 125, 50, 0.05); padding: 1rem; border-radius: var(--border-radius-sm); margin: 1rem 0;">
                            <div style="margin-bottom: 0.5rem;"><strong>🔧 Condition:</strong> ${asset.condition || 'Good'}</div>
                            ${asset.maintenanceCost ? `<div><strong>💰 Annual Maintenance:</strong> ₹${asset.maintenanceCost.toLocaleString('en-IN')}</div>` : ''}
                        </div>
                    `;
                case 'livestock':
                    return `
                        <div class="asset-details" style="background: rgba(46, 125, 50, 0.05); padding: 1rem; border-radius: var(--border-radius-sm); margin: 1rem 0;">
                            <div style="margin-bottom: 0.5rem;"><strong>🔢 Count:</strong> ${asset.count || 1}</div>
                            ${asset.breed ? `<div style="margin-bottom: 0.5rem;"><strong>🐄 Breed:</strong> ${asset.breed}</div>` : ''}
                            <div><strong>💚 Health:</strong> <span class="text-${asset.health === 'healthy' ? 'success' : 'warning'}">${asset.health || 'Healthy'}</span></div>
                        </div>
                    `;
                case 'land':
                    return `
                        <div class="asset-details" style="background: rgba(46, 125, 50, 0.05); padding: 1rem; border-radius: var(--border-radius-sm); margin: 1rem 0;">
                            <div style="margin-bottom: 0.5rem;"><strong>📏 Size:</strong> ${asset.size || 0} acres</div>
                            <div><strong>🏠 Type:</strong> ${asset.landType || 'Owned'}</div>
                        </div>
                    `;
                case 'inventory':
                    return `
                        <div class="asset-details" style="background: rgba(46, 125, 50, 0.05); padding: 1rem; border-radius: var(--border-radius-sm); margin: 1rem 0;">
                            <div><strong>📦 Quantity:</strong> ${asset.quantity || 0} ${asset.unit || 'units'}</div>
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function updateAssetCounts(assets) {
            const counts = {
                equipment: assets.filter(a => a.type === 'equipment').length,
                livestock: assets.filter(a => a.type === 'livestock').reduce((sum, a) => sum + (a.count || 1), 0),
                land: assets.filter(a => a.type === 'land').length,
                inventory: assets.filter(a => a.type === 'inventory').length
            };
            
            const elements = {
                equipmentCount: document.getElementById('equipmentCount'),
                livestockCount: document.getElementById('livestockCount'),
                landCount: document.getElementById('landCount'),
                inventoryCount: document.getElementById('inventoryCount')
            };

            if (elements.equipmentCount) elements.equipmentCount.innerHTML = `${counts.equipment} <span data-lang="items">items</span>`;
            if (elements.livestockCount) elements.livestockCount.innerHTML = `${counts.livestock} <span data-lang="items">items</span>`;
            if (elements.landCount) elements.landCount.innerHTML = `${counts.land} <span data-lang="plots">plots</span>`;
            if (elements.inventoryCount) elements.inventoryCount.innerHTML = `${counts.inventory} <span data-lang="items">items</span>`;
            
            updateLanguage();
        }

        function getAssetIcon(type) {
            const icons = {
                equipment: 'fas fa-tractor',
                livestock: 'fas fa-horse',
                land: 'fas fa-map',
                inventory: 'fas fa-boxes'
            };
            return icons[type] || 'fas fa-box';
        }

        function calculateCurrentValue(asset) {
            if (!asset.purchasePrice) return 0;
            
            if (asset.type === 'equipment' && asset.purchaseDate) {
                const years = (new Date().getFullYear() - new Date(asset.purchaseDate).getFullYear());
                const depreciationRate = 0.10;
                return Math.max(asset.purchasePrice * Math.pow(1 - depreciationRate, years), asset.purchasePrice * 0.1);
            }
            
            return asset.purchasePrice;
        }

        function showAddAssetModal() {
            document.getElementById('addAssetModal').classList.add('active');
        }

        function updateAssetFields() {
            const type = document.getElementById('assetType').value;
            
            document.querySelectorAll('#equipmentFields, #livestockFields, #landFields, #inventoryFields').forEach(el => {
                el.classList.add('hidden');
            });
            
            if (type) {
                const fieldsElement = document.getElementById(`${type}Fields`);
                if (fieldsElement) {
                    fieldsElement.classList.remove('hidden');
                }
            }
        }

        function handleAddAsset(e) {
            e.preventDefault();
            
            const isEditing = document.getElementById('addAssetForm').dataset.editingId;
            const assetData = {
                id: isEditing || Date.now().toString(),
                type: document.getElementById('assetType').value,
                name: document.getElementById('assetName').value,
                purchaseDate: document.getElementById('assetPurchaseDate').value,
                purchasePrice: parseFloat(document.getElementById('assetPurchasePrice').value) || 0,
                notes: document.getElementById('assetNotes').value,
                createdAt: isEditing ? undefined : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            if (assetData.type === 'equipment') {
                assetData.condition = document.getElementById('equipmentCondition').value;
                assetData.maintenanceCost = parseFloat(document.getElementById('equipmentMaintenanceCost').value) || 0;
            } else if (assetData.type === 'livestock') {
                assetData.count = parseInt(document.getElementById('animalCount').value) || 1;
                assetData.breed = document.getElementById('animalBreed').value;
                assetData.health = document.getElementById('animalHealth').value;
            } else if (assetData.type === 'land') {
                assetData.size = parseFloat(document.getElementById('landSize').value) || 0;
                assetData.landType = document.getElementById('landType').value;
            } else if (assetData.type === 'inventory') {
                assetData.quantity = parseFloat(document.getElementById('inventoryQuantity').value) || 0;
                assetData.unit = document.getElementById('inventoryUnit').value;
            }
            
            let assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            
            if (isEditing) {
                const index = assets.findIndex(a => a.id === isEditing);
                if (index !== -1) {
                    assets[index] = { ...assets[index], ...assetData };
                }
            } else {
                assets.push(assetData);
            }
            
            localStorage.setItem(STORAGE_KEYS.ASSETS, JSON.stringify(assets));
            
            // Save to Firebase if user is authenticated
            if (currentUser && currentUser.uid) {
                db.collection('assets').doc(assetData.id).set({
                    ...assetData,
                    userId: currentUser.uid
                }).catch(error => console.error('Error saving to Firestore:', error));
            }
            
            loadAssets();
            closeModal('addAssetModal');
            document.getElementById('addAssetForm').reset();
            updateAssetFields();
            delete document.getElementById('addAssetForm').dataset.editingId;
            
            showNotification(
                `🏆 ${isEditing ? 'Asset updated' : 'Asset added'} successfully!`, 
                'success'
            );
            autoSaveData();
        }

        function filterAssets(type) {
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const filteredAssets = type === 'all' ? assets : assets.filter(asset => asset.type === type);
            displayAssets(filteredAssets);
        }

        function viewAssetDetails(assetId) {
            const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
            const asset = assets.find(a => a.id === assetId);
            if (!asset) return;
            
            const relatedTransactions = getAssetTransactions(assetId);
            const totalExpenses = relatedTransactions.reduce((sum, t) => sum + t.amount, 0);
            
            showNotification(`📊 ${asset.name} Details:\n` +
                `Type: ${asset.type}\n` +
                `Purchase Price: ₹${asset.purchasePrice.toLocaleString('en-IN')}\n` +
                `Current Value: ₹${calculateCurrentValue(asset).toLocaleString('en-IN')}\n` +
                `Related Expenses: ₹${totalExpenses.toLocaleString('en-IN')}`, 'info');
        }

        function deleteAsset(assetId) {
            if (confirm('Are you sure you want to delete this asset? This action cannot be undone.')) {
                const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
                const filteredAssets = assets.filter(a => a.id !== assetId);
                localStorage.setItem(STORAGE_KEYS.ASSETS, JSON.stringify(filteredAssets));
                
                // Delete from Firebase
                if (currentUser && currentUser.uid) {
                    db.collection('assets').doc(assetId).delete()
                        .catch(error => console.error('Error deleting from Firestore:', error));
                }
                
                loadAssets();
                showNotification('🗑️ Asset deleted successfully!', 'success');
                autoSaveData();
            }
        }

        // Enhanced Smart Ideas
        function generateSmartIdeas() {
            const ideas = [
                {
                    id: 1,
                    category: 'crop',
                    title: 'Intercropping Strategy',
                    description: 'Plant nitrogen-fixing legumes between main crops to improve soil fertility and increase overall yield by 15-20%',
                    priority: 'high',
                    effort: 'medium',
                    benefit: '₹15,000 - ₹25,000',
                    timeframe: '1 season',
                    icon: 'fas fa-seedling',
                    color: 'success'
                },
                {
                    id: 2,
                    category: 'technology',
                    title: 'Drip Irrigation System',
                    description: 'Install precision drip irrigation to reduce water usage by 40% while increasing crop yield and quality',
                    priority: 'high',
                    effort: 'high',
                    benefit: '₹50,000 - ₹1,00,000',
                    timeframe: '6 months',
                    icon: 'fas fa-tint',
                    color: 'primary'
                },
                {
                    id: 3,
                    category: 'financial',
                    title: 'Value Addition Processing',
                    description: 'Process raw crops into value-added products like flour, oil, or packaged goods for premium market prices',
                    priority: 'medium',
                    effort: 'high',
                    benefit: '₹25,000 - ₹50,000',
                    timeframe: '3-6 months',
                    icon: 'fas fa-industry',
                    color: 'warning'
                },
                {
                    id: 4,
                    category: 'market',
                    title: 'Direct Consumer Sales',
                    description: 'Sell directly to consumers through farmers markets, online platforms, or subscription boxes',
                    priority: 'medium',
                    effort: 'low',
                    benefit: '₹10,000 - ₹20,000',
                    timeframe: '1 month',
                    icon: 'fas fa-store',
                    color: 'info'
                },
                {
                    id: 5,
                    category: 'technology',
                    title: 'Soil Health Monitoring',
                    description: 'Use soil sensors and testing kits to optimize fertilizer application and improve crop health',
                    priority: 'medium',
                    effort: 'low',
                    benefit: '₹8,000 - ₹15,000',
                    timeframe: '2 months',
                    icon: 'fas fa-microscope',
                    color: 'success'
                },
                {
                    id: 6,
                    category: 'crop',
                    title: 'Organic Certification',
                    description: 'Obtain organic certification to access premium markets and increase crop value by 30-50%',
                    priority: 'high',
                    effort: 'high',
                    benefit: '₹40,000 - ₹80,000',
                    timeframe: '12-18 months',
                    icon: 'fas fa-leaf',
                    color: 'success'
                }
            ];
            
            displayIdeas(ideas);
        }

        function displayIdeas(ideas) {
            const ideasGrid = document.getElementById('ideasGrid');
            
            ideasGrid.innerHTML = ideas.map(idea => `
                <div class="card idea-card" style="animation: slideInUp 0.5s ease; position: relative;">
                    <div class="idea-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div>
                            <div class="idea-category" style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--${idea.color}-color); font-weight: 500; margin-bottom: 0.5rem;">
                                <i class="${idea.icon}"></i>
                                ${idea.category.toUpperCase()}
                            </div>
                            <h3 style="margin: 0; color: var(--primary-color);">${idea.title}</h3>
                        </div>
                        <div class="priority-badge" style="padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; background: var(--${idea.priority === 'high' ? 'error' : idea.priority === 'medium' ? 'warning' : 'success'}-color); color: white;">
                            ${idea.priority}
                        </div>
                    </div>
                    
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.5;">${idea.description}</p>
                    
                    <div class="idea-metrics" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 0.75rem; border-radius: var(--border-radius-sm); text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Expected Benefit</div>
                            <div style="font-weight: 600; color: var(--success-color);">${idea.benefit}</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 0.75rem; border-radius: var(--border-radius-sm); text-align: center;">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Timeframe</div>
                            <div style="font-weight: 600; color: #3b82f6;">${idea.timeframe}</div>
                        </div>
                    </div>
                    
                    <div class="effort-indicator" style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <span>Effort Required</span>
                            <span style="font-weight: 600; text-transform: uppercase;">${idea.effort}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" style="width: ${idea.effort === 'high' ? '80%' : idea.effort === 'medium' ? '50%' : '20%'}; background: var(--${idea.effort === 'high' ? 'error' : idea.effort === 'medium' ? 'warning' : 'success'}-color);"></div>
                        </div>
                    </div>
                    
                    <div class="idea-actions" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn btn-primary" style="font-size: 0.8rem;" onclick="implementIdea(${idea.id})">
                            <i class="fas fa-rocket"></i> Start Now
                        </button>
                        <button class="btn btn-secondary" style="font-size: 0.8rem;" onclick="saveIdeaForLater(${idea.id})">
                            <i class="fas fa-bookmark"></i> Save Later
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function filterIdeas(category) {
            document.querySelectorAll('#ideas .btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            generateSmartIdeas();
        }

        function implementIdea(ideaId) {
            showNotification('🚀 Great choice! Implementation guide will be available soon!', 'success');
        }

        function saveIdeaForLater(ideaId) {
            showNotification('💾 Idea saved for later implementation!', 'success');
        }

        function refreshIdeas() {
            showNotification('🔄 Refreshing smart farming ideas...', 'info');
            setTimeout(() => {
                generateSmartIdeas();
                showNotification('✨ New ideas loaded based on your farm data!', 'success');
            }, 1000);
        }

        // Enhanced Charts
        function initializeCharts() {
            if (document.getElementById('incomeExpenseChart')) {
                createIncomeExpenseChart();
            }
            if (document.getElementById('cropProfitChart')) {
                createCropProfitChart();
            }
            if (document.getElementById('cashFlowChart')) {
                createCashFlowChart();
            }
            if (document.getElementById('temperatureChart')) {
                createTemperatureChart();
            }
        }

        function createIncomeExpenseChart() {
            const ctx = document.getElementById('incomeExpenseChart');
            if (!ctx) return;
            
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            const monthlyData = processMonthlyTransactions(transactions);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Income',
                        data: monthlyData.income,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }, {
                        label: 'Expenses',
                        data: monthlyData.expenses,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₹' + context.parsed.y.toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCropProfitChart() {
            const ctx = document.getElementById('cropProfitChart');
            if (!ctx) return;
            
            const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
            const profitData = crops.filter(c => c.expectedYield && c.expectedPrice).map(crop => ({
                name: crop.name.charAt(0).toUpperCase() + crop.name.slice(1),
                profit: (crop.expectedYield * crop.expectedPrice) * crop.area
            }));
            
            if (profitData.length === 0) {
                profitData.push(
                    { name: 'Rice', profit: 125000 },
                    { name: 'Wheat', profit: 85000 },
                    { name: 'Vegetables', profit: 65000 }
                );
            }
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: profitData.map(d => d.name),
                    datasets: [{
                        data: profitData.map(d => d.profit),
                        backgroundColor: [
                            'rgba(46, 125, 50, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(139, 195, 74, 0.8)',
                            'rgba(174, 213, 129, 0.8)',
                            'rgba(200, 230, 201, 0.8)'
                        ],
                        borderColor: [
                            'rgba(46, 125, 50, 1)',
                            'rgba(76, 175, 80, 1)',
                            'rgba(139, 195, 74, 1)',
                            'rgba(174, 213, 129, 1)',
                            'rgba(200, 230, 201, 1)'
                        ],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed / profitData.reduce((sum, d) => sum + d.profit, 0)) * 100).toFixed(1);
                                    return context.label + ': ₹' + context.parsed.toLocaleString('en-IN') + ` (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createCashFlowChart() {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
            const monthlyData = processMonthlyTransactions(transactions);
            
            const cashFlow = monthlyData.labels.map((label, index) => 
                monthlyData.income[index] - monthlyData.expenses[index]
            );
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [{
                        label: 'Cash Flow',
                        data: cashFlow,
                        borderColor: 'rgba(46, 125, 50, 1)',
                        backgroundColor: 'rgba(46, 125, 50, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(46, 125, 50, 1)',
                        pointBorderColor: 'rgba(255, 255, 255, 1)',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white',
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const prefix = value >= 0 ? 'Profit' : 'Loss';
                                    return prefix + ': ₹' + Math.abs(value).toLocaleString('en-IN');
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '₹' + (value / 1000) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }

        function createTemperatureChart() {
            const ctx = document.getElementById('temperatureChart');
            if (!ctx) return;
            
            const hours = Array.from({length: 24}, (_, i) => {
                const hour = i.toString().padStart(2, '0');
                return `${hour}:00`;
            });
            
            const temperatures = hours.map((_, i) => {
                return 20 + Math.sin(i * Math.PI / 12) * 8 + Math.random() * 3;
            });
            
            const rainChances = hours.map(() => Math.random() * 100);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: temperatures,
                        borderColor: 'rgba(255, 107, 53, 1)',
                        backgroundColor: 'rgba(255, 107, 53, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Rain Chance (%)',
                        data: rainChances,
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'white',
                            bodyColor: 'white'
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value) + '°C';
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                            ticks: {
                                callback: function(value) {
                                    return Math.round(value) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function processMonthlyTransactions(transactions) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const income = new Array(6).fill(0);
            const expenses = new Array(6).fill(0);
            
            const now = new Date();
            
            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const monthsAgo = (now.getFullYear() - transactionDate.getFullYear()) * 12 + 
                                 (now.getMonth() - transactionDate.getMonth());
                
                if (monthsAgo >= 0 && monthsAgo < 6) {
                    const index = 5 - monthsAgo;
                    if (transaction.type === 'income') {
                        income[index] += transaction.amount;
                    } else {
                        expenses[index] += transaction.amount;
                    }
                }
            });
            
            return {
                labels: months,
                income,
                expenses
            };
        }

        // Enhanced Settings and Profile
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
            
            if (settings.theme) {
                document.documentElement.setAttribute('data-theme', settings.theme);
                currentTheme = settings.theme;
                updateThemeIcon();
            }
            
            if (settings.language) {
                changeLanguage(settings.language);
            }
        }

        function saveSettings() {
            const settings = {
                theme: currentTheme,
                language: currentLanguage,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            setTheme(currentTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
            saveSettings();
            showNotification(`🎨 Theme changed to ${theme} mode!`, 'success');
        }

        function updateThemeIcon() {
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = currentTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
        }

        function changeLanguage(language) {
            currentLanguage = language;
            localStorage.setItem(STORAGE_KEYS.SELECTED_LANGUAGE, language);
            updateLanguage();
            saveSettings();
            showNotification(`🌐 Language changed!`, 'success');
        }

        async function handleUpdateProfile(e) {
            e.preventDefault();
            
            const profileData = {
                displayName: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value,
                phone: document.getElementById('profilePhone').value,
                location: document.getElementById('profileLocation').value,
                farmSize: parseFloat(document.getElementById('profileFarmSize').value) || 0,
                language: currentLanguage,
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (currentUser && currentUser.uid) {
                    await db.collection('users').doc(currentUser.uid).update(profileData);
                }
                
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
                localStorage.setItem(STORAGE_KEYS.USER_DATA, JSON.stringify({...userData, ...profileData}));
                
                showNotification('👤 Profile updated successfully!', 'success');
                autoSaveData();
            } catch (error) {
                console.error('Profile update error:', error);
                showNotification('Error updating profile', 'error');
            }
        }

        // Enhanced Data Management
        async function exportAllData() {
            try {
                showNotification('📄 Generating comprehensive farm report...', 'info');
                
                const userData = JSON.parse(localStorage.getItem(STORAGE_KEYS.USER_DATA) || '{}');
                const crops = JSON.parse(localStorage.getItem(STORAGE_KEYS.CROPS) || '[]');
                const transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS) || '[]');
                const assets = JSON.parse(localStorage.getItem(STORAGE_KEYS.ASSETS) || '[]');
                const loans = JSON.parse(localStorage.getItem(STORAGE_KEYS.LOANS) || '[]');
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                
                // Header
                doc.setFontSize(24);
                doc.text('🌱 JamaApp Farm Report', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Generated on: ${new Date().toLocaleDateString('en-IN')}`, 20, yPos);
                yPos += 20;
                
                // Farm Overview
                doc.setFontSize(16);
                doc.text('🏪 Farm Overview', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Farmer: ${userData.displayName || 'Not specified'}`, 20, yPos);
                yPos += 8;
                doc.text(`Location: ${userData.location || 'Not specified'}`, 20, yPos);
                yPos += 8;
                doc.text(`Farm Size: ${userData.farmSize || 0} acres`, 20, yPos);
                yPos += 15;
                
                // Crops Summary
                doc.setFontSize(16);
                doc.text('🌾 Crops Summary', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Total Crops: ${crops.length}`, 20, yPos);
                yPos += 8;
                doc.text(`Active Crops: ${crops.filter(c => c.status === 'active').length}`, 20, yPos);
                yPos += 8;
                doc.text(`Harvested Crops: ${crops.filter(c => c.status === 'harvested').length}`, 20, yPos);
                yPos += 15;
                
                // Financial Summary
                const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                
                doc.setFontSize(16);
                doc.text('💰 Financial Summary', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Total Income: ₹${totalIncome.toLocaleString('en-IN')}`, 20, yPos);
                yPos += 8;
                doc.text(`Total Expenses: ₹${totalExpenses.toLocaleString('en-IN')}`, 20, yPos);
                yPos += 8;
                doc.text(`Net Profit: ₹${(totalIncome - totalExpenses).toLocaleString('en-IN')}`, 20, yPos);
                yPos += 8;
                doc.text(`Total Transactions: ${transactions.length}`, 20, yPos);
                yPos += 15;
                
                // Assets Summary
                doc.setFontSize(16);
                doc.text('🏭 Assets Summary', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Total Assets: ${assets.length}`, 20, yPos);
                yPos += 8;
                doc.text(`Equipment: ${assets.filter(a => a.type === 'equipment').length}`, 20, yPos);
                yPos += 8;
                doc.text(`Livestock: ${assets.filter(a => a.type === 'livestock').length}`, 20, yPos);
                yPos += 8;
                doc.text(`Land Plots: ${assets.filter(a => a.type === 'land').length}`, 20, yPos);
                yPos += 15;
                
                // Loans Summary
                doc.setFontSize(16);
                doc.text('💳 Loans Summary', 20, yPos);
                yPos += 10;
                doc.setFontSize(12);
                doc.text(`Active Loans: ${loans.filter(l => l.status === 'active').length}`, 20, yPos);
                yPos += 8;
                const totalLoanAmount = loans.reduce((sum, l) => sum + (l.remainingAmount || l.amount), 0);
                doc.text(`Total Outstanding: ₹${totalLoanAmount.toLocaleString('en-IN')}`, 20, yPos);
                
                // Footer
                doc.setFontSize(10);
                doc.text('Generated by JamaApp - Smart Farm Management System', 20, 280);
                
                doc.save(`JamaApp-Farm-Report-${new Date().toISOString().split('T')[0]}.pdf`);
                showNotification('📊 Farm report exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('Error exporting data', 'error');
            }
        }

        function backupData() {
            if (currentUser && currentUser.uid) {
                showNotification('☁️ Backing up your farm data to cloud...', 'info');
                
                // Simulate backup process
                setTimeout(() => {
                    showNotification('✅ Data backed up to cloud successfully!', 'success');
                }, 2000);
            } else {
                showNotification('Please sign in to use cloud backup', 'warning');
            }
        }

        function clearAllData() {
            const confirmation = prompt('⚠️ WARNING: This will delete ALL your farm data!\n\nType "DELETE ALL MY DATA" to confirm:');
            if (confirmation === 'DELETE ALL MY DATA') {
                localStorage.clear();
                showNotification('🗑️ All data cleared! Reloading...', 'warning');
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showNotification('❌ Data deletion cancelled', 'info');
            }
        }

        // Enhanced Utility Functions
        function toggleFabMenu() {
            const menu = document.getElementById('fabMenu');
            const button = document.getElementById('fabButton');
            
            fabMenuOpen = !fabMenuOpen;
            
            if (fabMenuOpen) {
                menu.classList.add('active');
                button.style.transform = 'rotate(45deg)';
            } else {
                menu.classList.remove('active');
                button.style.transform = 'rotate(0deg)';
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            
            const form = document.querySelector(`#${modalId} form`);
            if (form) {
                form.reset();
                form.removeAttribute('data-editing-id');
                
                // Reset modal titles and button text
                const title = document.querySelector(`#${modalId} .modal-title span`);
                const button = document.querySelector(`#${modalId} button[type="submit"] span`);
                
                if (modalId === 'addCropModal') {
                    if (title) title.textContent = 'Add New Crop';
                    if (button) button.textContent = 'Add Crop';
                } else if (modalId === 'addTransactionModal') {
                    if (title) title.textContent = 'Add Transaction';
                    if (button) button.textContent = 'Add Transaction';
                } else if (modalId === 'addAssetModal') {
                    if (title) title.textContent = 'Add Asset';
                    if (button) button.textContent = 'Add Asset';
                } else if (modalId === 'addLoanModal') {
                    if (title) title.textContent = 'Add Loan';
                    if (button) button.textContent = 'Add Loan';
                }
            }
            
            if (modalId === 'addAssetModal') {
                updateAssetFields();
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fas fa-info-circle';
            switch(type) {
                case 'success': icon = 'fas fa-check-circle'; break;
                case 'error': icon = 'fas fa-exclamation-circle'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; break;
            }
            
            notification.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 5000);
        }

        // Loan Calculator Functions
        function showLoanCalculator() {
            document.getElementById('loanCalculatorModal').classList.add('active');
        }

        function calculateLoan() {
            const principal = parseFloat(document.getElementById('calcLoanAmount').value) || 0;
            const rate = parseFloat(document.getElementById('calcInterestRate').value) || 0;
            const term = parseInt(document.getElementById('calcLoanTerm').value) || 0;
            const type = document.getElementById('calcLoanType').value;
            
            if (principal && rate && term) {
                let monthlyEMI, totalInterest, totalAmount;
                
                if (type === 'compound') {
                                      const monthlyRate = rate / 100 / 12;
                    monthlyEMI = principal * monthlyRate * Math.pow(1 + monthlyRate, term) / (Math.pow(1 + monthlyRate, term) - 1);
                    totalAmount = monthlyEMI * term;
                    totalInterest = totalAmount - principal;
                } else {
                    // Simple interest calculation
                    totalInterest = principal * rate / 100 * (term / 12);
                    totalAmount = principal + totalInterest;
                    monthlyEMI = totalAmount / term;
                }
                
                document.getElementById('calcMonthlyEMI').textContent = `₹${Math.round(monthlyEMI).toLocaleString('en-IN')}`;
                document.getElementById('calcTotalInterest').textContent = `₹${Math.round(totalInterest).toLocaleString('en-IN')}`;
                document.getElementById('calcTotalAmount').textContent = `₹${Math.round(totalAmount).toLocaleString('en-IN')}`;
            }
        }

        function saveLoanFromCalculator() {
            const principal = parseFloat(document.getElementById('calcLoanAmount').value);
            const rate = parseFloat(document.getElementById('calcInterestRate').value);
            const term = parseInt(document.getElementById('calcLoanTerm').value);
            
            if (!principal || !rate || !term) {
                showNotification('Please fill all loan details first', 'error');
                return;
            }
            
            // Pre-fill the add loan form
            document.getElementById('loanAmount').value = principal;
            document.getElementById('interestRate').value = rate;
            document.getElementById('loanTenure').value = term;
            document.getElementById('emiDate').value = 15; // Default EMI date
            
            closeModal('loanCalculatorModal');
            showAddLoanModal();
            
            showNotification('Loan details transferred to loan form', 'success');
        }

        // Initialize the app when DOM is loaded
        window.onload = function() {
            initializeApp();
        };
    </script>
</body>
</html>
                    
