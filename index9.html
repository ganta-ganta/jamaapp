<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarmPro - Complete Farmer Financial Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Firebase App and Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <style>
        :root {
            --primary: #2e7d32;
            --primary-light: #4caf50;
            --primary-dark: #1b5e20;
            --secondary: #ffa000;
            --secondary-light: #ffc107;
            --secondary-dark: #ff6f00;
            --text-light: #f5f5f5;
            --text-dark: #333;
            --bg-light: #f8f9fa;
            --bg-dark: #2c3e50;
            --success: #388e3c;
            --warning: #f57c00;
            --danger: #d32f2f;
            --gray: #78909c;
            --border-radius: 12px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .logo i {
            font-size: 3rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }

        .logo h1 {
            font-weight: 700;
            font-size: 2.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            opacity: 0.95;
            font-size: 1.1rem;
        }

        .form-container {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-dark);
        }

        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15);
            transform: translateY(-1px);
        }

        .input-group {
            display: flex;
            gap: 12px;
        }

        .input-group .form-control {
            flex: 1;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            border: 2px solid transparent;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-dark), var(--secondary));
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background-color: var(--primary);
            color: white;
        }

        .btn-full {
            width: 100%;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #4caf50);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #e53935);
            color: white;
        }

        .otp-input-container {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            gap: 8px;
        }

        .otp-input {
            width: 55px;
            height: 55px;
            text-align: center;
            font-size: 1.8rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            transition: var(--transition);
            font-weight: 600;
        }

        .otp-input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(46, 125, 50, 0.15);
            transform: scale(1.05);
        }

        .countdown {
            text-align: center;
            margin: 1.5rem 0;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .resend-link {
            text-align: center;
            margin: 1rem 0;
        }

        .resend-link a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .resend-link a:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }

        .message {
            padding: 16px 20px;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            text-align: center;
            font-weight: 500;
            display: none;
            transition: var(--transition);
        }

        .error-message {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .success-message {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .footer {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--bg-light), #e8f5e9);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .crop-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin: 1.5rem 0;
        }

        .crop-item {
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .crop-item:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(46, 125, 50, 0.15);
        }

        .crop-item.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
            transform: scale(1.02);
        }

        .crop-item img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 12px;
            border: 3px solid #f0f0f0;
        }

        .crop-item div {
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 1rem;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .slider-container {
            margin: 2rem 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e8f5e9);
            border-radius: var(--border-radius);
        }

        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #e0e0e0, var(--primary-light));
            outline: none;
            margin: 15px 0;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(46, 125, 50, 0.3);
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4);
        }

        .slider-value {
            text-align: center;
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
        }

        .expense-category {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 1.5rem 0;
        }

        .expense-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            background: white;
        }

        .expense-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.1);
        }

        .expense-item.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.1), rgba(76, 175, 80, 0.05));
        }

        .expense-item img {
            width: 48px;
            height: 48px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #f0f0f0;
        }

        .funding-source {
            margin-bottom: 1.5rem;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            background: white;
            transition: var(--transition);
        }

        .funding-source:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .funding-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .remove-funding {
            color: var(--danger);
            cursor: pointer;
            font-weight: bold;
            font-size: 1.4rem;
            transition: var(--transition);
            padding: 5px;
            border-radius: 50%;
        }

        .remove-funding:hover {
            background: rgba(211, 47, 47, 0.1);
            transform: scale(1.1);
        }

        .dashboard-container {
            padding: 2rem;
            max-height: 80vh;
            overflow-y: auto;
        }

        .dashboard-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .financial-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 2rem;
        }

        .financial-item {
            text-align: center;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .financial-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .financial-item.income {
            border-left: 5px solid var(--success);
            background: linear-gradient(135deg, #e8f5e9, white);
        }

        .financial-item.expense {
            border-left: 5px solid var(--danger);
            background: linear-gradient(135deg, #ffebee, white);
        }

        .financial-item.profit {
            border-left: 5px solid var(--secondary);
            background: linear-gradient(135deg, #fff8e1, white);
        }

        .financial-item.interest {
            border-left: 5px solid var(--warning);
            background: linear-gradient(135deg, #fff3e0, white);
        }

        .financial-value {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0.5rem 0;
        }

        .financial-label {
            font-size: 0.9rem;
            color: var(--gray);
            font-weight: 500;
        }

        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #e1e5e9;
            margin-bottom: 2rem;
        }

        .nav-tab {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            font-weight: 600;
            color: var(--gray);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), transparent);
        }

        .nav-tab:hover {
            color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        .crop-card {
            border: 2px solid #e1e5e9;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 16px;
            background: white;
            transition: var(--transition);
        }

        .crop-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .crop-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--danger);
            transform: scale(1.1);
        }

        .secondary-income-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: var(--transition);
        }

        .secondary-income-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .weather-card {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border: none;
            color: #1565c0;
        }

        .pricing-card {
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            border: none;
            color: #7b1fa2;
        }

        .soil-card {
            background: linear-gradient(135deg, #efebe9, #d7ccc8);
            border: none;
            color: #5d4037;
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                border-radius: 0;
            }
            
            .otp-input {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
            }
            
            .crop-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .financial-summary {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .expense-category {
                grid-template-columns: 1fr;
            }

            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }

            .nav-tab {
                font-size: 0.9rem;
                padding: 10px 16px;
            }
        }

        @media (max-width: 480px) {
            .financial-summary {
                grid-template-columns: 1fr;
            }
            
            .logo h1 {
                font-size: 1.8rem;
            }
            
            .logo i {
                font-size: 2.5rem;
            }
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e5e9;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 1rem 0;
        }

        .stat-item {
            text-align: center;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .editable-field {
            background: transparent;
            border: 1px dashed #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            min-width: 100px;
            transition: var(--transition);
        }

        .editable-field:hover {
            background: #f0f0f0;
            border-style: solid;
        }

        .editable-field:focus {
            background: white;
            border-color: var(--primary);
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <h1>FarmPro</h1>
            </div>
            <p>Complete Agricultural Financial Management System</p>
        </div>

        <div class="form-container">
            <div class="error-message message" id="errorMessage"></div>
            <div class="success-message message" id="successMessage"></div>

            <!-- Step 1: Phone Number Input -->
            <div class="step active" id="step1">
                <div class="form-group">
                    <label for="phoneNumber">Phone Number</label>
                    <div class="input-group">
                        <select class="form-control" id="countryCode" style="max-width: 80px;">
                            <option value="+91">🇮🇳 +91</option>
                            <option value="+1">🇺🇸 +1</option>
                            <option value="+44">🇬🇧 +44</option>
                        </select>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="9876543210">
                    </div>
                </div>
                <button class="btn btn-primary btn-full" id="sendOtpBtn">
                    <i class="fas fa-paper-plane"></i> Send OTP
                </button>
            </div>

            <!-- Step 2: OTP Verification -->
            <div class="step" id="step2">
                <p style="text-align: center; margin-bottom: 2rem; font-size: 1.1rem;">
                    Enter the 6-digit OTP sent to <span id="phoneNumberDisplay" style="font-weight: 700; color: var(--primary);"></span>
                </p>
                
                <div class="otp-input-container">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                    <input type="text" class="otp-input" maxlength="1" pattern="[0-9]">
                </div>

                <div class="countdown" id="countdown">02:00</div>
                
                <div class="resend-link">
                    Didn't receive OTP? <a href="#" id="resendOtp">Resend OTP</a>
                </div>
                
                <button class="btn btn-primary btn-full" id="verifyOtpBtn">
                    <i class="fas fa-shield-alt"></i> Verify & Login
                </button>
                <button class="btn btn-outline btn-full" id="changeNumberBtn" style="margin-top: 12px;">
                    <i class="fas fa-edit"></i> Change Phone Number
                </button>
            </div>

            <!-- Step 3: Registration Form -->
            <div class="step" id="step3">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">
                    <i class="fas fa-user-plus"></i> Complete Your Registration
                </h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="firstName"><i class="fas fa-user"></i> First Name</label>
                        <input type="text" class="form-control" id="firstName" placeholder="Enter your first name">
                    </div>
                    
                    <div class="form-group">
                        <label for="lastName"><i class="fas fa-user"></i> Last Name</label>
                        <input type="text" class="form-control" id="lastName" placeholder="Enter your last name">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cropType"><i class="fas fa-seedling"></i> Primary Crop</label>
                    <div class="crop-grid">
                        <div class="crop-item" data-crop="paddy">
                            <img src="https://images.pexels.com/photos/764281/pexels-photo-764281.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Paddy">
                            <div>Paddy</div>
                        </div>
                        <div class="crop-item" data-crop="cotton">
                            <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Cotton">
                            <div>Cotton</div>
                        </div>
                        <div class="crop-item" data-crop="maize">
                            <img src="https://images.pexels.com/photos/547263/pexels-photo-547263.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Maize">
                            <div>Maize</div>
                        </div>
                        <div class="crop-item" data-crop="chickpea">
                            <img src="https://images.pexels.com/photos/4750274/pexels-photo-4750274.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Chickpea">
                            <div>Chickpea</div>
                        </div>
                        <div class="crop-item" data-crop="chilli">
                            <img src="https://images.pexels.com/photos/1835658/pexels-photo-1835658.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Chilli">
                            <div>Chilli</div>
                        </div>
                        <div class="crop-item" data-crop="tobacco">
                            <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Tobacco">
                            <div>Tobacco</div>
                        </div>
                        <div class="crop-item" data-crop="red-chickpea">
                            <img src="https://images.pexels.com/photos/4110251/pexels-photo-4110251.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Red Chickpea">
                            <div>Red Chickpea</div>
                        </div>
                        <div class="crop-item" data-crop="black-gram">
                            <img src="https://images.pexels.com/photos/4110258/pexels-photo-4110258.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Black Gram">
                            <div>Black Gram</div>
                        </div>
                        <div class="crop-item" data-crop="green-gram">
                            <img src="https://images.pexels.com/photos/4750267/pexels-photo-4750267.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop" alt="Green Gram">
                            <div>Green Gram</div>
                        </div>
                    </div>
                    <input type="hidden" id="cropType" value="">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="acres"><i class="fas fa-map"></i> Number of Acres</label>
                        <input type="number" class="form-control" id="acres" placeholder="Enter number of acres" min="0.1" step="0.1">
                    </div>
                    
                    <div class="form-group">
                        <label for="sowingDate"><i class="fas fa-calendar"></i> Sowing Date</label>
                        <input type="text" class="form-control" id="sowingDate" placeholder="Select sowing date">
                    </div>
                </div>
                
                <div class="slider-container">
                    <label for="durationSlider"><i class="fas fa-clock"></i> Crop Duration (days): <span id="durationValue">120</span></label>
                    <input type="range" min="30" max="365" value="120" class="slider" id="durationSlider">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 33%;"></div>
                    </div>
                </div>
                
                <button class="btn btn-primary btn-full" id="completeRegistrationBtn">
                    <i class="fas fa-arrow-right"></i> Continue to Financial Setup
                </button>
            </div>

            <!-- Step 4: Financial Setup -->
            <div class="step" id="step4">
                <h2 style="text-align: center; margin-bottom: 2rem; color: var(--primary);">
                    <i class="fas fa-chart-line"></i> Financial Setup
                </h2>
                
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-dark);">
                    <i class="fas fa-money-bill-wave"></i> Investment Sources
                </h3>
                
                <div id="fundingSources">
                    <div class="funding-source">
                        <div class="funding-header">
                            <select class="form-control funding-type" style="max-width: 200px;">
                                <option value="own">Own Funds</option>
                                <option value="bank">Bank Loan</option>
                                <option value="family">Family/Friends Loan</option>
                                <option value="govt">Government Subsidy</option>
                                <option value="other">Other Source</option>
                            </select>
                            <span class="remove-funding" style="display: none;">×</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                                <input type="number" class="form-control funding-amount" placeholder="Enter amount" min="0">
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-percentage"></i> Interest Rate (%)</label>
                                <input type="number" class="form-control funding-rate" value="0" min="0" step="0.1" disabled>
                            </div>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-calendar-alt"></i> Date Taken</label>
                            <input type="text" class="form-control funding-date" placeholder="Select date">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline btn-full" id="addFundingBtn" style="margin-bottom: 2rem;">
                    <i class="fas fa-plus-circle"></i> Add Another Funding Source
                </button>
                
                <h3 style="margin-bottom: 1.5rem; color: var(--primary-dark);">
                    <i class="fas fa-receipt"></i> Expected Expenses
                </h3>
                
                <div class="expense-category">
                    <div class="expense-item" data-expense="seeds">
                        <img src="https://images.pexels.com/photos/1431282/pexels-photo-1431282.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Seeds">
                        <div>Seeds</div>
                    </div>
                    <div class="expense-item" data-expense="ploughing">
                        <img src="https://images.pexels.com/photos/2132180/pexels-photo-2132180.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Ploughing">
                        <div>Ploughing</div>
                    </div>
                    <div class="expense-item" data-expense="weeding">
                        <img src="https://images.pexels.com/photos/1263986/pexels-photo-1263986.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Weeding">
                        <div>Weeding</div>
                    </div>
                    <div class="expense-item" data-expense="pesticides">
                        <img src="https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Pesticides">
                        <div>Pesticides</div>
                    </div>
                    <div class="expense-item" data-expense="irrigation">
                        <img src="https://images.pexels.com/photos/1552242/pexels-photo-1552242.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Irrigation">
                        <div>Irrigation</div>
                    </div>
                    <div class="expense-item" data-expense="harvesting">
                        <img src="https://images.pexels.com/photos/2132227/pexels-photo-2132227.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Harvesting">
                        <div>Harvesting</div>
                    </div>
                    <div class="expense-item" data-expense="transport">
                        <img src="https://images.pexels.com/photos/1624496/pexels-photo-1624496.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Transport">
                        <div>Transport</div>
                    </div>
                    <div class="expense-item" data-expense="storage">
                        <img src="https://images.pexels.com/photos/3095699/pexels-photo-3095699.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Storage">
                        <div>Storage</div>
                    </div>
                    <div class="expense-item" data-expense="leasing">
                        <img src="https://images.pexels.com/photos/1146709/pexels-photo-1146709.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Leasing">
                        <div>Leasing</div>
                    </div>
                    <div class="expense-item" data-expense="insurance">
                        <img src="https://images.pexels.com/photos/5428836/pexels-photo-5428836.jpeg?auto=compress&cs=tinysrgb&w=48&h=48&fit=crop" alt="Insurance">
                        <div>Insurance</div>
                    </div>
                </div>
                
                <div id="expenseDetails" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expenseAmount"><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                            <input type="number" class="form-control" id="expenseAmount" placeholder="Enter amount" min="0">
                        </div>
                        <div class="form-group">
                            <label for="expenseDate"><i class="fas fa-calendar"></i> Date</label>
                            <input type="text" class="form-control" id="expenseDate" placeholder="Select date">
                        </div>
                    </div>
                    <button class="btn btn-success" id="addExpenseBtn">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                </div>
                
                <div class="form-group">
                    <h4><i class="fas fa-list"></i> Added Expenses</h4>
                    <ul id="expenseList" style="list-style: none; margin-top: 15px;">
                        <!-- Expenses will be listed here -->
                    </ul>
                </div>
                
                <button class="btn btn-primary btn-full" id="finishSetupBtn">
                    <i class="fas fa-check-circle"></i> Complete Setup
                </button>
            </div>

            <!-- Step 5: Dashboard -->
            <div class="step" id="step5">
                <div class="dashboard-container">
                    <div class="dashboard-header">
                        <h2><i class="fas fa-tachometer-alt"></i> Farm Dashboard</h2>
                        <div>
                            <button class="btn btn-success btn-small" id="addCropBtn">
                                <i class="fas fa-plus"></i> Add Crop
                            </button>
                            <button class="btn btn-outline btn-small" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </button>
                        </div>
                    </div>
                    
                    <div class="financial-summary">
                        <div class="financial-item income">
                            <div class="financial-label">Total Income</div>
                            <div class="financial-value" id="totalIncome">₹0</div>
                            <div class="financial-label">From all sources</div>
                        </div>
                        <div class="financial-item expense">
                            <div class="financial-label">Total Expenses</div>
                            <div class="financial-value" id="totalExpenses">₹0</div>
                            <div class="financial-label">Farming costs</div>
                        </div>
                        <div class="financial-item profit">
                            <div class="financial-label">Net Profit</div>
                            <div class="financial-value" id="netProfit">₹0</div>
                            <div class="financial-label">This year</div>
                        </div>
                        <div class="financial-item interest">
                            <div class="financial-label">Interest Cost</div>
                            <div class="financial-value" id="interestCost">₹0</div>
                            <div class="financial-label">Weighted avg</div>
                        </div>
                    </div>

                    <div class="nav-tabs">
                        <div class="nav-tab active" data-tab="crops">
                            <i class="fas fa-seedling"></i> Crops
                        </div>
                        <div class="nav-tab" data-tab="financials">
                            <i class="fas fa-chart-pie"></i> Financials
                        </div>
                        <div class="nav-tab" data-tab="secondary">
                            <i class="fas fa-coins"></i> Secondary Income
                        </div>
                        <div class="nav-tab" data-tab="advisory">
                            <i class="fas fa-cloud-sun"></i> Advisory
                        </div>
                    </div>

                    <!-- Crops Tab -->
                    <div class="tab-content active" id="crops-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-leaf"></i> Active Crops</h3>
                            <div id="cropsList">
                                <!-- Crops will be displayed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Financials Tab -->
                    <div class="tab-content" id="financials-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-money-bill-wave"></i> Investment Sources</h3>
                            <div id="fundingBreakdown"></div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-receipt"></i> Expense Analysis</h3>
                            <div id="expenseBreakdown"></div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                            <div id="recentActivities"></div>
                        </div>
                    </div>

                    <!-- Secondary Income Tab -->
                    <div class="tab-content" id="secondary-tab">
                        <div class="dashboard-card">
                            <h3><i class="fas fa-tractor"></i> Machinery & Equipment</h3>
                            <button class="btn btn-success btn-small" id="addMachineryBtn">
                                <i class="fas fa-plus"></i> Add Machinery
                            </button>
                            <div id="machineryList">
                                <!-- Machinery items will be listed here -->
                            </div>
                        </div>
                        
                        <div class="dashboard-card">
                            <h3><i class="fas fa-paw"></i> Livestock</h3>
                            <button class="btn btn-success btn-small" id="addLivestockBtn">
                                <i class="fas fa-plus"></i> Add Livestock
                            </button>
                            <div id="livestockList">
                                <!-- Livestock items will be listed here -->
                            </div>
                        </div>
                    </div>

                    <!-- Advisory Tab -->
                    <div class="tab-content" id="advisory-tab">
                        <div class="dashboard-card weather-card">
                            <h3><i class="fas fa-cloud-sun"></i> Weather Forecast</h3>
                            <div id="weatherInfo">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div><i class="fas fa-thermometer-half"></i></div>
                                        <div><strong>28°C</strong></div>
                                        <div>Temperature</div>
                                    </div>
                                    <div class="stat-item">
                                        <div><i class="fas fa-tint"></i></div>
                                        <div><strong>65%</strong></div>
                                        <div>Humidity</div>
                                    </div>
                                </div>
                                <p style="margin-top: 1rem; text-align: center;">Sunny with moderate humidity. Good for irrigation.</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-card pricing-card">
                            <h3><i class="fas fa-tags"></i> Market Prices</h3>
                            <div id="pricingInfo">
                                <div class="stats-grid">
                                    <div class="stat-item">
                                        <div><strong>₹2,850</strong></div>
                                        <div>Paddy/Quintal</div>
                                    </div>
                                    <div class="stat-item">
                                        <div><strong>₹7,200</strong></div>
                                        <div>Cotton/Quintal</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-card soil-card">
                            <h3><i class="fas fa-seedling"></i> Soil Health & Advisory</h3>
                            <div id="soilInfo">
                                <p><strong>Soil pH:</strong> <span class="editable-field" contenteditable="true">6.8</span> (Optimal)</p>
                                <p><strong>Nitrogen:</strong> <span class="editable-field" contenteditable="true">Medium</span></p>
                                <p><strong>Phosphorus:</strong> <span class="editable-field" contenteditable="true">High</span></p>
                                <p><strong>Potassium:</strong> <span class="editable-field" contenteditable="true">Low</span></p>
                                <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.7); border-radius: 8px;">
                                    <strong>Recommendation:</strong> Consider potassium supplementation for better crop yield.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <div class="modal" id="addCropModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-plus-circle"></i> Add New Crop</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label>Select Crop Type</label>
                    <div class="crop-grid" id="modalCropGrid">
                        <!-- Same crop options as registration -->
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="modalAcres">Acres</label>
                        <input type="number" class="form-control" id="modalAcres" placeholder="Enter acres" min="0.1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="modalSowingDate">Sowing Date</label>
                        <input type="text" class="form-control" id="modalSowingDate" placeholder="Select date">
                    </div>
                </div>
                <div class="slider-container">
                    <label for="modalDurationSlider">Duration (days): <span id="modalDurationValue">120</span></label>
                    <input type="range" min="30" max="365" value="120" class="slider" id="modalDurationSlider">
                </div>
                <div class="form-group">
                    <label for="modalNotes">Farm Notes</label>
                    <textarea class="form-control" id="modalNotes" rows="3" placeholder="Add any notes about this crop..."></textarea>
                </div>
                <button class="btn btn-primary btn-full" id="saveCropBtn">
                    <i class="fas fa-save"></i> Save Crop
                </button>
            </div>
        </div>

        <div class="modal" id="addMachineryModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-tractor"></i> Add Machinery/Equipment</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label for="machineryType">Equipment Type</label>
                    <select class="form-control" id="machineryType">
                        <option value="">Select Equipment</option>
                        <option value="tractor">Tractor</option>
                        <option value="harvester">Harvester</option>
                        <option value="plough">Plough</option>
                        <option value="pump">Water Pump</option>
                        <option value="sprayer">Pesticide Sprayer</option>
                        <option value="custom">Custom Equipment</option>
                    </select>
                </div>
                <div id="customMachineryInput" style="display: none;">
                    <div class="form-group">
                        <label for="customMachineryName">Custom Equipment Name</label>
                        <input type="text" class="form-control" id="customMachineryName" placeholder="Enter equipment name">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="machineryAmount">Amount (₹)</label>
                        <input type="number" class="form-control" id="machineryAmount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label for="machineryDate">Date</label>
                        <input type="text" class="form-control" id="machineryDate" placeholder="Select date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="machineryType2">Transaction Type</label>
                    <select class="form-control" id="machineryType2">
                        <option value="purchase">Purchase</option>
                        <option value="sale">Sale</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="rental">Rental Income</option>
                    </select>
                </div>
                <button class="btn btn-primary btn-full" id="saveMachineryBtn">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>

        <div class="modal" id="addLivestockModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-paw"></i> Add Livestock Transaction</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-group">
                    <label for="livestockType">Livestock Type</label>
                    <select class="form-control" id="livestockType">
                        <option value="">Select Livestock</option>
                        <option value="cow">Cow</option>
                        <option value="buffalo">Buffalo</option>
                        <option value="goat">Goat</option>
                        <option value="sheep">Sheep</option>
                        <option value="chicken">Chicken</option>
                        <option value="custom">Other</option>
                    </select>
                </div>
                <div id="customLivestockInput" style="display: none;">
                    <div class="form-group">
                        <label for="customLivestockName">Custom Livestock Name</label>
                        <input type="text" class="form-control" id="customLivestockName" placeholder="Enter livestock type">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="livestockAmount">Amount (₹)</label>
                        <input type="number" class="form-control" id="livestockAmount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label for="livestockDate">Date</label>
                        <input type="text" class="form-control" id="livestockDate" placeholder="Select date">
                    </div>
                </div>
                <div class="form-group">
                    <label for="livestockTransactionType">Transaction Type</label>
                    <select class="form-control" id="livestockTransactionType">
                        <option value="purchase">Purchase Animal</option>
                        <option value="sale">Sale Animal</option>
                        <option value="milk-sale">Milk Sale</option>
                        <option value="egg-sale">Egg Sale</option>
                        <option value="meat-sale">Meat Sale</option>
                        <option value="feed-cost">Feed Cost</option>
                        <option value="medical-cost">Medical Cost</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="livestockNotes">Notes</label>
                    <input type="text" class="form-control" id="livestockNotes" placeholder="Additional details...">
                </div>
                <button class="btn btn-primary btn-full" id="saveLivestockBtn">
                    <i class="fas fa-save"></i> Save Transaction
                </button>
            </div>
        </div>

        <div class="modal" id="editCropModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> Edit Crop Details</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editYield">Actual Yield (Quintal)</label>
                        <input type="number" class="form-control" id="editYield" placeholder="Enter yield" min="0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="editSellingPrice">Selling Price (₹/Quintal)</label>
                        <input type="number" class="form-control" id="editSellingPrice" placeholder="Enter price" min="0">
                    </div>
                </div>
                <div class="form-group">
                    <label for="editStatus">Crop Status</label>
                    <select class="form-control" id="editStatus">
                        <option value="planted">Planted</option>
                        <option value="growing">Growing</option>
                        <option value="harvested">Harvested</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editNotes">Farm Notes</label>
                    <textarea class="form-control" id="editNotes" rows="3" placeholder="Update your farm notes..."></textarea>
                </div>
                <button class="btn btn-primary btn-full" id="saveEditedCropBtn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>

        <div class="footer">
            <p>&copy; 2025 FarmPro. Empowering farmers with smart financial management.</p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCdfgtj1gvZ-bkomW1V40h-4tyUPHy_peo",
            authDomain: "jama-3f427.firebaseapp.com",
            projectId: "jama-3f427",
            storageBucket: "jama-3f427.firebasestorage.app",
            messagingSenderId: "897112470741",
            appId: "1:897112470741:web:ee6388f0faae459fcb1e5c",
            measurementId: "G-NN1BRV0QKS"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const step4 = document.getElementById('step4');
        const step5 = document.getElementById('step5');
        const phoneNumberInput = document.getElementById('phoneNumber');
        const countryCodeSelect = document.getElementById('countryCode');
        const phoneNumberDisplay = document.getElementById('phoneNumberDisplay');
        const sendOtpBtn = document.getElementById('sendOtpBtn');
        const verifyOtpBtn = document.getElementById('verifyOtpBtn');
        const resendOtpLink = document.getElementById('resendOtp');
        const changeNumberBtn = document.getElementById('changeNumberBtn');
        const completeRegistrationBtn = document.getElementById('completeRegistrationBtn');
        const finishSetupBtn = document.getElementById('finishSetupBtn');
        const addFundingBtn = document.getElementById('addFundingBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const otpInputs = document.querySelectorAll('.otp-input');
        const countdown = document.getElementById('countdown');
        const cropItems = document.querySelectorAll('.crop-item');
        const expenseItems = document.querySelectorAll('.expense-item');
        const fundingSources = document.getElementById('fundingSources');
        const expenseDetails = document.getElementById('expenseDetails');
        const expenseList = document.getElementById('expenseList');
        const durationSlider = document.getElementById('durationSlider');
        const durationValue = document.getElementById('durationValue');
        const sowingDate = document.getElementById('sowingDate');

        // Global variables
        let confirmationResult = null;
        let countdownTimer = null;
        let timeLeft = 120;
        let selectedCrop = '';
        let selectedExpense = '';
        let editingCropId = null;
        let userData = {
            profile: {},
            crops: [],
            expenses: [],
            funding: [],
            income: [],
            machinery: [],
            livestock: [],
            yearlyData: {}
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDatePickers();
            initializeEventListeners();
            initializeTabs();
            initializeModals();
            
            // Load user data from localStorage
            const savedData = localStorage.getItem('farmpro_userData');
            if (savedData) {
                userData = JSON.parse(savedData);
            }
        });

        function initializeDatePickers() {
            flatpickr('#sowingDate', {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
        }

        function initializeEventListeners() {
            // Main workflow events
            sendOtpBtn.addEventListener('click', sendOtp);
            verifyOtpBtn.addEventListener('click', verifyOtp);
            resendOtpLink.addEventListener('click', resendOtp);
            changeNumberBtn.addEventListener('click', changeNumber);
            completeRegistrationBtn.addEventListener('click', completeRegistration);
            finishSetupBtn.addEventListener('click', finishSetup);
            addFundingBtn.addEventListener('click', addFundingSource);
            addExpenseBtn.addEventListener('click', addExpense);
            logoutBtn.addEventListener('click', logout);

            // Dashboard events
            document.getElementById('addCropBtn').addEventListener('click', () => openModal('addCropModal'));
            document.getElementById('addMachineryBtn').addEventListener('click', () => openModal('addMachineryModal'));
            document.getElementById('addLivestockBtn').addEventListener('click', () => openModal('addLivestockModal'));
            document.getElementById('saveCropBtn').addEventListener('click', saveCrop);
            document.getElementById('saveMachineryBtn').addEventListener('click', saveMachinery);
            document.getElementById('saveLivestockBtn').addEventListener('click', saveLivestock);
            document.getElementById('saveEditedCropBtn').addEventListener('click', saveEditedCrop);

            // Crop selection
            cropItems.forEach(item => {
                item.addEventListener('click', () => selectCrop(item));
            });

            // Expense selection
            expenseItems.forEach(item => {
                item.addEventListener('click', () => selectExpense(item));
            });

            // Duration slider
            durationSlider.addEventListener('input', () => {
                durationValue.textContent = durationSlider.value;
            });

            // OTP input navigation
            otpInputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value.length === 1 && index < otpInputs.length - 1) {
                        otpInputs[index + 1].focus();
                    }
                });
                
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && input.value === '' && index > 0) {
                        otpInputs[index - 1].focus();
                    }
                });
            });

            // Modal machinery type change
            document.getElementById('machineryType').addEventListener('change', function() {
                const customInput = document.getElementById('customMachineryInput');
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                } else {
                    customInput.style.display = 'none';
                }
            });

            // Modal livestock type change
            document.getElementById('livestockType').addEventListener('change', function() {
                const customInput = document.getElementById('customLivestockInput');
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                } else {
                    customInput.style.display = 'none';
                }
            });
        }

        function initializeTabs() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
        }

        function initializeModals() {
            const modals = document.querySelectorAll('.modal');
            const closeButtons = document.querySelectorAll('.modal-close');
            
            closeButtons.forEach(btn => {
                btn.addEventListener('click', closeModals);
            });
            
            modals.forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModals();
                    }
                });
            });

            // Initialize modal crop grid
            initializeModalCropGrid();
            
            // Initialize modal date pickers
            flatpickr('#modalSowingDate', { dateFormat: "Y-m-d", maxDate: "today" });
            flatpickr('#machineryDate', { dateFormat: "Y-m-d", maxDate: "today" });
            flatpickr('#livestockDate', { dateFormat: "Y-m-d", maxDate: "today" });
            
            // Modal duration slider
            const modalDurationSlider = document.getElementById('modalDurationSlider');
            const modalDurationValue = document.getElementById('modalDurationValue');
            modalDurationSlider.addEventListener('input', () => {
                modalDurationValue.textContent = modalDurationSlider.value;
            });
        }

        function initializeModalCropGrid() {
            const modalCropGrid = document.getElementById('modalCropGrid');
            const cropData = [
                { name: 'paddy', img: 'https://images.pexels.com/photos/764281/pexels-photo-764281.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'cotton', img: 'https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'maize', img: 'https://images.pexels.com/photos/547263/pexels-photo-547263.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'chickpea', img: 'https://images.pexels.com/photos/4750274/pexels-photo-4750274.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'chilli', img: 'https://images.pexels.com/photos/1835658/pexels-photo-1835658.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'tobacco', img: 'https://images.pexels.com/photos/4022110/pexels-photo-4022110.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'red-chickpea', img: 'https://images.pexels.com/photos/4110251/pexels-photo-4110251.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'black-gram', img: 'https://images.pexels.com/photos/4110258/pexels-photo-4110258.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' },
                { name: 'green-gram', img: 'https://images.pexels.com/photos/4750267/pexels-photo-4750267.jpeg?auto=compress&cs=tinysrgb&w=80&h=80&fit=crop' }
            ];

            modalCropGrid.innerHTML = cropData.map(crop => `
                <div class="crop-item" data-crop="${crop.name}">
                    <img src="${crop.img}" alt="${crop.name}">
                    <div>${crop.name.charAt(0).toUpperCase() + crop.name.slice(1).replace('-', ' ')}</div>
                </div>
            `).join('');

            // Add event listeners to modal crop items
            modalCropGrid.querySelectorAll('.crop-item').forEach(item => {
                item.addEventListener('click', () => {
                    modalCropGrid.querySelectorAll('.crop-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedCrop = item.getAttribute('data-crop');
                });
            });
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Add active class to selected tab and content
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = 'auto';
            
            // Reset modal forms
            resetModalForms();
        }

        function resetModalForms() {
            document.querySelectorAll('.modal .form-control').forEach(input => {
                if (input.type !== 'hidden') input.value = '';
            });
            document.querySelectorAll('.modal .crop-item').forEach(item => {
                item.classList.remove('selected');
            });
            selectedCrop = '';
            editingCropId = null;
        }

        function selectCrop(item) {
            cropItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedCrop = item.getAttribute('data-crop');
            document.getElementById('cropType').value = selectedCrop;
        }

        function selectExpense(item) {
            expenseItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            selectedExpense = item.getAttribute('data-expense');
            expenseDetails.style.display = 'block';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 5000);
        }

        function changeStep(currentStep, nextStep) {
            currentStep.classList.remove('active');
            nextStep.classList.add('active');
        }

        function saveUserData() {
            localStorage.setItem('farmpro_userData', JSON.stringify(userData));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function startCountdown() {
            clearInterval(countdownTimer);
            timeLeft = 120;
            updateCountdown();
            
            countdownTimer = setInterval(() => {
                timeLeft--;
                updateCountdown();
                
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    countdown.textContent = "OTP expired";
                    countdown.style.color = "#d32f2f";
                }
            }, 1000);
        }

        function updateCountdown() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            countdown.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function sendOtp() {
            const phoneNumber = phoneNumberInput.value.trim();
            const countryCode = countryCodeSelect.value;
            
            if (!phoneNumber) {
                showError('Please enter your phone number');
                return;
            }
            
            if (!/^\d{10}$/.test(phoneNumber)) {
                showError('Please enter a valid 10-digit phone number');
                return;
            }
            
            // For demo purposes, simulate OTP sending
            phoneNumberDisplay.textContent = countryCode + phoneNumber;
            changeStep(step1, step2);
            startCountdown();
            showSuccess('OTP sent successfully! Use 123456 for demo.');
        }

        function verifyOtp() {
            let otp = '';
            otpInputs.forEach(input => {
                otp += input.value;
            });
            
            if (otp.length !== 6) {
                showError('Please enter the complete 6-digit OTP');
                return;
            }
            
            // For demo purposes, accept 123456 as valid OTP
            if (otp === '123456') {
                // Check if user exists
                if (userData.profile && userData.profile.firstName) {
                    // Existing user - go to dashboard
                    changeStep(step2, step5);
                    loadDashboard();
                } else {
                    // New user - show registration
                    changeStep(step2, step3);
                }
                showSuccess('OTP verified successfully!');
            } else {
                showError('Invalid OTP. Please try again or use 123456 for demo.');
            }
        }

        function resendOtp(e) {
            e.preventDefault();
            
            if (timeLeft > 0) {
                showError(`Please wait ${timeLeft} seconds before requesting a new OTP`);
                return;
            }
            
            startCountdown();
            showSuccess('New OTP sent! Use 123456 for demo.');
        }

        function changeNumber() {
            changeStep(step2, step1);
            clearInterval(countdownTimer);
            otpInputs.forEach(input => {
                input.value = '';
            });
        }

        function completeRegistration() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const cropType = document.getElementById('cropType').value;
            const acres = document.getElementById('acres').value;
            const sowingDateVal = document.getElementById('sowingDate').value;
            const duration = document.getElementById('durationSlider').value;
            
            if (!firstName || !lastName || !cropType || !acres || !sowingDateVal) {
                showError('Please fill all the required fields');
                return;
            }
            
            // Save user profile
            userData.profile = {
                firstName,
                lastName,
                phone: countryCodeSelect.value + phoneNumberInput.value.trim()
            };
            
            // Add initial crop
            userData.crops.push({
                id: generateId(),
                type: cropType,
                acres: parseFloat(acres),
                sowingDate: sowingDateVal,
                duration: parseInt(duration),
                yield: 0,
                sellingPrice: 0,
                status: 'planted',
                notes: '',
                expectedYield: calculateExpectedYield(cropType, acres)
            });
            
            saveUserData();
            changeStep(step3, step4);
        }

        function calculateExpectedYield(cropType, acres) {
            const yieldPerAcre = {
                'paddy': 25,
                'cotton': 8,
                'maize': 30,
                'chickpea': 12,
                'chilli': 15,
                'tobacco': 18,
                'red-chickpea': 10,
                'black-gram': 8,
                'green-gram': 9
            };
            
            return (yieldPerAcre[cropType] || 15) * acres;
        }

        function addFundingSource() {
            const fundingSource = document.createElement('div');
            fundingSource.className = 'funding-source';
            fundingSource.innerHTML = `
                <div class="funding-header">
                    <select class="form-control funding-type" style="max-width: 200px;">
                        <option value="own">Own Funds</option>
                        <option value="bank">Bank Loan</option>
                        <option value="family">Family/Friends Loan</option>
                        <option value="govt">Government Subsidy</option>
                        <option value="other">Other Source</option>
                    </select>
                    <span class="remove-funding">×</span>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-rupee-sign"></i> Amount (₹)</label>
                        <input type="number" class="form-control funding-amount" placeholder="Enter amount" min="0">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-percentage"></i> Interest Rate (%)</label>
                        <input type="number" class="form-control funding-rate" placeholder="Enter rate" min="0" step="0.1">
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar-alt"></i> Date Taken</label>
                    <input type="text" class="form-control funding-date" placeholder="Select date">
                </div>
            `;
            
            // Initialize date picker for the new funding source
            flatpickr(fundingSource.querySelector('.funding-date'), {
                dateFormat: "Y-m-d",
                maxDate: "today"
            });
            
            // Add event listeners
            fundingSource.querySelector('.remove-funding').addEventListener('click', function() {
                fundingSource.remove();
            });
            
            fundingSource.querySelector('.funding-type').addEventListener('change', function() {
                const rateInput = fundingSource.querySelector('.funding-rate');
                if (this.value === 'own' || this.value === 'govt') {
                    rateInput.value = 0;
                    rateInput.disabled = true;
                } else {
                    rateInput.disabled = false;
                }
            });
            
            fundingSources.appendChild(fundingSource);
        }

        function addExpense() {
            const amount = document.getElementById('expenseAmount').value;
            const date = document.getElementById('expenseDate').value;
            
            if (!amount || !date || !selectedExpense) {
                showError('Please select expense type, enter amount and date');
                return;
            }
            
            const expenseId = generateId();
            const expenseItem = document.createElement('li');
            expenseItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border: 1px solid #e1e5e9; border-radius: 8px; margin-bottom: 8px; background: white;">
                    <div>
                        <strong>${selectedExpense.charAt(0).toUpperCase() + selectedExpense.slice(1)}</strong>
                        <div style="font-size: 0.9rem; color: var(--gray);">₹${parseFloat(amount).toLocaleString()} on ${date}</div>
                    </div>
                    <span style="color: var(--danger); cursor: pointer; font-size: 1.2rem; padding: 5px;" onclick="removeExpense('${expenseId}', this)">×</span>
                </div>
            `;
            
            expenseList.appendChild(expenseItem);
            
            // Add to userData
            userData.expenses.push({
                id: expenseId,
                category: selectedExpense,
                amount: parseFloat(amount),
                date: date
            });
            
            // Reset form
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDate').value = '';
            expenseItems.forEach(item => item.classList.remove('selected'));
            expenseDetails.style.display = 'none';
            selectedExpense = '';
            
            showSuccess('Expense added successfully!');
        }

        function removeExpense(expenseId, element) {
            // Remove from userData
            userData.expenses = userData.expenses.filter(expense => expense.id !== expenseId);
            
            // Remove from DOM
            element.closest('li').remove();
            
            saveUserData();
            showSuccess('Expense removed successfully!');
        }

        function finishSetup() {
            // Collect funding sources
            const fundingElements = document.querySelectorAll('.funding-source');
            userData.funding = [];
            
            fundingElements.forEach(element => {
                const type = element.querySelector('.funding-type').value;
                const amount = element.querySelector('.funding-amount').value;
                const rate = element.querySelector('.funding-rate').value;
                const date = element.querySelector('.funding-date').value;
                
                if (amount && date) {
                    userData.funding.push({
                        id: generateId(),
                        type: type,
                        amount: parseFloat(amount),
                        interestRate: parseFloat(rate) || 0,
                        date: date
                    });
                }
            });
            
            saveUserData();
            changeStep(step4, step5);
            loadDashboard();
            showSuccess('Setup completed successfully!');
        }

        function saveCrop() {
            const cropType = selectedCrop;
            const acres = document.getElementById('modalAcres').value;
            const sowingDate = document.getElementById('modalSowingDate').value;
            const duration = document.getElementById('modalDurationSlider').value;
            const notes = document.getElementById('modalNotes').value;
            
            if (!cropType || !acres || !sowingDate) {
                showError('Please fill all required fields');
                return;
            }
            
            const newCrop = {
                id: generateId(),
                type: cropType,
                acres: parseFloat(acres),
                sowingDate: sowingDate,
                duration: parseInt(duration),
                yield: 0,
                sellingPrice: 0,
                status: 'planted',
                notes: notes,
                expectedYield: calculateExpectedYield(cropType, acres)
            };
            
            userData.crops.push(newCrop);
            saveUserData();
            closeModals();
            loadDashboard();
            showSuccess('Crop added successfully!');
        }

        function saveMachinery() {
            const type = document.getElementById('machineryType').value;
            const customName = document.getElementById('customMachineryName').value;
            const amount = document.getElementById('machineryAmount').value;
            const date = document.getElementById('machineryDate').value;
            const transactionType = document.getElementById('machineryType2').value;
            
            if (!type || !amount || !date || !transactionType) {
                showError('Please fill all required fields');
                return;
            }
            
            const machineryName = type === 'custom' ? customName : type;
            
            userData.machinery.push({
                id: generateId(),
                name: machineryName,
                type: transactionType,
                amount: parseFloat(amount),
                date: date
            });
            
            saveUserData();
            closeModals();
            loadDashboard();
            showSuccess('Machinery transaction added successfully!');
        }

        function saveLivestock() {
            const type = document.getElementById('livestockType').value;
            const customName = document.getElementById('customLivestockName').value;
            const amount = document.getElementById('livestockAmount').value;
            const date = document.getElementById('livestockDate').value;
            const transactionType = document.getElementById('livestockTransactionType').value;
            const notes = document.getElementById('livestockNotes').value;
            
            if (!type || !amount || !date || !transactionType) {
                showError('Please fill all required fields');
                return;
            }
            
            const livestockName = type === 'custom' ? customName : type;
            
            userData.livestock.push({
                id: generateId(),
                name: livestockName,
                type: transactionType,
                amount: parseFloat(amount),
                date: date,
                notes: notes
            });
            
            saveUserData();
            closeModals();
            loadDashboard();
            showSuccess('Livestock transaction added successfully!');
        }

        function editCrop(cropId) {
            const crop = userData.crops.find(c => c.id === cropId);
            if (!crop) return;
            
            editingCropId = cropId;
            document.getElementById('editYield').value = crop.yield;
            document.getElementById('editSellingPrice').value = crop.sellingPrice;
            document.getElementById('editStatus').value = crop.status;
            document.getElementById('editNotes').value = crop.notes;
            
            openModal('editCropModal');
        }

        function saveEditedCrop() {
            if (!editingCropId) return;
            
            const crop = userData.crops.find(c => c.id === editingCropId);
            if (!crop) return;
            
            crop.yield = parseFloat(document.getElementById('editYield').value) || 0;
            crop.sellingPrice = parseFloat(document.getElementById('editSellingPrice').value) || 0;
            crop.status = document.getElementById('editStatus').value;
            crop.notes = document.getElementById('editNotes').value;
            
            // Calculate income if harvested
            if (crop.status === 'harvested' || crop.status === 'sold') {
                const income = crop.yield * crop.sellingPrice;
                
                // Update or add income record
                const existingIncomeIndex = userData.income.findIndex(inc => inc.cropId === crop.id);
                if (existingIncomeIndex >= 0) {
                    userData.income[existingIncomeIndex].amount = income;
                } else {
                    userData.income.push({
                        id: generateId(),
                        cropId: crop.id,
                        amount: income,
                        date: new Date().toISOString().split('T')[0],
                        source: 'crop-sale'
                    });
                }
            }
            
            saveUserData();
            closeModals();
            loadDashboard();
            showSuccess('Crop updated successfully!');
        }

        function deleteCrop(cropId) {
            if (confirm('Are you sure you want to delete this crop?')) {
                userData.crops = userData.crops.filter(c => c.id !== cropId);
                userData.income = userData.income.filter(inc => inc.cropId !== cropId);
                saveUserData();
                loadDashboard();
                showSuccess('Crop deleted successfully!');
            }
        }

        function calculateWeightedInterestRate() {
            let totalAmount = 0;
            let weightedSum = 0;
            
            userData.funding.forEach(fund => {
                totalAmount += fund.amount;
                weightedSum += (fund.amount * fund.interestRate);
            });
            
            return totalAmount > 0 ? (weightedSum / totalAmount) : 0;
        }

        function calculateAnnualInterest() {
            const weightedRate = calculateWeightedInterestRate();
            const totalFunding = userData.funding.reduce((sum, fund) => sum + fund.amount, 0);
            return (totalFunding * weightedRate) / 100;
        }

        function loadDashboard() {
            // Calculate totals
            const totalIncome = userData.income.reduce((sum, inc) => sum + inc.amount, 0) +
                               userData.livestock.filter(l => ['sale', 'milk-sale', 'egg-sale', 'meat-sale', 'rental'].includes(l.type)).reduce((sum, l) => sum + l.amount, 0) +
                               userData.machinery.filter(m => ['sale', 'rental'].includes(m.type)).reduce((sum, m) => sum + m.amount, 0);
            
            const totalExpenses = userData.expenses.reduce((sum, exp) => sum + exp.amount, 0) +
                                  userData.livestock.filter(l => ['purchase', 'feed-cost', 'medical-cost'].includes(l.type)).reduce((sum, l) => sum + l.amount, 0) +
                                  userData.machinery.filter(m => ['purchase', 'maintenance'].includes(m.type)).reduce((sum, m) => sum + m.amount, 0);
            
            const annualInterest = calculateAnnualInterest();
            const netProfit = totalIncome - totalExpenses - annualInterest;
            
            // Update financial summary
            document.getElementById('totalIncome').textContent = `₹${totalIncome.toLocaleString()}`;
            document.getElementById('totalExpenses').textContent = `₹${totalExpenses.toLocaleString()}`;
            document.getElementById('netProfit').textContent = `₹${netProfit.toLocaleString()}`;
            document.getElementById('interestCost').textContent = `₹${annualInterest.toLocaleString()}`;
            
            // Color code profit/loss
            const profitElement = document.getElementById('netProfit');
            if (netProfit >= 0) {
                profitElement.style.color = 'var(--success)';
            } else {
                profitElement.style.color = 'var(--danger)';
            }
            
            // Load crops
            loadCropsList();
            
            // Load financial breakdown
            loadFinancialBreakdown();
            
            // Load secondary income
            loadSecondaryIncome();
        }

        function loadCropsList() {
            const cropsList = document.getElementById('cropsList');
            
            if (userData.crops.length === 0) {
                cropsList.innerHTML = '<p style="text-align: center; color: var(--gray); padding: 2rem;">No crops added yet. Click "Add Crop" to get started.</p>';
                return;
            }
            
            cropsList.innerHTML = userData.crops.map(crop => {
                const income = crop.yield * crop.sellingPrice;
                const profitColor = income >= 0 ? 'var(--success)' : 'var(--danger)';
                
                return `
                    <div class="crop-card">
                        <div class="crop-header">
                            <div>
                                <h4>${crop.type.charAt(0).toUpperCase() + crop.type.slice(1).replace('-', ' ')}</h4>
                                <p style="color: var(--gray);">${crop.acres} acres • ${crop.status}</p>
                            </div>
                            <div class="crop-actions">
                                <button class="btn btn-success btn-small" onclick="editCrop('${crop.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-small" onclick="deleteCrop('${crop.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div><strong>Expected</strong></div>
                                <div>${crop.expectedYield} Qt</div>
                            </div>
                            <div class="stat-item">
                                <div><strong>Actual Yield</strong></div>
                                <div>${crop.yield || 'TBD'} Qt</div>
                            </div>
                            <div class="stat-item">
                                <div><strong>Price/Qt</strong></div>
                                <div>₹${crop.sellingPrice || 'TBD'}</div>
                            </div>
                            <div class="stat-item">
                                <div><strong>Income</strong></div>
                                <div style="color: ${profitColor};">₹${income.toLocaleString()}</div>
                            </div>
                        </div>
                        ${crop.notes ? `<p style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; font-style: italic;">${crop.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function loadFinancialBreakdown() {
            const fundingBreakdown = document.getElementById('fundingBreakdown');
            const expenseBreakdown = document.getElementById('expenseBreakdown');
            const recentActivities = document.getElementById('recentActivities');
            
            // Funding breakdown
            const totalFunding = userData.funding.reduce((sum, fund) => sum + fund.amount, 0);
            const weightedRate = calculateWeightedInterestRate();
            
            fundingBreakdown.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <strong>Total Investment:</strong>
                        <strong>₹${totalFunding.toLocaleString()}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <strong>Weighted Interest Rate:</strong>
                        <strong>${weightedRate.toFixed(2)}%</strong>
                    </div>
                </div>
                ${userData.funding.map(fund => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                        <div>
                            <div>${fund.type.charAt(0).toUpperCase() + fund.type.slice(1)}</div>
                            <small style="color: var(--gray);">${fund.date}</small>
                        </div>
                        <div style="text-align: right;">
                            <div>₹${fund.amount.toLocaleString()}</div>
                            <small style="color: var(--warning);">${fund.interestRate}% interest</small>
                        </div>
                    </div>
                `).join('')}
            `;
            
            // Expense breakdown
            const expensesByCategory = userData.expenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});
            
            expenseBreakdown.innerHTML = Object.entries(expensesByCategory).map(([category, amount]) => `
                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #f0f0f0;">
                    <div>${category.charAt(0).toUpperCase() + category.slice(1)}</div>
                    <div><strong>₹${amount.toLocaleString()}</strong></div>
                </div>
            `).join('') || '<p style="color: var(--gray); text-align: center;">No expenses recorded yet.</p>';
            
            // Recent activities
            const activities = [
                ...userData.expenses.map(expense => ({
                    type: 'expense',
                    icon: 'fas fa-minus-circle',
                    text: `${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)} expense`,
                    amount: expense.amount,
                    date: expense.date,
                    color: 'var(--danger)'
                })),
                ...userData.income.map(income => ({
                    type: 'income',
                    icon: 'fas fa-plus-circle',
                    text: 'Crop sale income',
                    amount: income.amount,
                    date: income.date,
                    color: 'var(--success)'
                })),
                ...userData.machinery.map(machinery => ({
                    type: machinery.type,
                    icon: 'fas fa-tractor',
                    text: `Machinery ${machinery.type}: ${machinery.name}`,
                    amount: machinery.amount,
                    date: machinery.date,
                    color: machinery.type === 'sale' || machinery.type === 'rental' ? 'var(--success)' : 'var(--danger)'
                })),
                ...userData.livestock.map(livestock => ({
                    type: livestock.type,
                    icon: 'fas fa-paw',
                    text: `${livestock.type.replace('-', ' ').charAt(0).toUpperCase() + livestock.type.replace('-', ' ').slice(1)}: ${livestock.name}`,
                    amount: livestock.amount,
                    date: livestock.date,
                    color: ['sale', 'milk-sale', 'egg-sale', 'meat-sale'].includes(livestock.type) ? 'var(--success)' : 'var(--danger)'
                }))
            ];
            
            activities.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            recentActivities.innerHTML = activities.slice(0, 10).map(activity => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="${activity.icon}" style="color: ${activity.color};"></i>
                        <div>
                            <div>${activity.text}</div>
                            <small style="color: var(--gray);">${activity.date}</small>
                        </div>
                    </div>
                    <div style="color: ${activity.color}; font-weight: 600;">₹${activity.amount.toLocaleString()}</div>
                </div>
            `).join('') || '<p style="color: var(--gray); text-align: center;">No recent activities.</p>';
        }

        function loadSecondaryIncome() {
            const machineryList = document.getElementById('machineryList');
            const livestockList = document.getElementById('livestockList');
            
            // Load machinery
            if (userData.machinery.length === 0) {
                machineryList.innerHTML = '<p style="color: var(--gray); padding: 1rem; text-align: center;">No machinery transactions recorded.</p>';
            } else {
                machineryList.innerHTML = userData.machinery.map(machinery => `
                    <div class="secondary-income-item">
                        <div>
                            <div><strong>${machinery.name.charAt(0).toUpperCase() + machinery.name.slice(1)}</strong></div>
                            <small>${machinery.type.charAt(0).toUpperCase() + machinery.type.slice(1)} • ${machinery.date}</small>
                        </div>
                        <div style="color: ${['sale', 'rental'].includes(machinery.type) ? 'var(--success)' : 'var(--danger)'};">
                            ₹${machinery.amount.toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
            
            // Load livestock
            if (userData.livestock.length === 0) {
                livestockList.innerHTML = '<p style="color: var(--gray); padding: 1rem; text-align: center;">No livestock transactions recorded.</p>';
            } else {
                livestockList.innerHTML = userData.livestock.map(livestock => `
                    <div class="secondary-income-item">
                        <div>
                            <div><strong>${livestock.name.charAt(0).toUpperCase() + livestock.name.slice(1)}</strong></div>
                            <small>${livestock.type.replace('-', ' ').charAt(0).toUpperCase() + livestock.type.replace('-', ' ').slice(1)} • ${livestock.date}</small>
                            ${livestock.notes ? `<div style="font-size: 0.8rem; color: var(--gray);">${livestock.notes}</div>` : ''}
                        </div>
                        <div style="color: ${['sale', 'milk-sale', 'egg-sale', 'meat-sale'].includes(livestock.type) ? 'var(--success)' : 'var(--danger)'};">
                            ₹${livestock.amount.toLocaleString()}
                        </div>
                    </div>
                `).join('');
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Reset to step 1
                changeStep(step5, step1);
                
                // Reset all forms
                document.getElementById('phoneNumber').value = '';
                otpInputs.forEach(input => input.value = '');
                document.getElementById('firstName').value = '';
                document.getElementById('lastName').value = '';
                document.getElementById('acres').value = '';
                document.getElementById('sowingDate').value = '';
                document.getElementById('durationSlider').value = 120;
                durationValue.textContent = '120';
                cropItems.forEach(item => item.classList.remove('selected'));
                expenseItems.forEach(item => item.classList.remove('selected'));
                expenseList.innerHTML = '';
                expenseDetails.style.display = 'none';
                
                // Remove all added funding sources except the first one
                const fundingElements = document.querySelectorAll('.funding-source');
                for (let i = 1; i < fundingElements.length; i++) {
                    fundingElements[i].remove();
                }
                
                showSuccess('Logged out successfully!');
            }
        }

        // Initialize date pickers for existing elements
        flatpickr('.funding-date', {
            dateFormat: "Y-m-d",
            maxDate: "today"
        });

        flatpickr('#expenseDate', {
            dateFormat: "Y-m-d",
            maxDate: "today"
        });

        // Set up initial funding type event
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('funding-type')) {
                const rateInput = e.target.closest('.funding-source').querySelector('.funding-rate');
                if (e.target.value === 'own' || e.target.value === 'govt') {
                    rateInput.value = 0;
                    rateInput.disabled = true;
                } else {
                    rateInput.disabled = false;
                }
            }
        });

        // Auto-load dashboard if user data exists
        window.addEventListener('load', function() {
            const savedData = localStorage.getItem('farmpro_userData');
            if (savedData) {
                userData = JSON.parse(savedData);
                if (userData.profile && userData.profile.firstName) {
                    changeStep(step1, step5);
                    loadDashboard();
                }
            }
        });
    </script>
</body>
</html>
